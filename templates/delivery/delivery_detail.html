{# 
  æ¨¡æ¿åŠŸèƒ½ï¼šå‘è´§å•è¯¦æƒ…é¡µ
  ç»§æ‰¿ï¼šdelivery/base.html æä¾›çš„åŸºç¡€å¸ƒå±€
#}
{% extends 'delivery/base.html' %}
{% block title %}å‘è´§è¯¦æƒ…{% endblock %}

{% block head_extra %}
{# ===== é¡µé¢æ ·å¼å®šä¹‰ ===== #}
<style>
  /* å‘è´§è¯¦æƒ…å¡ç‰‡æ ·å¼ */
  .card-detail {
    border-radius: 14px;
    background: linear-gradient(180deg, #ffffff, #f9fbff);
    box-shadow: 0 6px 20px rgba(34, 34, 34, 0.04);
    padding: 24px;
    margin-top: 1rem;
  }

  .card-detail h3 {
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  /* å‘è´§å…ƒä¿¡æ¯æ ·å¼ */
  .delivery-meta {
    font-size: 0.95rem;
    color: #556;
    margin-bottom: 0.5rem;
  }

  .delivery-meta .badge {
    font-size: 0.85rem;
    padding: 0.4em 0.6em;
  }

  /* å¤‡æ³¨åŒºåŸŸæ ·å¼ */
  .delivery-remarks {
    background-color: #f8fbff;
    border-left: 4px solid var(--brand-1);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.95rem;
    color: #223;
    margin-bottom: 1rem;
  }

  /* è¡¨æ ¼æ ·å¼ */
  .table th {
    background-color: #f1f6ff;
    font-weight: 600;
    color: #334;
    border-bottom: 1px solid rgba(34, 34, 34, 0.08);
  }

  .table td {
    vertical-align: middle;
  }

  .table tbody tr:nth-child(odd) {
    background-color: #fcfcfe;
  }

  .table tfoot td {
    background-color: #f7faff;
    font-weight: 600;
  }

  .btn-toolbar a {
    margin-right: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
{# ===== é¡µé¢æ ‡é¢˜ ===== #}
<div class="form-title-container">
  <h1 class="form-title">
    ğŸ§¾ å‘è´§å• #{{ delivery.delivery_note_id }}
  </h1>
</div>

{# ===== å‘è´§è¯¦æƒ…å¡ç‰‡ ===== #}
<div class="card-detail">
  {# ===== é¡¶éƒ¨æ“ä½œæŒ‰é’®åŒºåŸŸï¼Œæ ¹æ®å‘è´§çŠ¶æ€æ˜¾ç¤ºä¸åŒæ“ä½œ ===== #}
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="btn-toolbar">
      {% if delivery.status == 'å·²åˆ›å»º' %}
        <!-- ç¼–è¾‘ã€æŸ¥çœ‹æ‹£è´§ä»»åŠ¡ã€å–æ¶ˆå‘è´§å• -->
        <a href="{{ url_for('delivery.edit_delivery', delivery_id=delivery.delivery_note_id) }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-pencil"></i>ç¼–è¾‘å‘è´§å•</a>
        <a href="{{ url_for('delivery.picking_task_detail', task_id=delivery.picking_task_id) }}" class="btn btn-warning btn-sm"><i class="bi bi-box-seam"></i> æ‹£è´§ä»»åŠ¡è¯¦æƒ…</a>
        <a href="{{ url_for('delivery.cancel_delivery', delivery_id=delivery.delivery_note_id) }}" class="btn btn-outline-danger btn-sm"><i class="bi bi-x-circle"></i>å–æ¶ˆå‘è´§å•</a>

      {% elif delivery.status == 'å·²æ‹£è´§' %}
        <!-- å‡†å¤‡å‘è´§ã€å–æ¶ˆ -->
        <form action="{{ url_for('delivery.shipment', delivery_id=delivery.delivery_note_id) }}" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-box-arrow-up"></i> å‡†å¤‡å‘è´§</button>
        </form>
        <a href="{{ url_for('delivery.cancel_delivery', delivery_id=delivery.delivery_note_id) }}" class="btn btn-outline-danger btn-sm"><i class="bi bi-x-circle"></i> å–æ¶ˆ</a>

      {% elif delivery.status == 'å·²å‘è´§' %}
        <!-- å‘è´§å®Œæˆåå¯è¿›è¡Œè¿‡è´¦ -->
        <a href="{{ url_for('delivery.post_delivery', delivery_id=delivery.delivery_note_id) }}" class="btn btn-success btn-sm">
          <i class="bi bi-check2-circle"></i> è¿‡è´¦
        </a>
      {% endif %}
    </div>
  </div>

  {# ===== å‘è´§å…ƒä¿¡æ¯å±•ç¤º ===== #}
  <div class="delivery-meta">
    <span><i class="bi bi-file-earmark-text"></i> é”€å”®è®¢å•ï¼š<strong>{{ delivery.sales_order_id }}</strong></span> |
    <span><i class="bi bi-geo-alt"></i> ä»“åº“ï¼š{{ delivery.warehouse_code }}</span> |
    <span><i class="bi bi-calendar"></i> å‘è´§æ—¥æœŸï¼š{{ delivery.delivery_date.strftime('%Y-%m-%d') }}</span> |
    <span>çŠ¶æ€ï¼š
      {# çŠ¶æ€å¾½ç« æ ·å¼æ ¹æ®çŠ¶æ€ä¸åŒè€Œå˜åŒ– #}
      {% if delivery.status == 'å·²è¿‡è´¦' or delivery.status == 'å·²å®Œæˆ' %}
        <span class="badge bg-success">{{ delivery.status }}</span>
      {% elif delivery.status == 'å·²åˆ›å»º' %}
        <span class="badge bg-primary">å·²åˆ›å»º</span>
      {% elif delivery.status == 'å¾…æ‹£è´§' %}
        <span class="badge bg-info">å¾…æ‹£è´§</span>
      {% elif delivery.status == 'å·²æ‹£è´§' %}
        <span class="badge bg-warning">å·²æ‹£è´§</span>
      {% elif delivery.status == 'å¾…å‘è´§' %}
        <span class="badge bg-info">å¾…å‘è´§</span>
      {% elif delivery.status == 'å·²å‘è´§' %}
        <span class="badge bg-primary">å·²å‘è´§</span>
      {% elif delivery.status == 'å·²å–æ¶ˆ' %}
        <span class="badge bg-secondary">å·²å–æ¶ˆ</span>
      {% else %}
        <span class="badge bg-secondary">{{ delivery.status }}</span>
      {% endif %}
    </span>
  </div>

  {# ===== å¤‡æ³¨ä¿¡æ¯å±•ç¤º ===== #}
  <div class="delivery-remarks">
    <i class="bi bi-chat-dots"></i> {{ delivery.remarks or 'æ— å¤‡æ³¨ä¿¡æ¯' }}
  </div>

  {# ===== å‘è´§è¡Œé¡¹ç›®è¡¨æ ¼ ===== #}
  <div class="table-responsive">
    <table class="table table-sm table-bordered">
      <thead>
        <tr>
          <th style="width:80px">è¡Œå·</th>
          <th style="min-width:140px">ç‰©æ–™ç¼–å·</th>
          <th style="min-width:200px">ç‰©æ–™æè¿°</th>
          <th style="width:120px">åº“å­˜ä½ç½®</th>
          <th style="width:120px" class="text-end">è®¡åˆ’å‘è´§</th>
          <th style="width:120px" class="text-end">å®é™…å‘è´§</th>
          <th style="width:90px">å•ä½</th>
        </tr>
      </thead>
      <tbody>
        {% for l in delivery.items %}
        {% set material = l.material %}
        <tr>
          <!-- è¡Œé¡¹ç›®åŸºæœ¬ä¿¡æ¯ -->
          <td>{{ l.item_no }}</td>
          <td>{{ l.material_id }}</td>
          <td>{{ material.description if material else '' }}</td>
          <td>{{ material.storage_location if material else 'æœªçŸ¥' }}</td>
          <td class="text-end">{{ "%.2f"|format(l.planned_delivery_quantity or 0) }}</td>
          <td class="text-end">{{ "%.2f"|format(l.actual_delivery_quantity or 0) }}</td>
          <td>{{ material.base_unit if material else l.unit }}</td>
        </tr>
        {% if material %}
        <!-- é™„åŠ åº“å­˜ä¿¡æ¯å±•ç¤ºè¡Œ -->
        <tr>
          <td colspan="7" style="padding: 0.3rem 1rem; background-color: #f8f9fa;">
            <div class="d-flex justify-content-between">
              <small>å¯ç”¨åº“å­˜: {{ "%.2f"|format(material.available_stock or 0) }}</small>
              <small>å®é™…åº“å­˜: {{ "%.2f"|format(material.physical_stock or 0) }}</small>
              <small>å¾…å‡ºåº“é‡: {{ "%.2f"|format(material.pending_outbound or 0) }}</small>
            </div>
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
