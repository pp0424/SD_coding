{% extends "delivery/base.html" %}

{% block content %}

<div class="form-title-container">
  <h1 class="form-title">✅ 执行拣货任务: {{ task.task_id }}</h1>
</div>

<div class="container mt-4">
  <div class="d-flex justify-content-between mb-3">
    <a href="{{ url_for('delivery.picking_task_detail', task_id=task.task_id) }}" class="btn btn-outline-secondary">返回任务</a>
    <div>
      <button id="startPickingBtn" class="btn btn-success">开始拣货</button>
    </div>
  </div>

  <div id="alertZone"></div>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light"><h5 class="mb-0">任务与发货单信息</h5></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>任务号:</strong> {{ task.task_id }}</p>
          <p><strong>销售订单:</strong> {{ task.sales_order_id }}</p>
          <p><strong>仓库:</strong> {{ task.warehouse_code }}</p>
        </div>
        <div class="col-md-6">
          <p><strong>发货单:</strong>
            <a href="{{ url_for('delivery.picking_task_detail', task_id=task.task_id) }}">{{ task.task_id }}</a>
          </p>
          <p><strong>任务状态:</strong> {{ task.status }}</p>
        </div>
      </div>
    </div>
  </div>

  <form id="pickingForm" onsubmit="return false;">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light"><h5 class="mb-0">拣货明细</h5></div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>行号</th>
                <th>物料编号</th>
                <th>描述</th>
                <th>需求数量</th>
                <th>已拣数量</th>
                <th>本次拣货数量</th>
                <th>储位</th>
              </tr>
            </thead>
            <tbody>
              {% for item in task.items %}
              <tr>
                <td>{{ item.item_no }}</td>
                <td>{{ item.material_id }}</td>
                <td>{{ item.material.description if item.material else '-' }}</td>
                <td>{{ "%.2f"|format(item.required_quantity or 0) }}</td>
                <td>{{ "%.2f"|format(item.picked_quantity or 0) }}</td>
                <td>
                  <input type="number" step="0.01" min="0" class="form-control form-control-sm picked-qty"
                         data-item-no="{{ item.item_no }}" placeholder="输入数量" />
                </td>
                <td>
                  <input type="text" class="form-control form-control-sm storage-loc"
                         data-item-no="{{ item.item_no }}" value="{{ item.storage_location or '' }}" placeholder="储位 (可选)" />
                </td>
              </tr>
              {% else %}
              <tr><td colspan="7" class="text-center">暂无明细</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end mt-3 gap-2">
          <button id="submitPickingBtn" class="btn btn-primary">确认拣货</button>
          <a href="{{ url_for('delivery.picking_task_detail', task_id=task.task_id) }}" class="btn btn-outline-secondary">取消</a>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
const startApiUrl = "{{ url_for('delivery.api_start_picking', task_id=task.task_id) }}";
const confirmApiUrl = "{{ url_for('delivery.confirm_picking', delivery_id=delivery.delivery_note_id) }}";
const backDetailUrl = "{{ url_for('delivery.picking_task_detail', task_id=task.task_id) }}";

function showAlert(message, type='info') {
  const zone = document.getElementById('alertZone');
  zone.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                      ${message}
                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
}

// 记录开始时间
document.getElementById('startPickingBtn').addEventListener('click', async function () {
  try {
    this.disabled = true;
    this.textContent = '正在开始...';
    const resp = await fetch(startApiUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({})
    });
    if (!resp.ok) {
      const txt = await resp.text();
      showAlert('启动拣货失败: ' + txt, 'danger');
      this.disabled = false;
      this.textContent = '开始拣货';
      return;
    }
    const data = await resp.json().catch(()=>null);
    showAlert('已记录开始时间，开始拣货吧！', 'success');
    this.textContent = '已开始';
  } catch (err) {
    showAlert('网络错误: ' + err, 'danger');
    this.disabled = false;
    this.textContent = '开始拣货';
  }
});

// 提交拣货
document.getElementById('submitPickingBtn').addEventListener('click', async function () {
  const rows = Array.from(document.querySelectorAll('.picked-qty'));
  const tasks = [];

  for (const el of rows) {
    const item_no = el.dataset.itemNo;
    const val = el.value.trim();
    if (!val || Number(val) <= 0) continue;
    const storageEl = document.querySelector(`.storage-loc[data-item-no="${item_no}"]`);
    tasks.push({
      task_id: "{{ task.task_id }}",
      item_no: Number(item_no),
      picked_quantity: Number(val),
      storage_location: storageEl ? storageEl.value.trim() : null
    });
  }

  if (tasks.length === 0) {
    showAlert('请至少输入一行本次拣货数量（> 0）', 'warning');
    return;
  }

  try {
    this.disabled = true;
    this.textContent = '提交中...';
    const resp = await fetch(confirmApiUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ tasks })
    });

    if (!resp.ok) {
      const txt = await resp.text();
      showAlert('提交失败: ' + txt, 'danger');
      this.disabled = false;
      this.textContent = '确认拣货并提交';
      return;
    }

    // 跳回发货单拣货详情页（确保刷新）
    window.location.href = backDetailUrl;
  } catch (err) {
    showAlert('网络错误: ' + err, 'danger');
    this.disabled = false;
    this.textContent = '确认拣货并提交';
  }
});
</script>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'danger' if category=='danger' else 'success' }}" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% endblock %}
