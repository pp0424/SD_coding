{% extends 'delivery/base.html' %}
{% block title %}å‘è´§å•åˆ—è¡¨{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='delivery/delivery_styles.css') }}">
<style>
  /* --------------------------- æ ·å¼ï¼šè¡¨æ ¼ä¸å¡ç‰‡ --------------------------- */
  /* è¡¨æ ¼æ‰€æœ‰å•å…ƒæ ¼ä¸æ¢è¡Œï¼Œä¿æŒæ¯è¡Œä¸€è¡Œæ˜¾ç¤ºï¼Œé¿å…è‡ªåŠ¨æ¢è¡Œå¯¼è‡´é«˜åº¦ä¸ä¸€è‡´ */
  .delivery-table th,
  .delivery-table td {
    white-space: nowrap;
    vertical-align: middle; /* å‚ç›´å±…ä¸­å¯¹é½å•å…ƒæ ¼å†…å®¹ */
  }

  /* å®¹å™¨å¡ç‰‡å®½åº¦è®¾ç½®ä¸º100%ï¼Œç¡®ä¿åœ¨å“åº”å¼å¸ƒå±€ä¸­å æ»¡çˆ¶å®¹å™¨ */
  .delivery-card {
    width: 100%;
  }

  /* --------------------------- é€šç”¨ç¦ç”¨æŒ‰é’®æ ·å¼ --------------------------- */
  /* ç¦ç”¨æ€ï¼šä¸å¯ç‚¹å‡»ä¸”è§†è§‰ä¸Šå¼±åŒ–ï¼Œé€‚ç”¨äº a.btnã€button ç­‰ */
  .btn.disabled,
  .btn[aria-disabled="true"],
  .btn:disabled {
    pointer-events: none; /* ç¦æ­¢ç‚¹å‡» */
    opacity: .65;         /* é€æ˜åº¦å¼±åŒ– */
  }

  /* è¿›ä¸€æ­¥å¼ºåŒ–ç¦ç”¨æ ·å¼ï¼Œä¿è¯é¢œè‰²/è¾¹æ¡†ä¹Ÿè¡¨ç°ä¸ºç°è‰² */
  .btn.disabled,
  .btn[aria-disabled="true"],
  .btn:disabled {
      pointer-events: none;   /* ç¦æ­¢ç‚¹å‡» */
      opacity: 0.5;           /* åŠé€æ˜æ•ˆæœ */
      background-color: #e0e0e0 !important; /* ç°åº• */
      color: #888 !important; /* ç°å­— */
      border-color: #ccc !important; /* ç°è¾¹æ¡† */
  }

</style>
{% endblock %}

{% block content %}
<!-- --------------------------- æœç´¢æ¨¡æ€æ¡†ï¼šå¤ç”¨åœ¨å¤šå¤„çš„â€œé€‰æ‹©è®°å½•â€å¼¹çª— --------------------------- -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <!-- å¼¹çª—æ ‡é¢˜ -->
        <h5 class="modal-title">é€‰æ‹©è®°å½•</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- æœç´¢è¾“å…¥ï¼šå®æ—¶ oninput è§¦å‘ doSearch() -->
        <input type="text" id="searchKeyword" class="form-control mb-3" placeholder="è¾“å…¥å…³é”®å­—æœç´¢..." oninput="doSearch()">
        <div id="searchResults">
          <!-- AJAX æŸ¥è¯¢ç»“æœå°†æ³¨å…¥åˆ°è¿™é‡Œ -->
        </div>
      </div>
    </div>
  </div>
</div>


<!-- --------------------------- æŸ¥è¯¢è¡¨å•ï¼šé¡¶éƒ¨æŸ¥è¯¢æ¡ä»¶åŒºåŸŸ --------------------------- -->
<div class="form-title-container">
  <h1 class="form-title">ğŸ” å‘è´§å•æŸ¥è¯¢</h1>
</div>

<div class="delivery-card animate-fade">
  <!-- ä½¿ç”¨ POST æäº¤æŸ¥è¯¢è¡¨å•ï¼ˆåç«¯è§†å›¾å¤„ç†ï¼‰ -->
  <form method="post" class="row g-3 query-form align-items-end">
    {{ form.csrf_token }}  {# CSRF ä»¤ç‰Œï¼šé˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€  #}

  <div class="col-md-2">
      <label class="form-label" for="delivery_id">{{ form.delivery_id.label.text }}</label>
      <div class="input-group">
        <!-- å‘è´§å•å·è¾“å…¥æ¡†ï¼ˆç”± WTForms æ¸²æŸ“ï¼‰ -->
        {{ form.delivery_id(class="form-control", id="delivery_id") }}
        <!-- è¾…åŠ©æŒ‰é’®ï¼šæ‰“å¼€å¼¹çª—å¿«é€Ÿé€‰æ‹©å‘è´§å•ï¼ˆå±…ä¸­å¼¹çª—ï¼‰ -->
        <button type="button" class="btn btn-outline-secondary"
                onclick="openCentered('{{ url_for('delivery.delivery_helper') }}', 'deliveryHelper', 800, 600)">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>

    <!-- é”€å”®è®¢å• IDï¼ˆç±»ä¼¼å‘è´§å•çš„é€‰æ‹©å™¨ï¼‰ -->
    <div class="col-md-2">
      <label class="form-label" for="sales_order_id">{{ form.sales_order_id.label.text }}</label>
      <div class="input-group">
        {{ form.sales_order_id(class="form-control", id="sales_order_id") }}
        <button type="button" class="btn btn-outline-secondary"
                onclick="openCentered('{{ url_for('delivery.sales_helper') }}', 'salesHelper', 800, 600)">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>


 <div class="col-md-2">
      <!-- çŠ¶æ€ä¸‹æ‹‰æ¡†ï¼ˆWTForms æ¸²æŸ“ï¼‰ -->
      {{ form.status.label(class="form-label") }}
      {{ form.status(class="form-select") }}
    </div>

    <div class="col-md-2">
      <!-- èµ·å§‹æ—¥æœŸï¼ˆtype=dateï¼Œæµè§ˆå™¨ä¼šä½¿ç”¨æœ¬åœ°æ—¥æœŸé€‰æ‹©å™¨ï¼‰ -->
      {{ form.start_date.label(class="form-label") }}
      {{ form.start_date(class="form-control", type="date") }}
    </div>

    <div class="col-md-2">
      <!-- ç»“æŸæ—¥æœŸ -->
      {{ form.end_date.label(class="form-label") }}
      {{ form.end_date(class="form-control", type="date") }}
    </div>

    <div class="col-md-2">
      <!-- æŸ¥è¯¢æŒ‰é’®ï¼ˆWTForms æ¸²æŸ“çš„ submitï¼‰ -->
      {{ form.submit(class="btn btn-search w-100") }}
    </div>
  </form>
</div>

<!-- --------------------------- æŸ¥è¯¢ç»“æœï¼šè¡¨æ ¼å±•ç¤ºå‘è´§å•åˆ—è¡¨ --------------------------- -->
<div class="delivery-card animate-fade">
  <div class="card-header">
    <div class="toolbar">
      <div>
        <i class="bi bi-list-ul me-2"></i>
        <strong>å‘è´§å•åˆ—è¡¨</strong>
        <!-- å±•ç¤ºå½“å‰æŸ¥è¯¢åˆ°çš„è®°å½•æ•°ï¼ˆdeliveries æ˜¯åç«¯ä¼ å…¥çš„åˆ—è¡¨ï¼‰ -->
        <span class="stats-info ms-3">å…±æ‰¾åˆ° {{ deliveries|length }} æ¡è®°å½•</span>
      </div>
      <div>
        <!-- æ–°å»ºå‘è´§å•æŒ‰é’® -->
        <a href="{{ url_for('delivery.create_delivery') }}" class="btn btn-primary btn-sm">
          <i class="bi bi-plus-circle me-1"></i> æ–°å»ºå‘è´§å•
        </a>
        <!-- æ‰“å°æŒ‰é’®ï¼ˆä½¿ç”¨è‡ªå®šä¹‰çš„ printTable()ï¼‰ -->
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print()">
          <i class="bi bi-printer me-1"></i> æ‰“å°
        </button>
      </div>
    </div>
  </div>

  <!-- å¯æ»šåŠ¨çš„è¡¨æ ¼å®¹å™¨ï¼Œé™åˆ¶æœ€å¤§é«˜åº¦ä»¥æ”¯æŒé•¿åˆ—è¡¨æ—¶çš„æ»šåŠ¨ -->
  <div class="table-responsive" style="max-height: 70vh;">
    <table class="delivery-table table-hover">
      <thead>
        <tr>
          <th>å‘è´§å•å·</th>
          <th>é”€å”®è®¢å•å·</th>
          <th>å‘è´§æ—¥æœŸ</th>
          <th style="width: 8%;">ä»“åº“ä»£ç </th>
          <th>çŠ¶æ€</th>
          <th>æ“ä½œ</th>
          <th>å¤‡æ³¨</th>
        </tr>
      </thead>
      <tbody>
        {# éå† deliveries åˆ—è¡¨å¹¶æ¸²æŸ“æ¯ä¸€è¡Œ #}
        {% for delivery in deliveries %}
          {# åˆ¤æ–­è¯¥è¡Œæ˜¯å¦ä¸ºæ‹£è´§å·²å–æ¶ˆçš„çŠ¶æ€ï¼ˆç”¨äºç¦ç”¨æŸäº›æ“ä½œï¼‰ #}
          {% set picking_cancelled = (delivery.picking_status == 'å·²å–æ¶ˆ') %}
          {# åªæœ‰åœ¨ "å·²åˆ›å»º" ä¸”æ‹£è´§æœªå–æ¶ˆæ—¶å…è®¸ç¼–è¾‘/æ‹£è´§ #}
          {% set can_edit = (delivery.status == 'å·²åˆ›å»º') and (not picking_cancelled) %}
          {% set can_pick = (delivery.status == 'å·²åˆ›å»º') and (not picking_cancelled) %}

          <tr>
            <td>
              <!-- å‘è´§å•è¯¦æƒ…é“¾æ¥ï¼šç‚¹å‡»è·³è½¬åˆ°è¯¦æƒ…é¡µ -->
              <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}"
                 class="text-decoration-none fw-bold text-primary">
                {{ delivery.delivery_note_id }}
              </a>
            </td>
            <td><span class="text-muted">{{ delivery.sales_order_id }}</span></td>
            <td>{{ delivery.delivery_date.strftime('%Y-%m-%d') if delivery.delivery_date else '-' }}</td>
            <td><span class="badge bg-light text-dark">{{ delivery.warehouse_code }}</span></td>
            <td>
              <!-- æ ¹æ®ä¸åŒçŠ¶æ€ä½¿ç”¨ä¸åŒçš„ badge æ ·å¼ï¼Œä¿æŒè§†è§‰ä¸€è‡´æ€§ -->
              <span class="badge 
                {% if delivery.status == 'å·²åˆ›å»º' %}bg-primary
                {% elif delivery.status == 'å·²æ‹£è´§' %}bg-warning
                {% elif delivery.status == 'å·²å‘è´§' %}bg-primary
                {% elif delivery.status == 'å·²è¿‡è´¦' %}bg-success
                {% elif delivery.status == 'å·²å®Œæˆ' %}bg-light text-dark
                {% elif delivery.status == 'å·²å–æ¶ˆ' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ delivery.status }}
              </span>
            </td>

            <td>
              <div class="d-flex flex-wrap gap-1">

                <!-- æŸ¥çœ‹ï¼šè¯¦æƒ…é¡µçš„å¿«æ·å…¥å£ï¼ˆå§‹ç»ˆå¯ç”¨ï¼‰ -->
                <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}"
                   class="btn btn-outline-info btn-action" title="æŸ¥çœ‹è¯¦æƒ…">
                  <i class="bi bi-eye"></i>
                </a>

                <!-- ç¼–è¾‘ï¼ˆä»…â€œå·²åˆ›å»ºâ€ä¸”æ‹£è´§å•æœªå–æ¶ˆæ—¶å¯ç”¨ï¼‰ -->
                <a href="{{ url_for('delivery.edit_delivery', delivery_id=delivery.delivery_note_id) }}"
                   class="btn btn-outline-warning btn-action {% if not can_edit %}disabled{% endif %}"
                   title="{% if not can_edit %}{% if picking_cancelled %}æ‹£è´§å•å·²å–æ¶ˆï¼Œç¦æ­¢ä¿®æ”¹{% else %}ä»…â€œå·²åˆ›å»ºâ€å¯ç¼–è¾‘{% endif %}{% else %}ç¼–è¾‘{% endif %}"
                   {% if not can_edit %}aria-disabled="true" tabindex="-1"{% endif %}>
                  <i class="bi bi-pencil"></i>
                </a>

                <!-- æ‹£è´§ï¼ˆä»…â€œå·²åˆ›å»ºâ€ä¸”æ‹£è´§å•æœªå–æ¶ˆæ—¶å¯ç”¨ï¼‰ -->
                <a href="{{ url_for('delivery.picking_task_detail', task_id=delivery.picking_task_id) }}"
                   class="btn btn-outline-warning btn-action {% if not can_pick %}disabled{% endif %}"
                   title="{% if not can_pick %}{% if picking_cancelled %}æ‹£è´§å•å·²å–æ¶ˆï¼Œç¦æ­¢æ‹£è´§{% else %}ä»…â€œå·²åˆ›å»ºâ€å¯æ‹£è´§{% endif %}{% else %}æ‹£è´§{% endif %}"
                   {% if not can_pick %}aria-disabled="true" tabindex="-1"{% endif %}>
                  <i class="bi bi-box-seam"></i>
                </a>

                <!-- å‘è´§ï¼ˆä¿æŒåŸé€»è¾‘ï¼šåªæœ‰çŠ¶æ€ä¸ºâ€œå·²æ‹£è´§â€æ‰èƒ½å‘è´§ï¼‰ -->
                <form action="{{ url_for('delivery.shipment', delivery_id=delivery.delivery_note_id) }}" method="POST" style="display: inline;">
                  <button type="submit"
                          class="btn btn-outline-primary btn-action {% if delivery.status != 'å·²æ‹£è´§' %}disabled{% endif %}"
                          title="å‘è´§" {% if delivery.status != 'å·²æ‹£è´§' %}disabled{% endif %}>
                    <i class="bi bi-box-arrow-up"></i>
                  </button>
                </form>

                <!-- è¿‡è´¦ï¼ˆå·²å‘è´§åå¯è¿‡è´¦ï¼‰ -->
                <a href="{{ url_for('delivery.post_delivery', delivery_id=delivery.delivery_note_id) }}"
                   class="btn btn-outline-primary btn-action {% if delivery.status != 'å·²å‘è´§' %}disabled{% endif %}"
                   title="è¿‡è´¦" {% if delivery.status != 'å·²å‘è´§' %}aria-disabled="true" tabindex="-1"{% endif %}>
                  <i class="bi bi-check2-circle"></i>
                </a>

                <!-- å–æ¶ˆï¼ˆä»…åœ¨å·²åˆ›å»ºæˆ–å·²æ‹£è´§é˜¶æ®µå…è®¸å–æ¶ˆï¼‰ -->
                <a href="{{ url_for('delivery.cancel_delivery', delivery_id=delivery.delivery_note_id) }}"
                   class="btn btn-outline-danger btn-action {% if delivery.status not in ['å·²åˆ›å»º', 'å·²æ‹£è´§'] %}disabled{% endif %}"
                   title="å–æ¶ˆ" {% if delivery.status not in ['å·²åˆ›å»º', 'å·²æ‹£è´§'] %}aria-disabled="true" tabindex="-1"{% endif %}>
                  <i class="bi bi-x-circle"></i>
                </a>
              </div>
            </td>

            <td>
              <!-- å¤‡æ³¨å­—æ®µï¼šè¶…è¿‡ 30 å­—æ˜¾ç¤ºçœç•¥å¹¶åŠ çœç•¥å·ï¼Œé¿å…è¿‡é•¿æ–‡æœ¬ç ´åè¡¨æ ¼å¸ƒå±€ -->
              <small class="text-muted">
                {{ delivery.remarks[:30] + '...' if delivery.remarks and delivery.remarks|length > 30 else (delivery.remarks or '-') }}
              </small>
            </td>
          </tr>
        {% else %}
          <!-- ç©ºçŠ¶æ€ï¼šå½“ deliveries ä¸ºç©ºæ—¶æ˜¾ç¤ºæç¤ºä¿¡æ¯ -->
          <tr>
            <td colspan="9" class="empty-state">
              <i class="bi bi-inbox display-4 d-block mb-2"></i>
              <h5 class="mb-2">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å‘è´§å•è®°å½•</h5>
              <p class="text-muted mb-0">è¯·è°ƒæ•´æŸ¥è¯¢æ¡ä»¶æˆ–
                <a href="{{ url_for('delivery.create_delivery') }}" class="text-decoration-none">åˆ›å»ºæ–°çš„å‘è´§å•</a>
              </p>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if deliveries %}
  <div class="card-footer bg-light">
    <div class="d-flex justify-content-between align-items-center">
      <div class="stats-info">
        æ˜¾ç¤º {{ deliveries|length }} æ¡è®°å½•
        {# æ±‡æ€»å„çŠ¶æ€çš„æ•°é‡ï¼ˆç”¨äºåœ¨åº•éƒ¨æ˜¾ç¤ºæ¯ä¸ªçŠ¶æ€å‡ºç°çš„æ¬¡æ•°ï¼‰ #}
        {% set status_counts = {} %}
        {% for delivery in deliveries %}
          {% set _ = status_counts.update({delivery.status: status_counts.get(delivery.status, 0) + 1}) %}
        {% endfor %}
        {% if status_counts %}
        <span class="ms-3">
          {% for status, count in status_counts.items() %}
            <span class="badge bg-secondary me-1">{{ status }}: {{ count }}</span>
          {% endfor %}
        </span>
        {% endif %}
      </div>
      <div>
        <small class="text-muted">
          <!-- ä½¿ç”¨ moment() æ˜¾ç¤ºå½“å‰é¡µé¢æ¸²æŸ“çš„æ—¶é—´æˆ³ï¼Œæ³¨æ„è¿™æ˜¯å‰ç«¯çš„æ—¶é—´æ˜¾ç¤ºï¼Œåç«¯æ›´æ–°æ—¶é—´åº”ç”±åç«¯è®°å½• -->
          æœ€åæ›´æ–°: {{ moment().format('YYYY-MM-DD HH:mm:ss') }}
        </small>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// --------------------------- è‡ªåŠ¨å…³é—­æç¤ºä¿¡æ¯ ---------------------------
// é¡µé¢åŠ è½½å 5 ç§’è‡ªåŠ¨å…³é—­æ‰€æœ‰å¸¦æœ‰ .alert-dismissible çš„è­¦å‘Šæç¤ºï¼ˆé¿å…æŒç»­å ç”¨é¡µé¢ç©ºé—´ï¼‰
setTimeout(function() {
  const alerts = document.querySelectorAll('.alert-dismissible');
  alerts.forEach(alert => {
    const bsAlert = new bootstrap.Alert(alert);
    bsAlert.close();
  });
}, 5000);

// --------------------------- è¡¨æ ¼è¡Œç‚¹å‡»é€»è¾‘ï¼šæ•´è¡Œå¯ç‚¹å‡»è¿›å…¥è¯¦æƒ… ---------------------------
// ä¸ºæ¯ä¸€è¡Œç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»éæŒ‰é’®/é“¾æ¥åŒºåŸŸæ—¶è·³è½¬åˆ°è¯¦æƒ…é¡µ
document.querySelectorAll('tbody tr').forEach(row => {
  row.addEventListener('click', function(e) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–é“¾æ¥å…ƒç´ ï¼ˆåŒ…æ‹¬å…¶å­å…ƒç´ ï¼‰ï¼Œåˆ™ä¸è§¦å‘è¡Œç‚¹å‡»ä»¥ä¿ç•™æŒ‰é’®è¡Œä¸º
    if (e.target.closest('a, button')) return;

    // åœ¨è¡Œå†…æŸ¥æ‰¾æŒ‡å‘ delivery_detail çš„é“¾æ¥å¹¶è·³è½¬
    const link = this.querySelector('a[href*="delivery_detail"]');
    if (link) {
      window.location.href = link.href;
    }
  });

  // é¼ æ ‡ç§»å…¥æ—¶æ˜¾ç¤ºæ‰‹å‹ï¼Œæç¤ºç”¨æˆ·è¡Œå¯ç‚¹å‡»
  row.style.cursor = 'pointer';
});

// --------------------------- æ‰“å°åŠŸèƒ½ï¼ˆå¤‡ç”¨ï¼šç”Ÿæˆæ‰“å°ä¸“ç”¨çª—å£ï¼‰ ---------------------------
function printTable() {
  const printWindow = window.open('', '_blank');
  const tableHtml = document.querySelector('.table-responsive').innerHTML;

  printWindow.document.write(`
    <html>
      <head>
        <title>å‘è´§å•åˆ—è¡¨</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          .btn-group { display: none; }
        </style>
      </head>
      <body>
        <h2>å‘è´§å•åˆ—è¡¨</h2>
        <p>æ‰“å°æ—¶é—´: ${new Date().toLocaleString()}</p>
        ${tableHtml}
      </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.print();
}

// --------------------------- å¼¹çª—æœç´¢ç›¸å…³é€»è¾‘ ---------------------------
let currentSearchType = null; // æ ‡è®°å½“å‰å¼¹çª—æ˜¯ç”¨äºé€‰æ‹© "delivery" è¿˜æ˜¯ "sales"

function openSearchModal(type) {
  currentSearchType = type; // 'delivery' æˆ– 'sales'
  document.getElementById('searchKeyword').value = '';
  document.getElementById('searchResults').innerHTML = '';
  new bootstrap.Modal(document.getElementById('searchModal')).show();
}

function doSearch() {
  const keyword = document.getElementById('searchKeyword').value;
  if (!keyword) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }
  // å‘åç«¯å‘èµ· fetch è¯·æ±‚ï¼Œåç«¯åº”æ ¹æ® currentSearchType è¿”å›ä¸€ä¸ª HTML ç‰‡æ®µï¼ˆæˆ–è¡¨æ ¼è¡Œï¼‰
  fetch(`/search/${currentSearchType}?q=` + encodeURIComponent(keyword))
    .then(resp => resp.text())
    .then(html => {
      document.getElementById('searchResults').innerHTML = html;
    });
}

function selectResult(value) {
  // é€‰æ‹©æŸæ¡è®°å½•åå°†å€¼å¡«å…¥ç›¸åº”è¾“å…¥æ¡†å¹¶å…³é—­æ¨¡æ€æ¡†
  if (currentSearchType === 'delivery') {
    document.getElementById('delivery_id').value = value;
  } else if (currentSearchType === 'sales') {
    document.getElementById('sales_order_id').value = value;
  }
  bootstrap.Modal.getInstance(document.getElementById('searchModal')).hide();
}

</script>
{% endblock %}
