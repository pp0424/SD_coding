{% extends 'delivery/base.html' %}
{% block title %}å‘è´§å•åˆ—è¡¨{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='delivery/delivery_styles.css') }}">
<style>
  /* è¡¨æ ¼æ‰€æœ‰å•å…ƒæ ¼ä¸æ¢è¡Œ */
  .delivery-table th,
  .delivery-table td {
    white-space: nowrap;
    vertical-align: middle;
  }

  .delivery-card {
    width: 100%;
  }

  /* ç¡®ä¿ç¦ç”¨æ€ä¸å¯ç‚¹å‡»ä¸”æœ‰è§†è§‰å¼±åŒ– */
  .btn.disabled,
  .btn[aria-disabled="true"],
  .btn:disabled {
    pointer-events: none;
    opacity: .65;
  }

  /* é€šç”¨ç¦ç”¨æŒ‰é’®æ ·å¼ */
  .btn.disabled,
  .btn[aria-disabled="true"],
  .btn:disabled {
      pointer-events: none;   /* ç¦æ­¢ç‚¹å‡» */
      opacity: 0.5;           /* åŠé€æ˜æ•ˆæœ */
      background-color: #e0e0e0 !important; /* ç°åº• */
      color: #888 !important; /* ç°å­— */
      border-color: #ccc !important; /* ç°è¾¹æ¡† */
  }

</style>
{% endblock %}

{% block content %}
<!-- æœç´¢æ¨¡æ€æ¡† -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">é€‰æ‹©è®°å½•</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="searchKeyword" class="form-control mb-3" placeholder="è¾“å…¥å…³é”®å­—æœç´¢..." oninput="doSearch()">
        <div id="searchResults">
          <!-- AJAX æŸ¥è¯¢ç»“æœè¡¨ -->
        </div>
      </div>
    </div>
  </div>
</div>


<!-- æŸ¥è¯¢è¡¨å• -->
<div class="form-title-container">
  <h1 class="form-title">ğŸ” å‘è´§å•æŸ¥è¯¢</h1>
</div>

<div class="delivery-card animate-fade">
  <form method="post" class="row g-3 query-form align-items-end">
    {{ form.csrf_token }}

  <div class="col-md-2">
      <label class="form-label" for="delivery_id">{{ form.delivery_id.label.text }}</label>
      <div class="input-group">
        {{ form.delivery_id(class="form-control", id="delivery_id") }}
        <button type="button" class="btn btn-outline-secondary"
                onclick="openCentered('{{ url_for('delivery.delivery_helper') }}', 'deliveryHelper', 800, 600)">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>

    <!-- é”€å”®è®¢å• ID -->
    <div class="col-md-2">
      <label class="form-label" for="sales_order_id">{{ form.sales_order_id.label.text }}</label>
      <div class="input-group">
        {{ form.sales_order_id(class="form-control", id="sales_order_id") }}
        <button type="button" class="btn btn-outline-secondary"
                onclick="openCentered('{{ url_for('delivery.sales_helper') }}', 'salesHelper', 800, 600)">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>


 <div class="col-md-2">
      {{ form.status.label(class="form-label") }}
      {{ form.status(class="form-select") }}
    </div>

    <div class="col-md-2">
      {{ form.start_date.label(class="form-label") }}
      {{ form.start_date(class="form-control", type="date") }}
    </div>

    <div class="col-md-2">
      {{ form.end_date.label(class="form-label") }}
      {{ form.end_date(class="form-control", type="date") }}
    </div>

    <div class="col-md-2">
      {{ form.submit(class="btn btn-search w-100") }}
    </div>
  </form>
</div>

<!-- æŸ¥è¯¢ç»“æœ -->
<div class="delivery-card animate-fade">
  <div class="card-header">
    <div class="toolbar">
      <div>
        <i class="bi bi-list-ul me-2"></i>
        <strong>å‘è´§å•åˆ—è¡¨</strong>
        <span class="stats-info ms-3">å…±æ‰¾åˆ° {{ deliveries|length }} æ¡è®°å½•</span>
      </div>
      <div>
        <a href="{{ url_for('delivery.create_delivery') }}" class="btn btn-primary btn-sm">
          <i class="bi bi-plus-circle me-1"></i> æ–°å»ºå‘è´§å•
        </a>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print()">
          <i class="bi bi-printer me-1"></i> æ‰“å°
        </button>
      </div>
    </div>
  </div>

  <div class="table-responsive" style="max-height: 70vh;">
    <table class="delivery-table table-hover">
      <thead>
        <tr>
          <th>å‘è´§å•å·</th>
          <th>é”€å”®è®¢å•å·</th>
          <th>å‘è´§æ—¥æœŸ</th>
          <th style="width: 8%;">ä»“åº“ä»£ç </th>
          <th>çŠ¶æ€</th>
          <th>æ“ä½œ</th>
          <th>å¤‡æ³¨</th>
        </tr>
      </thead>
      <tbody>
        {% for delivery in deliveries %}
          {% set picking_cancelled = (delivery.picking_status == 'å·²å–æ¶ˆ') %}
          {% set can_edit = (delivery.status == 'å·²åˆ›å»º') and (not picking_cancelled) %}
          {% set can_pick = (delivery.status == 'å·²åˆ›å»º') and (not picking_cancelled) %}

          <tr>
            <td>
              <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}"
                 class="text-decoration-none fw-bold text-primary">
                {{ delivery.delivery_note_id }}
              </a>
            </td>
            <td><span class="text-muted">{{ delivery.sales_order_id }}</span></td>
            <td>{{ delivery.delivery_date.strftime('%Y-%m-%d') if delivery.delivery_date else '-' }}</td>
            <td><span class="badge bg-light text-dark">{{ delivery.warehouse_code }}</span></td>
            <td>
              <span class="badge 
                {% if delivery.status == 'å·²åˆ›å»º' %}bg-primary
                {% elif delivery.status == 'å·²æ‹£è´§' %}bg-warning
                {% elif delivery.status == 'å·²å‘è´§' %}bg-primary
                {% elif delivery.status == 'å·²è¿‡è´¦' %}bg-success
                {% elif delivery.status == 'å·²å®Œæˆ' %}bg-light text-dark
                {% elif delivery.status == 'å·²å–æ¶ˆ' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ delivery.status }}
              </span>
            </td>

            <td>
              <div class="d-flex flex-wrap gap-1">

                <!-- æŸ¥çœ‹ -->
                <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}"
                   class="btn btn-outline-info btn-action" title="æŸ¥çœ‹è¯¦æƒ…">
                  <i class="bi bi-eye"></i>
                </a>

                <!-- ç¼–è¾‘ï¼ˆä»…â€œå·²åˆ›å»ºâ€ä¸”æ‹£è´§å•æœªå–æ¶ˆæ—¶å¯ç”¨ï¼‰ -->
                <a href="{{ url_for('delivery.edit_delivery', delivery_id=delivery.delivery_note_id) }}"
                   class="btn btn-outline-warning btn-action {% if not can_edit %}disabled{% endif %}"
                   title="{% if not can_edit %}{% if picking_cancelled %}æ‹£è´§å•å·²å–æ¶ˆï¼Œç¦æ­¢ä¿®æ”¹{% else %}ä»…â€œå·²åˆ›å»ºâ€å¯ç¼–è¾‘{% endif %}{% else %}ç¼–è¾‘{% endif %}"
                   {% if not can_edit %}aria-disabled="true" tabindex="-1"{% endif %}>
                  <i class="bi bi-pencil"></i>
                </a>

                <!-- æ‹£è´§ï¼ˆä»…â€œå·²åˆ›å»ºâ€ä¸”æ‹£è´§å•æœªå–æ¶ˆæ—¶å¯ç”¨ï¼‰ -->
                <a href="{{ url_for('delivery.picking_task_detail', task_id=delivery.picking_task_id) }}"
                   class="btn btn-outline-warning btn-action {% if not can_pick %}disabled{% endif %}"
                   title="{% if not can_pick %}{% if picking_cancelled %}æ‹£è´§å•å·²å–æ¶ˆï¼Œç¦æ­¢æ‹£è´§{% else %}ä»…â€œå·²åˆ›å»ºâ€å¯æ‹£è´§{% endif %}{% else %}æ‹£è´§{% endif %}"
                   {% if not can_pick %}aria-disabled="true" tabindex="-1"{% endif %}>
                  <i class="bi bi-box-seam"></i>
                </a>

                <!-- å‘è´§ï¼ˆä¿æŒåŸé€»è¾‘ï¼šå·²æ‹£è´§ â†’ å¯å‘è´§ï¼‰ -->
                <form action="{{ url_for('delivery.shipment', delivery_id=delivery.delivery_note_id) }}" method="POST" style="display: inline;">
                  <button type="submit"
                          class="btn btn-outline-primary btn-action {% if delivery.status != 'å·²æ‹£è´§' %}disabled{% endif %}"
                          title="å‘è´§" {% if delivery.status != 'å·²æ‹£è´§' %}disabled{% endif %}>
                    <i class="bi bi-box-arrow-up"></i>
                  </button>
                </form>

                <!-- è¿‡è´¦ï¼ˆä¿æŒåŸé€»è¾‘ï¼šå·²å‘è´§ â†’ å¯è¿‡è´¦ï¼‰ -->
                <a href="{{ url_for('delivery.post_delivery', delivery_id=delivery.delivery_note_id) }}"
                   class="btn btn-outline-primary btn-action {% if delivery.status != 'å·²å‘è´§' %}disabled{% endif %}"
                   title="è¿‡è´¦" {% if delivery.status != 'å·²å‘è´§' %}aria-disabled="true" tabindex="-1"{% endif %}>
                  <i class="bi bi-check2-circle"></i>
                </a>

                <!-- å–æ¶ˆï¼ˆä¿æŒåŸé€»è¾‘ï¼‰ -->
                <a href="{{ url_for('delivery.cancel_delivery', delivery_id=delivery.delivery_note_id) }}"
                   class="btn btn-outline-danger btn-action {% if delivery.status not in ['å·²åˆ›å»º', 'å·²æ‹£è´§'] %}disabled{% endif %}"
                   title="å–æ¶ˆ" {% if delivery.status not in ['å·²åˆ›å»º', 'å·²æ‹£è´§'] %}aria-disabled="true" tabindex="-1"{% endif %}>
                  <i class="bi bi-x-circle"></i>
                </a>
              </div>
            </td>

            <td>
              <small class="text-muted">
                {{ delivery.remarks[:30] + '...' if delivery.remarks and delivery.remarks|length > 30 else (delivery.remarks or '-') }}
              </small>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="9" class="empty-state">
              <i class="bi bi-inbox display-4 d-block mb-2"></i>
              <h5 class="mb-2">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å‘è´§å•è®°å½•</h5>
              <p class="text-muted mb-0">è¯·è°ƒæ•´æŸ¥è¯¢æ¡ä»¶æˆ–
                <a href="{{ url_for('delivery.create_delivery') }}" class="text-decoration-none">åˆ›å»ºæ–°çš„å‘è´§å•</a>
              </p>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if deliveries %}
  <div class="card-footer bg-light">
    <div class="d-flex justify-content-between align-items-center">
      <div class="stats-info">
        æ˜¾ç¤º {{ deliveries|length }} æ¡è®°å½•
        {% set status_counts = {} %}
        {% for delivery in deliveries %}
          {% set _ = status_counts.update({delivery.status: status_counts.get(delivery.status, 0) + 1}) %}
        {% endfor %}
        {% if status_counts %}
        <span class="ms-3">
          {% for status, count in status_counts.items() %}
            <span class="badge bg-secondary me-1">{{ status }}: {{ count }}</span>
          {% endfor %}
        </span>
        {% endif %}
      </div>
      <div>
        <small class="text-muted">
          æœ€åæ›´æ–°: {{ moment().format('YYYY-MM-DD HH:mm:ss') }}
        </small>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// è‡ªåŠ¨å…³é—­æç¤ºä¿¡æ¯
setTimeout(function() {
  const alerts = document.querySelectorAll('.alert-dismissible');
  alerts.forEach(alert => {
    const bsAlert = new bootstrap.Alert(alert);
    bsAlert.close();
  });
}, 5000);

// è¡¨æ ¼è¡Œç‚¹å‡»æ•ˆæœ
document.querySelectorAll('tbody tr').forEach(row => {
  row.addEventListener('click', function(e) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–é“¾æ¥ï¼Œä¸è§¦å‘è¡Œç‚¹å‡»
    if (e.target.closest('a, button')) return;

    const link = this.querySelector('a[href*="delivery_detail"]');
    if (link) {
      window.location.href = link.href;
    }
  });

  // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
  row.style.cursor = 'pointer';
});

// æ‰“å°åŠŸèƒ½ä¼˜åŒ–
function printTable() {
  const printWindow = window.open('', '_blank');
  const tableHtml = document.querySelector('.table-responsive').innerHTML;

  printWindow.document.write(`
    <html>
      <head>
        <title>å‘è´§å•åˆ—è¡¨</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          .btn-group { display: none; }
        </style>
      </head>
      <body>
        <h2>å‘è´§å•åˆ—è¡¨</h2>
        <p>æ‰“å°æ—¶é—´: ${new Date().toLocaleString()}</p>
        ${tableHtml}
      </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.print();
}

let currentSearchType = null;

function openSearchModal(type) {
  currentSearchType = type; // 'delivery' æˆ– 'sales'
  document.getElementById('searchKeyword').value = '';
  document.getElementById('searchResults').innerHTML = '';
  new bootstrap.Modal(document.getElementById('searchModal')).show();
}

function doSearch() {
  const keyword = document.getElementById('searchKeyword').value;
  if (!keyword) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }
  fetch(`/search/${currentSearchType}?q=` + encodeURIComponent(keyword))
    .then(resp => resp.text())
    .then(html => {
      document.getElementById('searchResults').innerHTML = html;
    });
}

function selectResult(value) {
  if (currentSearchType === 'delivery') {
    document.getElementById('delivery_id').value = value;
  } else if (currentSearchType === 'sales') {
    document.getElementById('sales_order_id').value = value;
  }
  bootstrap.Modal.getInstance(document.getElementById('searchModal')).hide();
}

</script>
{% endblock %}
