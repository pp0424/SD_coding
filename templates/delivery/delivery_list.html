{% extends 'delivery/base.html' %}
{% block title %}发货单列表{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='delivery/delivery_styles.css') }}">
{% endblock %}

{% block content %}
<!-- 查询表单 -->
<div class="form-title-container">
    <h1 class="form-title">
      🔍 发货单查询
    </h1>
  </div>

<div class="delivery-card animate-fade">
  <form method="post" class="row g-3 query-form align-items-end">
    {{ form.csrf_token }}

    <div class="col-md-2">
      {{ form.delivery_id.label(class="form-label") }}
      {{ form.delivery_id(class="form-control", placeholder="发货单号") }}
    </div>

    <div class="col-md-2">
      {{ form.sales_order_id.label(class="form-label") }}
      {{ form.sales_order_id(class="form-control", placeholder="销售订单号") }}
    </div>

    <div class="col-md-2">
      {{ form.status.label(class="form-label") }}
      {{ form.status(class="form-select") }}
    </div>

    <div class="col-md-2">
      {{ form.start_date.label(class="form-label") }}
      {{ form.start_date(class="form-control", type="date") }}
    </div>

    <div class="col-md-2">
      {{ form.end_date.label(class="form-label") }}
      {{ form.end_date(class="form-control", type="date") }}
    </div>

    <div class="col-md-2">
      {{ form.submit(class="btn btn-search w-100") }}
    </div>
  </form>
</div>

<!-- 查询结果 -->
<div class="delivery-card animate-fade">
  <div class="card-header">
    <div class="toolbar">
      <div>
        <i class="bi bi-list-ul me-2"></i>
        <strong>发货单列表</strong>
        <span class="stats-info ms-3">共找到 {{ deliveries|length }} 条记录</span>
      </div>
      <div>
        <a href="{{ url_for('delivery.create_delivery') }}" class="btn btn-primary btn-sm">
          <i class="bi bi-plus-circle me-1"></i> 新建发货单
        </a>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print()">
          <i class="bi bi-printer me-1"></i> 打印
        </button>
      </div>
    </div>
  </div>

  <div class="table-responsive" style="max-height: 70vh;">
<table class="delivery-table table-hover">
      <thead>
        <tr>
          <th style="width: 140px;">发货单号</th>
          <th style="width: 120px;">销售订单号</th>
          <th style="width: 100px;">发货日期</th>
          <th style="width: 100px;">仓库代码</th>
          <th style="width: 80px;">状态</th>
          <th style="width: 100px;">过账人</th>
          <th style="width: 120px;">过账时间</th>
          <th style="min-width: 150px;">备注</th>
          <th style="width: 160px;">操作</th>
        </tr>
      </thead>
      <tbody>
        {% for delivery in deliveries %}
        <tr>
          <td>
            <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}" 
               class="text-decoration-none fw-bold text-primary">
              {{ delivery.delivery_note_id }}
            </a>
          </td>
          <td>
            <span class="text-muted">{{ delivery.sales_order_id }}</span>
          </td>
          <td>
            {{ delivery.delivery_date.strftime('%Y-%m-%d') if delivery.delivery_date else '-' }}
          </td>
          <td>
            <span class="badge bg-light text-dark">{{ delivery.warehouse_code }}</span>
          </td>
          <td>
            <span class="badge 
              {% if delivery.status == '已创建' %}bg-primary
              {% elif delivery.status == '待拣货' %}bg-info
              {% elif delivery.status == '已拣货' %}bg-warning
              {% elif delivery.status == '待发货' %}bg-secondary
              {% elif delivery.status == '已发货' %}bg-dark
              {% elif delivery.status == '已过账' %}bg-success
              {% elif delivery.status == '已完成' %}bg-light text-dark
              {% elif delivery.status == '已取消' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ delivery.status }}
            </span>
          </td>
          <td>
            <small class="text-muted">{{ delivery.posted_by or '-' }}</small>
          </td>
          <td>
            <small class="text-muted">
              {{ delivery.posted_at.strftime('%Y-%m-%d %H:%M') if delivery.posted_at else '-' }}
            </small>
          </td>
          <td>
            <small class="text-muted">{{ delivery.remarks[:30] + '...' if delivery.remarks and delivery.remarks|length > 30 else (delivery.remarks or '-') }}</small>
          </td>
          <td>
            <div class="d-flex flex-wrap gap-1">
              <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}" 
                 class="btn btn-outline-info btn-action" title="查看详情">
                <i class="bi bi-eye"></i>
              </a>
              
              {# 编辑: 仅适用于'已创建'和'待拣货'状态 #}
              {% if delivery.status in ['已创建', '待拣货'] %}
              <a href="{{ url_for('delivery.edit_delivery', delivery_id=delivery.delivery_note_id) }}" 
                 class="btn btn-outline-warning btn-action" title="编辑">
                <i class="bi bi-pencil"></i>
              </a>
              {% endif %}
              
              {# 过账: 仅适用于'已拣货'或'已发货'状态 #}
              {% if delivery.status in ['已拣货', '已发货'] %}
              <a href="{{ url_for('delivery.post_delivery', delivery_id=delivery.delivery_note_id) }}" 
                 class="btn btn-outline-success btn-action" title="过账">
                <i class="bi bi-check-circle"></i>
              </a>
              {% endif %}
              
              {# 变更状态: 适用于所有非最终状态 #}
              {% if delivery.status not in ['已过账', '已完成', '已取消'] %}
              <a href="{{ url_for('delivery.change_delivery_status', delivery_id=delivery.delivery_note_id) }}" 
                 class="btn btn-outline-primary btn-action" title="变更状态">
                <i class="bi bi-arrow-repeat"></i>
              </a>
              {% endif %}
              
              {# 取消: 仅适用于'已创建'或'待拣货'状态 #}
              {% if delivery.status in ['已创建', '待拣货'] %}
              <a href="{{ url_for('delivery.cancel_delivery', delivery_id=delivery.delivery_note_id) }}" 
                 class="btn btn-outline-danger btn-action" title="取消">
                <i class="bi bi-x-circle"></i>
              </a>
              {% endif %}
              
              {# 已过账状态显示禁用按钮 #}
              {% if delivery.status == '已过账' %}
              <button type="button" class="btn btn-outline-secondary btn-action" 
                      title="已过账" disabled>
                <i class="bi bi-check-circle-fill"></i>
              </button>
              {% endif %}
              
              {# 已完成状态显示禁用按钮 #}
              {% if delivery.status == '已完成' %}
              <button type="button" class="btn btn-outline-light btn-action" 
                      title="已完成" disabled>
                <i class="bi bi-check2-all"></i>
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="empty-state">
            <i class="bi bi-inbox display-4 d-block mb-2"></i>
            <h5 class="mb-2">暂无符合条件的发货单记录</h5>
            <p class="text-muted mb-0">请调整查询条件或 
              <a href="{{ url_for('delivery.create_delivery') }}" class="text-decoration-none">创建新的发货单</a>
            </p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if deliveries %}
  <div class="card-footer bg-light">
    <div class="d-flex justify-content-between align-items-center">
      <div class="stats-info">
        显示 {{ deliveries|length }} 条记录
        {% set status_counts = {} %}
        {% for delivery in deliveries %}
          {% set _ = status_counts.update({delivery.status: status_counts.get(delivery.status, 0) + 1}) %}
        {% endfor %}
        {% if status_counts %}
        <span class="ms-3">
          {% for status, count in status_counts.items() %}
          <span class="badge bg-secondary me-1">{{ status }}: {{ count }}</span>
          {% endfor %}
        </span>
        {% endif %}
      </div>
      <div>
        <small class="text-muted">
          最后更新: {{ moment().format('YYYY-MM-DD HH:mm:ss') }}
        </small>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- 快捷操作提示 -->
<div class="mt-3">
  <div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="bi bi-info-circle me-2"></i>
    <strong>操作提示：</strong>
    点击发货单号可查看详情；状态为"已创建"或"待拣货"的发货单可以编辑；状态为"已拣货"或"已发货"的发货单可以过账；已过账的发货单不可修改。
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 自动关闭提示信息
setTimeout(function() {
  const alerts = document.querySelectorAll('.alert-dismissible');
  alerts.forEach(alert => {
    const bsAlert = new bootstrap.Alert(alert);
    bsAlert.close();
  });
}, 5000);

// 表格行点击效果
document.querySelectorAll('tbody tr').forEach(row => {
  row.addEventListener('click', function(e) {
    // 如果点击的是按钮或链接，不触发行点击
    if (e.target.closest('a, button')) return;
    
    const link = this.querySelector('a[href*="delivery_detail"]');
    if (link) {
      window.location.href = link.href;
    }
  });
  
  // 添加鼠标悬停效果
  row.style.cursor = 'pointer';
});

// 打印功能优化
function printTable() {
  const printWindow = window.open('', '_blank');
  const tableHtml = document.querySelector('.table-responsive').innerHTML;
  
  printWindow.document.write(`
    <html>
      <head>
        <title>发货单列表</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          .btn-group { display: none; }
        </style>
      </head>
      <body>
        <h2>发货单列表</h2>
        <p>打印时间: ${new Date().toLocaleString()}</p>
        ${tableHtml}
      </body>
    </html>
  `);
  
  printWindow.document.close();
  printWindow.print();
}
</script>
{% endblock %}
