{% extends 'delivery/base.html' %}
{% block title %}å‘è´§å•åˆ—è¡¨{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='delivery/delivery_styles.css') }}">
{% endblock %}

{% block content %}
<!-- æŸ¥è¯¢è¡¨å• -->
<div class="form-title-container">
    <h1 class="form-title">
      ğŸ” å‘è´§å•æŸ¥è¯¢
    </h1>
  </div>

<div class="delivery-card animate-fade">
  <form method="post" class="row g-3 query-form align-items-end">
    {{ form.csrf_token }}

    <div class="col-md-2">
      {{ form.delivery_id.label(class="form-label") }}
      {{ form.delivery_id(class="form-control", placeholder="å‘è´§å•å·") }}
    </div>

    <div class="col-md-2">
      {{ form.sales_order_id.label(class="form-label") }}
      {{ form.sales_order_id(class="form-control", placeholder="é”€å”®è®¢å•å·") }}
    </div>

    <div class="col-md-2">
      {{ form.status.label(class="form-label") }}
      {{ form.status(class="form-select") }}
    </div>

    <div class="col-md-2">
      {{ form.start_date.label(class="form-label") }}
      {{ form.start_date(class="form-control", type="date") }}
    </div>

    <div class="col-md-2">
      {{ form.end_date.label(class="form-label") }}
      {{ form.end_date(class="form-control", type="date") }}
    </div>

    <div class="col-md-2">
      {{ form.submit(class="btn btn-search w-100") }}
    </div>
  </form>
</div>

<!-- æŸ¥è¯¢ç»“æœ -->
<div class="delivery-card animate-fade">
  <div class="card-header">
    <div class="toolbar">
      <div>
        <i class="bi bi-list-ul me-2"></i>
        <strong>å‘è´§å•åˆ—è¡¨</strong>
        <span class="stats-info ms-3">å…±æ‰¾åˆ° {{ deliveries|length }} æ¡è®°å½•</span>
      </div>
      <div>
        <a href="{{ url_for('delivery.create_delivery') }}" class="btn btn-primary btn-sm">
          <i class="bi bi-plus-circle me-1"></i> æ–°å»ºå‘è´§å•
        </a>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print()">
          <i class="bi bi-printer me-1"></i> æ‰“å°
        </button>
      </div>
    </div>
  </div>

  <div class="table-responsive" style="max-height: 70vh;">
<table class="delivery-table table-hover">
      <thead>
        <tr>
          <th style="width: 140px;">å‘è´§å•å·</th>
          <th style="width: 120px;">é”€å”®è®¢å•å·</th>
          <th style="width: 100px;">å‘è´§æ—¥æœŸ</th>
          <th style="width: 100px;">ä»“åº“ä»£ç </th>
          <th style="width: 80px;">çŠ¶æ€</th>
          <th style="width: 100px;">è¿‡è´¦äºº</th>
          <th style="width: 120px;">è¿‡è´¦æ—¶é—´</th>
          <th style="min-width: 150px;">å¤‡æ³¨</th>
          <th style="width: 160px;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for delivery in deliveries %}
        <tr>
          <td>
            <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}" 
               class="text-decoration-none fw-bold text-primary">
              {{ delivery.delivery_note_id }}
            </a>
          </td>
          <td>
            <span class="text-muted">{{ delivery.sales_order_id }}</span>
          </td>
          <td>
            {{ delivery.delivery_date.strftime('%Y-%m-%d') if delivery.delivery_date else '-' }}
          </td>
          <td>
            <span class="badge bg-light text-dark">{{ delivery.warehouse_code }}</span>
          </td>
          <td>
            <span class="badge 
              {% if delivery.status == 'å·²åˆ›å»º' %}bg-primary
              {% elif delivery.status == 'å¾…æ‹£è´§' %}bg-info
              {% elif delivery.status == 'å·²æ‹£è´§' %}bg-warning
              {% elif delivery.status == 'å¾…å‘è´§' %}bg-secondary
              {% elif delivery.status == 'å·²å‘è´§' %}bg-dark
              {% elif delivery.status == 'å·²è¿‡è´¦' %}bg-success
              {% elif delivery.status == 'å·²å®Œæˆ' %}bg-light text-dark
              {% elif delivery.status == 'å·²å–æ¶ˆ' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ delivery.status }}
            </span>
          </td>
          <td>
            <small class="text-muted">{{ delivery.posted_by or '-' }}</small>
          </td>
          <td>
            <small class="text-muted">
              {{ delivery.posted_at.strftime('%Y-%m-%d %H:%M') if delivery.posted_at else '-' }}
            </small>
          </td>
          <td>
            <small class="text-muted">{{ delivery.remarks[:30] + '...' if delivery.remarks and delivery.remarks|length > 30 else (delivery.remarks or '-') }}</small>
          </td>
          <td>
            <div class="d-flex flex-wrap gap-1">
              <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}" 
                 class="btn btn-outline-info btn-action" title="æŸ¥çœ‹è¯¦æƒ…">
                <i class="bi bi-eye"></i>
              </a>
              
              {# ç¼–è¾‘: ä»…é€‚ç”¨äº'å·²åˆ›å»º'å’Œ'å¾…æ‹£è´§'çŠ¶æ€ #}
              {% if delivery.status in ['å·²åˆ›å»º', 'å¾…æ‹£è´§'] %}
              <a href="{{ url_for('delivery.edit_delivery', delivery_id=delivery.delivery_note_id) }}" 
                 class="btn btn-outline-warning btn-action" title="ç¼–è¾‘">
                <i class="bi bi-pencil"></i>
              </a>
              {% endif %}
              
              {# è¿‡è´¦: ä»…é€‚ç”¨äº'å·²æ‹£è´§'æˆ–'å·²å‘è´§'çŠ¶æ€ #}
              {% if delivery.status in ['å·²æ‹£è´§', 'å·²å‘è´§'] %}
              <a href="{{ url_for('delivery.post_delivery', delivery_id=delivery.delivery_note_id) }}" 
                 class="btn btn-outline-success btn-action" title="è¿‡è´¦">
                <i class="bi bi-check-circle"></i>
              </a>
              {% endif %}
              
              {# å˜æ›´çŠ¶æ€: é€‚ç”¨äºæ‰€æœ‰éæœ€ç»ˆçŠ¶æ€ #}
              {% if delivery.status not in ['å·²è¿‡è´¦', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ'] %}
              <a href="{{ url_for('delivery.change_delivery_status', delivery_id=delivery.delivery_note_id) }}" 
                 class="btn btn-outline-primary btn-action" title="å˜æ›´çŠ¶æ€">
                <i class="bi bi-arrow-repeat"></i>
              </a>
              {% endif %}
              
              {# å–æ¶ˆ: ä»…é€‚ç”¨äº'å·²åˆ›å»º'æˆ–'å¾…æ‹£è´§'çŠ¶æ€ #}
              {% if delivery.status in ['å·²åˆ›å»º', 'å¾…æ‹£è´§'] %}
              <a href="{{ url_for('delivery.cancel_delivery', delivery_id=delivery.delivery_note_id) }}" 
                 class="btn btn-outline-danger btn-action" title="å–æ¶ˆ">
                <i class="bi bi-x-circle"></i>
              </a>
              {% endif %}
              
              {# å·²è¿‡è´¦çŠ¶æ€æ˜¾ç¤ºç¦ç”¨æŒ‰é’® #}
              {% if delivery.status == 'å·²è¿‡è´¦' %}
              <button type="button" class="btn btn-outline-secondary btn-action" 
                      title="å·²è¿‡è´¦" disabled>
                <i class="bi bi-check-circle-fill"></i>
              </button>
              {% endif %}
              
              {# å·²å®ŒæˆçŠ¶æ€æ˜¾ç¤ºç¦ç”¨æŒ‰é’® #}
              {% if delivery.status == 'å·²å®Œæˆ' %}
              <button type="button" class="btn btn-outline-light btn-action" 
                      title="å·²å®Œæˆ" disabled>
                <i class="bi bi-check2-all"></i>
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="empty-state">
            <i class="bi bi-inbox display-4 d-block mb-2"></i>
            <h5 class="mb-2">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å‘è´§å•è®°å½•</h5>
            <p class="text-muted mb-0">è¯·è°ƒæ•´æŸ¥è¯¢æ¡ä»¶æˆ– 
              <a href="{{ url_for('delivery.create_delivery') }}" class="text-decoration-none">åˆ›å»ºæ–°çš„å‘è´§å•</a>
            </p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if deliveries %}
  <div class="card-footer bg-light">
    <div class="d-flex justify-content-between align-items-center">
      <div class="stats-info">
        æ˜¾ç¤º {{ deliveries|length }} æ¡è®°å½•
        {% set status_counts = {} %}
        {% for delivery in deliveries %}
          {% set _ = status_counts.update({delivery.status: status_counts.get(delivery.status, 0) + 1}) %}
        {% endfor %}
        {% if status_counts %}
        <span class="ms-3">
          {% for status, count in status_counts.items() %}
          <span class="badge bg-secondary me-1">{{ status }}: {{ count }}</span>
          {% endfor %}
        </span>
        {% endif %}
      </div>
      <div>
        <small class="text-muted">
          æœ€åæ›´æ–°: {{ moment().format('YYYY-MM-DD HH:mm:ss') }}
        </small>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- å¿«æ·æ“ä½œæç¤º -->
<div class="mt-3">
  <div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="bi bi-info-circle me-2"></i>
    <strong>æ“ä½œæç¤ºï¼š</strong>
    ç‚¹å‡»å‘è´§å•å·å¯æŸ¥çœ‹è¯¦æƒ…ï¼›çŠ¶æ€ä¸º"å·²åˆ›å»º"æˆ–"å¾…æ‹£è´§"çš„å‘è´§å•å¯ä»¥ç¼–è¾‘ï¼›çŠ¶æ€ä¸º"å·²æ‹£è´§"æˆ–"å·²å‘è´§"çš„å‘è´§å•å¯ä»¥è¿‡è´¦ï¼›å·²è¿‡è´¦çš„å‘è´§å•ä¸å¯ä¿®æ”¹ã€‚
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// è‡ªåŠ¨å…³é—­æç¤ºä¿¡æ¯
setTimeout(function() {
  const alerts = document.querySelectorAll('.alert-dismissible');
  alerts.forEach(alert => {
    const bsAlert = new bootstrap.Alert(alert);
    bsAlert.close();
  });
}, 5000);

// è¡¨æ ¼è¡Œç‚¹å‡»æ•ˆæœ
document.querySelectorAll('tbody tr').forEach(row => {
  row.addEventListener('click', function(e) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–é“¾æ¥ï¼Œä¸è§¦å‘è¡Œç‚¹å‡»
    if (e.target.closest('a, button')) return;
    
    const link = this.querySelector('a[href*="delivery_detail"]');
    if (link) {
      window.location.href = link.href;
    }
  });
  
  // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
  row.style.cursor = 'pointer';
});

// æ‰“å°åŠŸèƒ½ä¼˜åŒ–
function printTable() {
  const printWindow = window.open('', '_blank');
  const tableHtml = document.querySelector('.table-responsive').innerHTML;
  
  printWindow.document.write(`
    <html>
      <head>
        <title>å‘è´§å•åˆ—è¡¨</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          .btn-group { display: none; }
        </style>
      </head>
      <body>
        <h2>å‘è´§å•åˆ—è¡¨</h2>
        <p>æ‰“å°æ—¶é—´: ${new Date().toLocaleString()}</p>
        ${tableHtml}
      </body>
    </html>
  `);
  
  printWindow.document.close();
  printWindow.print();
}
</script>
{% endblock %}
