{# ç»§æ‰¿åŸºç¡€å¸ƒå±€æ¨¡æ¿ #}
{% extends "delivery/base.html" %}

{% block content %}
<!-- æ ‡é¢˜ -->
<div class="form-title-container">
  <h1 class="form-title">ğŸ“ åˆ›å»ºå‘è´§å•</h1>
</div>

<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <!-- æ‹£è´§è¡¨å•ï¼šæäº¤åˆ°å½“å‰è·¯ç”± -->
      <form method="post" id="pick-form">
        {{ form.hidden_tag() }} {# CSRF ç­‰éšè—å­—æ®µ #}

        <!-- é¡¶éƒ¨åŸºç¡€ä¿¡æ¯åŒºåŸŸï¼šé”€å”®è®¢å•ã€ä»“åº“ã€æ—¥æœŸç­‰ -->
        <div class="row mb-5">
          <div class="col-md-2">
            <label class="form-label fw-bold" for="sales_order_id">{{ form.sales_order_id.label.text }}</label>
            <div class="input-group">
              <!-- é”€å”®è®¢å•å·è¾“å…¥ï¼ˆè”åŠ¨åŠ è½½æ‹£è´§è¡Œï¼‰ -->
              {{ form.sales_order_id(class="form-control", id="sales_order_id") }}
              <!-- æ‰“å¼€â€œé”€å”®è®¢å•åŠ©æ‰‹â€çª—å£ä»¥é€‰æ‹©è®¢å• -->
              <button type="button" class="btn btn-outline-secondary"
                      onclick="window.open('{{ url_for('delivery.sales_helper') }}', 'salesHelper', 'width=1080,height=720')">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
          
          <!-- ä»“åº“ä»£ç ï¼ˆä¼šè¢«è‡ªåŠ¨å¡«å……ï¼‰ -->
          <div class="col-md-3">
            {{ form.warehouse_code.label(class="form-label fw-bold") }}
            {{ form.warehouse_code(class="form-control", id="warehouse_code") }}
          </div>

          <!-- è®¢å•æ—¥æœŸï¼ˆä¼šè¢«è‡ªåŠ¨å¡«å……ï¼‰ -->
          <div class="col-md-2">
            {{ form.order_date.label(class="form-label fw-bold") }}
            {{ form.order_date(class="form-control", type="date", id="order_date") }}
          </div>

          <!-- è¦æ±‚å‘è´§æ—¥æœŸï¼ˆä¼šè¢«è‡ªåŠ¨å¡«å……ï¼‰ -->
          <div class="col-md-2">
            {{ form.required_delivery_date.label(class="form-label fw-bold") }}
            {{ form.required_delivery_date(class="form-control", type="date", id="required_delivery_date") }}
          </div>

          <!-- é¢„è®¡å‘è´§æ—¥æœŸï¼ˆå¯æ‰‹åŠ¨è°ƒæ•´ï¼‰ -->
          <div class="col-md-2">
            {{ form.expected_delivery_date.label(class="form-label fw-bold") }}
            {{ form.expected_delivery_date(class="form-control", type="date", id="expected_delivery_date") }}
          </div>
        </div>

        <!-- æ‹£è´§è¡Œé¡¹ç›®è¡¨æ ¼ -->
        <h5 class="mt-4 mb-3">æ‹£è´§é¡¹ç›®</h5>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="thead-light">
              <tr>
                <th>è¡Œå·</th>
                <th>ç‰©æ–™ç¼–å·</th>         <!-- æ³¨æ„ï¼šä¸‹æ–¹forå¾ªç¯é‡Œè¯¥åˆ—ä½¿ç”¨çš„æ˜¯ sales_order_item_no -->
                <th>ç‰©æ–™æè¿°</th>
                <th>åŸºæœ¬å•ä½</th>
                <th>å­˜å‚¨ä½ç½®</th>
                <th>è®¢å•æ•°é‡</th>
                <th>æœªå‘æ•°é‡</th>
                <th>æœ¬æ¬¡æ‹£è´§æ•°é‡</th>     <!-- ä»…è¯¥åˆ—ä¸ºå¯ç¼–è¾‘ -->
              </tr>
            </thead>
            <tbody id="items-body">
              {% for item_form in form.items %}
              <!-- å½“åç«¯å·²æ¸²æŸ“å­˜åœ¨ items æ—¶çš„å›æ˜¾ï¼ˆé€šå¸¸é¦–å±ä¸ºç©ºï¼Œäº¤ç”± JS åŠ¨æ€æ¸²æŸ“ï¼‰ -->
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ item_form.sales_order_item_no.data }}</td>
                <td>{{ item_form.material_id.data }}</td>
                <td>{{ item_form.material_desc.data }}</td>
                <td>{{ item_form.base_unit.data }}</td>
                <td>{{ item_form.storage_location.data }}</td>
                <td>{{ item_form.order_quantity.data }}</td>
                <td>{{ item_form.unshipped_quantity.data }}</td>
                <td>{{ item_form.planned_delivery_quantity(class="form-control form-control-sm") }}</td>
              </tr>
              {% else %}
              <!-- æ²¡æœ‰å¯æ‹£è´§è¡Œæ—¶çš„å ä½ -->
              <tr>
                <td colspan="8" class="text-center text-muted">æš‚æ— å¯æ‹£è´§çš„è®¢å•è¡Œ</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- åŠ¨æ€éšè—è¾“å…¥å®¹å™¨
             ç”¨äºæŠŠä»æ¥å£è¿”å›çš„è¡Œå­—æ®µï¼ˆé™¤â€œæœ¬æ¬¡æ‹£è´§æ•°é‡â€å¤–ï¼‰å¡å…¥éšè—åŸŸæäº¤åˆ°åç«¯ã€‚
             è¿™æ ·åªåœ¨è¡¨æ ¼é‡Œæš´éœ²æ•°é‡è¾“å…¥ï¼Œå…¶ä»–å­—æ®µä¸ç›´æ¥å¯ç¼–è¾‘ï¼Œé˜²æ­¢è¢«è¯¯æ”¹ã€‚ -->
        <div id="dynamic-inputs"></div>

        <!-- å¤‡æ³¨ -->
        <div class="mt-3">
          {{ form.remarks.label(class="form-label fw-bold") }}
          {{ form.remarks(class="form-control", rows="2") }}
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="mt-4">
          <button type="submit" class="btn btn-primary">ç”Ÿæˆå‘è´§å•</button>
          <a href="{{ url_for('delivery.delivery_home') }}" class="btn btn-secondary">å–æ¶ˆ</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- äº¤äº’é€»è¾‘ï¼šæ ¹æ®é”€å”®è®¢å•å·è‡ªåŠ¨åŠ è½½æ‹£è´§è¡ŒåŠç›¸å…³å­—æ®µ -->
<script>
(function () {
  // ---------- DOM å¼•ç”¨ ----------
  const soInput = document.getElementById('sales_order_id');          // é”€å”®è®¢å•å·è¾“å…¥
  const warehouseInput = document.getElementById('warehouse_code');   // ä»“åº“ä»£ç 
  const orderDateInput = document.getElementById('order_date');       // è®¢å•æ—¥æœŸ
  const requiredDeliveryInput = document.getElementById('required_delivery_date'); // è¦æ±‚å‘è´§æ—¥æœŸ
  const itemsBody = document.getElementById('items-body');            // è¡¨æ ¼ tbody
  const hiddenContainer = document.getElementById('dynamic-inputs');  // åŠ¨æ€éšè—åŸŸå®¹å™¨

  // API åœ°å€æ¨¡æ¿ï¼ˆç”±åç«¯ç”Ÿæˆï¼Œ__SO__ å ä½ç¬¦å°†è¢«æ›¿æ¢ä¸ºçœŸå®è®¢å•å·ï¼‰
  const apiBase = "{{ url_for('delivery.api_sales_order_items', sales_order_id='__SO__') }}";

  // æ¸…ç©ºè¡¨æ ¼å’Œéšè—åŸŸï¼Œå¹¶æ˜¾ç¤ºå ä½è¡Œ
  function clearRows() {
    itemsBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">æš‚æ— å¯æ‹£è´§çš„è®¢å•è¡Œ</td></tr>`;
    hiddenContainer.innerHTML = '';
  }

  // ç®€å•è½¬ä¹‰ï¼Œé¿å…æŠŠæ¥å£è¿”å›çš„å­—ç¬¦ä¸²ç›´æ¥æ’å…¥ HTML æ—¶é€ æˆ XSS
  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'
    }[m]));
  }

  // å‘éšè—å®¹å™¨æ·»åŠ ä¸€ä¸ªéšè— inputï¼ˆname/valueï¼‰
  function addHidden(name, value) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = name;
    input.value = value ?? '';
    hiddenContainer.appendChild(input);
  }

  // æ ¹æ®æ¥å£è¿”å›çš„ items é‡ç»˜è¡¨æ ¼è¡Œï¼Œå¹¶åŒæ­¥ç”Ÿæˆå¯¹åº”éšè—å­—æ®µ
function buildRows(items) {
  itemsBody.innerHTML = '';
  hiddenContainer.innerHTML = '';

  if (!items || !items.length) {
    clearRows();
    return;
  }

  items.forEach((it, idx) => {
    const baseUnit = it.base_unit || it.unit || '';
    const tr = document.createElement('tr');

    // è¡Œå·
    const tdIndex = document.createElement('td');
    tdIndex.textContent = idx + 1;
    tr.appendChild(tdIndex);

    // ç‰©æ–™ç¼–å·
    const tdMaterialId = document.createElement('td');
    tdMaterialId.textContent = it.material_id || '';
    tr.appendChild(tdMaterialId);

    // ç‰©æ–™æè¿°
    const tdDesc = document.createElement('td');
    tdDesc.textContent = it.material_desc || '';
    tr.appendChild(tdDesc);

    // åŸºæœ¬å•ä½
    const tdUnit = document.createElement('td');
    tdUnit.textContent = baseUnit;
    tr.appendChild(tdUnit);

    // å­˜å‚¨ä½ç½®
    const tdLocation = document.createElement('td');
    tdLocation.textContent = it.storage_location || '';
    tr.appendChild(tdLocation);

    // è®¢å•æ•°é‡
    const tdOrderQty = document.createElement('td');
    tdOrderQty.textContent = it.order_quantity;
    tr.appendChild(tdOrderQty);

    // æœªå‘æ•°é‡
    const tdUnshippedQty = document.createElement('td');
    tdUnshippedQty.textContent = it.unshipped_quantity;
    tr.appendChild(tdUnshippedQty);

    // æœ¬æ¬¡æ‹£è´§æ•°é‡ï¼ˆè¾“å…¥æ¡†ï¼‰
    const tdInput = document.createElement('td');
    const input = document.createElement('input');
    input.type = 'number';
    input.step = '0.0001';
    input.min = '0';
    input.max = it.unshipped_quantity;
    input.className = 'form-control form-control-sm';
    input.name = `items-${idx}-planned_delivery_quantity`;
    input.value = it.planned_delivery_quantity ?? '';
    input.required = true;
    tdInput.appendChild(input);
    tr.appendChild(tdInput);

    itemsBody.appendChild(tr);

    // åŒæ­¥éšè—å­—æ®µ
    addHidden(`items-${idx}-sales_order_item_no`, it.sales_order_item_no ?? '');
    addHidden(`items-${idx}-material_id`, it.material_id ?? '');
    addHidden(`items-${idx}-material_desc`, it.material_desc ?? '');
    addHidden(`items-${idx}-base_unit`, baseUnit);
    addHidden(`items-${idx}-unit`, it.unit ?? '');
    addHidden(`items-${idx}-storage_location`, it.storage_location ?? '');
    addHidden(`items-${idx}-order_quantity`, it.order_quantity ?? '0');
    addHidden(`items-${idx}-unshipped_quantity`, it.unshipped_quantity ?? '0');
  });
}


  // ---------- è§¦å‘åŠ è½½ï¼ˆå¸¦ç®€å•é˜²æŠ–ï¼‰ ----------
  let debounceTimer = null;
  function triggerLoad() {
    const raw = (soInput.value || '').trim();

    // æ²¡å¡«è®¢å•å·åˆ™æ¸…ç©º
    if (!raw) {
      clearRows();
      orderDateInput.value = '';
      warehouseInput.value = '';
      requiredDeliveryInput.value = '';
      return;
    }

    // æ‹¼æ¥å®é™…è¯·æ±‚åœ°å€
    const url = apiBase.replace('__SO__', encodeURIComponent(raw));

    // ç½®ä¸ºâ€œåŠ è½½ä¸­â€å ä½
    itemsBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>`;

    // è¯·æ±‚åç«¯æ¥å£ï¼Œè·å–è®¢å•è¡Œä¸æŠ¬å¤´ä¿¡æ¯
    fetch(url, { headers: { 'Accept': 'application/json' } })
      .then(r => r.json())
      .then(data => {
        // æœªæ‰¾åˆ°å¯¹åº”é”€å”®è®¢å•
        if (!data.found) {
          itemsBody.innerHTML = `<tr><td colspan="8" class="text-center text-warning">æœªæ‰¾åˆ°é”€å”®è®¢å•ï¼š${escapeHtml(raw)}</td></tr>`;
          hiddenContainer.innerHTML = '';
          orderDateInput.value = '';
          warehouseInput.value = '';
          requiredDeliveryInput.value = '';
          return;
        }

        // è‡ªåŠ¨å¡«å……ä»“åº“ä»£ç å’Œæ—¥æœŸï¼ˆå­˜åœ¨åˆ™è¦†ç›–ï¼‰
        warehouseInput.value = data.warehouse_code || '';
        orderDateInput.value = data.order_date || '';
        requiredDeliveryInput.value = data.required_delivery_date || '';

        // é‡ç»˜æ‹£è´§è¡Œ
        buildRows(data.items || []);
      })
      .catch(err => {
        // ç®€å•çš„é”™è¯¯å…œåº•æç¤ºï¼ˆæ§åˆ¶å°æ‰“å°è¯¦ç»†é”™è¯¯ä¾¿äºæ’æŸ¥ï¼‰
        console.error(err);
        itemsBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</td></tr>`;
        hiddenContainer.innerHTML = '';
      });
  }

  // ç›‘å¬è®¢å•å·è¾“å…¥ï¼Œé˜²æŠ–åè§¦å‘åŠ è½½
  ['change', 'blur', 'input'].forEach(evt =>
    soInput.addEventListener(evt, () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(triggerLoad, 300); // 300ms é˜²æŠ–
    })
  );

  // é¡µé¢åˆå§‹å¦‚å·²æœ‰é”€å”®è®¢å•å·ï¼ˆä¾‹å¦‚è¿”å›å›æ˜¾ï¼‰ï¼Œåˆ™è‡ªåŠ¨åŠ è½½
  if ((soInput.value || '').trim()) {
    triggerLoad();
  }
})();
</script>
{% endblock %}
