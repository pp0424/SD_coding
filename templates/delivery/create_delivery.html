{% extends "delivery/base.html" %}

{% block content %}
<div class="form-title-container">
  <h1 class="form-title">📝 创建发货单</h1>
</div>

<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" id="pick-form">
        {{ form.hidden_tag() }}

        <div class="row mb-5">
          <div class="col-md-2">
            {{ form.sales_order_id.label(class="form-label fw-bold") }}
            {{ form.sales_order_id(class="form-control", id="sales_order_id") }}
          </div>
          <div class="col-md-3">
            {{ form.warehouse_code.label(class="form-label fw-bold") }}
            {{ form.warehouse_code(class="form-control", id="warehouse_code") }}
          </div>
          <div class="col-md-2">
            {{ form.order_date.label(class="form-label fw-bold") }}
            {{ form.order_date(class="form-control", type="date", id="order_date") }}
          </div>
          <div class="col-md-2">
            {{ form.required_delivery_date.label(class="form-label fw-bold") }}
            {{ form.required_delivery_date(class="form-control", type="date", id="required_delivery_date") }}
          </div>
          <div class="col-md-2">
            {{ form.expected_delivery_date.label(class="form-label fw-bold") }}
            {{ form.expected_delivery_date(class="form-control", type="date", id="expected_delivery_date") }}
          </div>
        </div>

        <h5 class="mt-4 mb-3">拣货项目</h5>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="thead-light">
              <tr>
                <th>行号</th>
                <th>物料编号</th>
                <th>物料描述</th>
                <th>基本单位</th>
                <th>存储位置</th>
                <th>订单数量</th>
                <th>未发数量</th>
                <th>本次拣货数量</th>
              </tr>
            </thead>
            <tbody id="items-body">
              {% for item_form in form.items %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ item_form.sales_order_item_no.data }}</td>
                <td>{{ item_form.material_id.data }}</td>
                <td>{{ item_form.material_desc.data }}</td>
                <td>{{ item_form.base_unit.data }}</td>
                <td>{{ item_form.storage_location.data }}</td>
                <td>{{ item_form.order_quantity.data }}</td>
                <td>{{ item_form.unshipped_quantity.data }}</td>
                <td>{{ item_form.planned_delivery_quantity(class="form-control form-control-sm") }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="8" class="text-center text-muted">暂无可拣货的订单行</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- 动态隐藏输入：用来提交除“本次拣货数量”外的字段 -->
        <div id="dynamic-inputs"></div>

        <div class="mt-3">
          {{ form.remarks.label(class="form-label fw-bold") }}
          {{ form.remarks(class="form-control", rows="2") }}
        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary">生成发货单</button>
          <a href="{{ url_for('delivery.delivery_home') }}" class="btn btn-secondary">取消</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS: 根据销售订单自动加载拣货行及仓库、日期 -->
<script>
(function () {
  const soInput = document.getElementById('sales_order_id');
  const warehouseInput = document.getElementById('warehouse_code');
  const orderDateInput = document.getElementById('order_date');
  const requiredDeliveryInput = document.getElementById('required_delivery_date');
  const itemsBody = document.getElementById('items-body');
  const hiddenContainer = document.getElementById('dynamic-inputs');

  const apiBase = "{{ url_for('delivery.api_sales_order_items', sales_order_id='__SO__') }}";

  function clearRows() {
    itemsBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">暂无可拣货的订单行</td></tr>`;
    hiddenContainer.innerHTML = '';
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'
    }[m]));
  }

  function addHidden(name, value) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = name;
    input.value = value ?? '';
    hiddenContainer.appendChild(input);
  }

  function buildRows(items) {
    itemsBody.innerHTML = '';
    hiddenContainer.innerHTML = '';

    if (!items || !items.length) {
      clearRows();
      return;
    }

    items.forEach((it, idx) => {
      const baseUnit = it.base_unit || it.unit || '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${escapeHtml(it.material_id)}</td>
        <td>${escapeHtml(it.material_desc || '')}</td>
        <td>${escapeHtml(baseUnit)}</td>
        <td>${escapeHtml(it.storage_location || '')}</td>
        <td>${escapeHtml(it.order_quantity)}</td>
        <td>${escapeHtml(it.unshipped_quantity)}</td>
        <td>
          <input
            type="number"
            step="0.0001"
            min="0"
            max="${escapeHtml(it.unshipped_quantity)}"
            class="form-control form-control-sm"
            name="items-${idx}-planned_delivery_quantity"
            value="${escapeHtml(it.planned_delivery_quantity)}"
            required
          />
        </td>
      `;
      itemsBody.appendChild(tr);

      addHidden(`items-${idx}-sales_order_item_no`, it.sales_order_item_no ?? '');
      addHidden(`items-${idx}-material_id`, it.material_id ?? '');
      addHidden(`items-${idx}-material_desc`, it.material_desc ?? '');
      addHidden(`items-${idx}-base_unit`, baseUnit);
      addHidden(`items-${idx}-unit`, it.unit ?? '');
      addHidden(`items-${idx}-storage_location`, it.storage_location ?? '');
      addHidden(`items-${idx}-order_quantity`, it.order_quantity ?? '0');
      addHidden(`items-${idx}-unshipped_quantity`, it.unshipped_quantity ?? '0');
    });
  }

  let debounceTimer = null;
  function triggerLoad() {
    const raw = (soInput.value || '').trim();
    if (!raw) {
      clearRows();
      orderDateInput.value = '';
      warehouseInput.value = '';
      requiredDeliveryInput.value = '';
      return;
    }
    const url = apiBase.replace('__SO__', encodeURIComponent(raw));
    itemsBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">加载中...</td></tr>`;
    fetch(url, { headers: { 'Accept': 'application/json' } })
      .then(r => r.json())
      .then(data => {
        if (!data.found) {
          itemsBody.innerHTML = `<tr><td colspan="8" class="text-center text-warning">未找到销售订单：${escapeHtml(raw)}</td></tr>`;
          hiddenContainer.innerHTML = '';
          orderDateInput.value = '';
          warehouseInput.value = '';
          requiredDeliveryInput.value = '';
          return;
        }

        // 自动填充仓库代码和日期
        warehouseInput.value = data.warehouse_code || '';
        orderDateInput.value = data.order_date || '';
        requiredDeliveryInput.value = data.required_delivery_date || '';


        buildRows(data.items || []);
      })
      .catch(err => {
        console.error(err);
        itemsBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">加载失败，请稍后重试</td></tr>`;
        hiddenContainer.innerHTML = '';
      });
  }

  ['change', 'blur', 'input'].forEach(evt =>
    soInput.addEventListener(evt, () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(triggerLoad, 300);
    })
  );

  // 页面初始如果已有销售订单号，自动加载
  if ((soInput.value || '').trim()) {
    triggerLoad();
  }
})();
</script>
{% endblock %}
