{% extends 'delivery/base.html' %}
{% block title %}æ–°å»ºå‘è´§å•{% endblock %}

{% block head_extra %}
<style>
  /* å¡ç‰‡ä¸æ ‡é¢˜å¢å¼º */
  .card {
    border: 1px solid rgba(34, 34, 34, 0.06);
    border-radius: 14px;
    overflow: hidden;
    background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(250,252,255,0.88));
  }

  /* è¾“å…¥ç»„å›¾æ ‡ä¸€è‡´æ€§ */
  .input-group-text {
    background: #f8fbff;
    border-color: rgba(34,34,34,0.08);
    color: #5b6b7a;
  }
  .form-control:focus {
    box-shadow: 0 0 0 .2rem rgba(11,110,240,0.12);
    border-color: rgba(11,110,240,0.3);
  }

  /* è¡¨æ ¼ç²˜æ€§è¡¨å¤´ä¸ç»†èŠ‚ */
  .table-zone {
    border: 1px solid rgba(34,34,34,0.06);
    border-radius: 12px;
    overflow: hidden;
  }
  .table-responsive.table-sticky {
    max-height: 56vh;
  }
  .table-sticky thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: #ffffff;
  }
  .table tbody tr:hover {
    background: rgba(13,110,253,0.03);
  }
  .table tfoot td {
    background: #fcfdff;
    font-weight: 600;
  }

  /* å·¥å…·æ æŒ‰é’® */
  .toolbar .btn {
    border-radius: 10px;
  }

  /* æ•°å€¼åˆ—ç»Ÿä¸€å³å¯¹é½ */
  .text-end-sm {
    text-align: right;
  }

  /* æäº¤åŒº */
  .card-footer {
    background: linear-gradient(90deg,#ffffff,#f7fbff);
    border-top: 1px solid rgba(34,34,34,0.06);
  }

  /* å°å±ä¼˜åŒ– */
  @media (max-width: 767.98px) {
    .table-responsive.table-sticky { max-height: 50vh; }
  }
</style>
{% endblock %}

{% block content %}
<div class="form-title-container">
    <h1 class="form-title">
      ğŸ“ å‘è´§å•åŸºæœ¬ä¿¡æ¯
    </h1>
  </div>

<div class="card shadow-sm mt-4">
  <div class="card-body">
    <form method="post" id="delivery-form" novalidate>
      {{ form.csrf_token }}

      <div class="row g-3">
        <div class="col-md-4">
          {{ form.sales_order_id.label(class="form-label") }}
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-receipt"></i></span>
            {{ form.sales_order_id(class="form-control", id="sales_order_id", placeholder="è¾“å…¥é”€å”®è®¢å•ç¼–å·") }}
            <span class="input-group-text bg-white" id="so-loading" style="display:none">
              <span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span>
            </span>
          </div>
          <div class="form-text">è¾“å…¥é”€å”®è®¢å•åè‡ªåŠ¨è½½å…¥è¡Œé¡¹ç›®ä¸æœªå‘æ•°é‡</div>
        </div>
        <div class="col-md-4">
          {{ form.expected_delivery_date.label(class="form-label") }}
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
            {{ form.expected_delivery_date(class="form-control", type="date") }}
          </div>
        </div>
        <div class="col-md-4">
          {{ form.warehouse_code.label(class="form-label") }}
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
            {{ form.warehouse_code(class="form-control", placeholder="é€‰æ‹©æˆ–è¾“å…¥ä»“åº“ä»£ç ") }}
          </div>
        </div>
      </div>

      <div class="mt-3">
        {{ form.remarks.label(class="form-label") }}
        {{ form.remarks(class="form-control", rows="2", placeholder="å¯å¡«å†™å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰") }}
      </div>

      <!-- å·¥å…·æ  -->
      <div class="d-flex align-items-center justify-content-between mt-4 toolbar flex-wrap gap-2">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-soft btn-sm" id="btn-fill-unshipped">
            <i class="bi bi-arrow-right-square"></i> å¡«å……æœªå‘ä¸ºè®¡åˆ’
          </button>
          <button type="button" class="btn btn-outline-soft btn-sm" id="btn-clear-plan">
            <i class="bi bi-eraser"></i> æ¸…ç©ºè®¡åˆ’
          </button>
        </div>
        <div class="text-muted small">
          å°æç¤ºï¼šè®¡åˆ’å‘è´§ â‰¤ æœªå‘æ•°é‡ï¼›å¯ç”¨ Tab/Enter å¿«é€Ÿå½•å…¥
        </div>
      </div>

      <!-- è¡¨æ ¼åŒºåŸŸ -->
      <div class="table-zone mt-3">
        <div class="table-responsive table-sticky">
          <table class="table table-sm table-bordered align-middle mb-0">
            <thead>
              <tr>
                <th style="width:80px">è¡Œå·</th>
                <th style="min-width:140px">ç‰©æ–™ç¼–å·</th>
                <th style="min-width:200px">ç‰©æ–™æè¿°</th>
                <th style="width:90px">å•ä½</th>
                <th class="text-end" style="width:120px">è®¢å•æ•°é‡</th>
                <th class="text-end" style="width:120px">æœªå‘æ•°é‡</th>
                <th class="text-end" style="width:140px">è®¡åˆ’å‘è´§</th>
              </tr>
            </thead>
            <tbody id="items-tbody">
              {% for item_form in form.items %}
              <tr>
                <td>
                  {{ item_form.sales_order_item_no(class="d-none") }}
                  <span class="form-text">{{ item_form.sales_order_item_no.data }}</span>
                </td>
                <td>{{ item_form.material_id(class="form-control form-control-sm", readonly=true) }}</td>
                <td>{{ item_form.material_desc(class="form-control form-control-sm", readonly=true) }}</td>
                <td>
                  <input type="text"
                         class="form-control form-control-sm"
                         value="{{ item_form.unit.data if item_form.unit else '' }}"
                         readonly>
                </td>
                <td>
                  {{ item_form.order_quantity(class="form-control form-control-sm text-end", readonly=true) }}
                </td>
                <td>
                  {{ item_form.unshipped_quantity(class="form-control form-control-sm text-end", readonly=true) }}
                </td>
                <td>
                  {{ item_form.planned_delivery_quantity(
                       class="form-control form-control-sm text-end planned-input",
                       step="0.01", min="0",
                       data_unshipped=item_form.unshipped_quantity.data if item_form.unshipped_quantity else 0) }}
                  <div class="invalid-feedback">è®¡åˆ’å‘è´§ä¸èƒ½è¶…è¿‡æœªå‘æ•°é‡</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <td colspan="6" class="text-end">åˆè®¡è®¡åˆ’å‘è´§ï¼š</td>
                <td class="text-end"><span id="total-planned">0</span></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="card-footer d-flex flex-wrap gap-2 justify-content-between align-items-center">
        <div class="text-muted small">
          æ ¡éªŒï¼šè‹¥å­˜åœ¨çº¢æ¡†å­—æ®µï¼Œè¯·æŒ‰æç¤ºä¿®æ­£åå†æäº¤
        </div>
        <div>
          {{ form.submit(class="btn btn-primary me-2", id="submit-btn") }}
          <a href="{{ url_for('delivery.delivery_home') }}" class="btn btn-outline-secondary">å–æ¶ˆ</a>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // é˜²æŠ–
  function debounce(fn, delay) {
    let timer = null;
    return function(...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  const soInput = document.getElementById('sales_order_id');
  const tbody   = document.getElementById('items-tbody');
  const soLoading = document.getElementById('so-loading');
  const totalSpan = document.getElementById('total-planned');
  const submitBtn = document.getElementById('submit-btn');
  const formEl = document.getElementById('delivery-form');

  // æ„å»ºå•å…ƒæ ¼ï¼šå¸¦ invalid-feedback
  function makeCellInput(idx, name, value, opts = {}) {
    const { readonly=false, type='text', step, min, classes='' } = opts;
    const td = document.createElement('td');

    const inp = document.createElement('input');
    inp.name = `items-${idx}-${name}`;
    inp.value = value ?? '';
    inp.type = type;
    if (readonly) inp.readOnly = true;
    if (step != null) inp.step = step;
    if (min != null)  inp.min = min;
    inp.className = `form-control form-control-sm ${classes}`.trim();

    td.appendChild(inp);

    // å¯¹è®¡åˆ’åˆ—è¿½åŠ  invalid-feedback å®¹å™¨
    if (name === 'planned_delivery_quantity') {
      const fb = document.createElement('div');
      fb.className = 'invalid-feedback';
      fb.textContent = 'è®¡åˆ’å‘è´§ä¸èƒ½è¶…è¿‡æœªå‘æ•°é‡';
      td.appendChild(fb);
    }
    return { td, input: inp };
  }

  // é‡å»º items è¡Œ
  function rebuildItems(items) {
    tbody.innerHTML = '';
    items.forEach((it, idx) => {
      const tr = document.createElement('tr');

      // è¡Œå· + hidden
      const tdNo = document.createElement('td');
      const hid = document.createElement('input');
      hid.name  = `items-${idx}-sales_order_item_no`;
      hid.value = it.sales_order_item_no ?? '';
      hid.type  = 'hidden';
      tdNo.appendChild(hid);
      tdNo.appendChild(document.createTextNode(it.sales_order_item_no ?? ''));
      tr.appendChild(tdNo);

      tr.appendChild(makeCellInput(idx, 'material_id', it.material_id, {readonly:true}).td);
      tr.appendChild(makeCellInput(idx, 'material_desc', it.material_desc, {readonly:true}).td);
      tr.appendChild(makeCellInput(idx, 'unit', it.unit, {readonly:true}).td);
      tr.appendChild(makeCellInput(idx, 'order_quantity', it.order_quantity, {readonly:true, classes:'text-end'}).td);
      tr.appendChild(makeCellInput(idx, 'unshipped_quantity', it.unshipped_quantity, {readonly:true, classes:'text-end'}).td);

      const { td: planTd, input: planInp } = makeCellInput(
        idx, 'planned_delivery_quantity', it.planned_delivery_quantity,
        { type:'number', step:'0.01', min:'0', classes:'text-end planned-input' }
      );
      // å­˜å‚¨æœªå‘æ•°é‡ç”¨äºæ ¡éªŒ
      planInp.dataset.unshipped = it.unshipped_quantity ?? '0';
      tr.appendChild(planTd);

      tbody.appendChild(tr);
    });
    attachRowBehaviors();
    updateTotalAndValidity();
  }

  // è‡ªåŠ¨åŠ è½½é”€å”®è®¢å•è¡Œ
  const autoLoad = debounce(async () => {
    const so = soInput.value.trim();
    if (!so) { rebuildItems([]); return; }
    try {
      soLoading.style.display = '';
      const res = await fetch(`/delivery/api/sales_orders/${encodeURIComponent(so)}`);
      const data = await res.json();
      if (data && data.found) rebuildItems(data.items || []);
      else rebuildItems([]);
    } catch (e) {
      rebuildItems([]);
    } finally {
      soLoading.style.display = 'none';
    }
  }, 450);

  soInput.addEventListener('input',  autoLoad);
  soInput.addEventListener('blur',   autoLoad);

  // è®¡ç®—åˆè®¡ + æ ¡éªŒ
  function updateTotalAndValidity() {
    let total = 0;
    let allValid = true;
    const inputs = tbody.querySelectorAll('.planned-input');
    inputs.forEach(inp => {
      const val = parseFloat(inp.value || '0');
      const unshipped = parseFloat(inp.dataset.unshipped || inp.closest('tr')?.querySelector('input[name*="unshipped_quantity"]')?.value || '0');
      const invalid = isNaN(val) || val < 0 || val > unshipped;
      if (!isNaN(val)) total += val;
      inp.classList.toggle('is-invalid', invalid);
      if (invalid) allValid = false;
    });
    totalSpan.textContent = Number.isFinite(total) ? total.toFixed(2) : '0.00';
    submitBtn.disabled = !allValid;
  }

  function attachRowBehaviors() {
    const inputs = tbody.querySelectorAll('.planned-input');
    inputs.forEach((inp, idx) => {
      // è¾“å…¥æ—¶æ ¡éªŒä¸åˆè®¡
      inp.addEventListener('input', updateTotalAndValidity);
      // Enter -> è·³åˆ°ä¸‹ä¸€è¡Œ
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const next = inputs[idx + 1];
          if (next) next.focus();
        }
      });
    });
  }

  // å·¥å…·æ ï¼šå¡«å……æœªå‘ä¸ºè®¡åˆ’
  document.getElementById('btn-fill-unshipped').addEventListener('click', () => {
    tbody.querySelectorAll('tr').forEach(tr => {
      const plan = tr.querySelector('.planned-input');
      const unshipped = parseFloat(
        plan?.dataset.unshipped ||
        tr.querySelector('input[name*="unshipped_quantity"]')?.value || '0'
      );
      if (plan) {
        plan.value = Number.isFinite(unshipped) ? unshipped : 0;
      }
    });
    updateTotalAndValidity();
  });

  // å·¥å…·æ ï¼šæ¸…ç©ºè®¡åˆ’
  document.getElementById('btn-clear-plan').addEventListener('click', () => {
    tbody.querySelectorAll('.planned-input').forEach(inp => inp.value = '');
    updateTotalAndValidity();
  });

  // åˆå§‹æŒ‚è½½ï¼ˆæœåŠ¡å™¨ç«¯é¦–å±æ¸²æŸ“çš„æ•°æ®ä¹Ÿå‚ä¸æ ¡éªŒï¼‰
  window.addEventListener('DOMContentLoaded', () => {
    // ç»™æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„è®¡åˆ’è¾“å…¥è¡¥å…… data-unshipped
    tbody.querySelectorAll('tr').forEach(tr => {
      const plan = tr.querySelector('.planned-input');
      const un = tr.querySelector('input[name*="unshipped_quantity"]');
      if (plan && un && !plan.dataset.unshipped) {
        plan.dataset.unshipped = un.value || '0';
      }
    });
    attachRowBehaviors();
    updateTotalAndValidity();
  });

  // æäº¤é˜²é‡å¤ + è§†è§‰åé¦ˆ
  formEl.addEventListener('submit', (e) => {
    updateTotalAndValidity();
    if (submitBtn.disabled) {
      e.preventDefault();
      return;
    }
    submitBtn.disabled = true;
    const original = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>æäº¤ä¸­â€¦';
    // å¯é€‰ï¼šè¶…æ—¶å›é€€
    setTimeout(() => {
      submitBtn.disabled = false;
      submitBtn.innerHTML = original;
    }, 12000);
  });
</script>
{% endblock %}
