{% extends 'delivery/base.html' %}
{% block title %}è¿‡è´¦å‘è´§åˆ—è¡¨{% endblock %}

{% block head_extra %}
<!-- å¼•å…¥é¡µé¢ä¸“ç”¨æ ·å¼æ–‡ä»¶ -->
<link rel="stylesheet" href="{{ url_for('static', filename='delivery/delivery_styles.css') }}">

<style>
  /* ===== å¸ƒå±€ä¸å®¹å™¨ ===== */
  .page-container {
    max-width: 1180px;
    margin: 0 auto;
    padding: 16px 16px 24px;
  }

  /* ===== å¡ç‰‡å®¹å™¨ä¸å¡ç‰‡å¤´éƒ¨ ===== */
  .delivery-card {
    width: 100%;
    background: #fff;
    border: 1px solid #eaecef;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(18, 38, 63, 0.06);
    overflow: hidden; /* åœ†è§’ä¸é˜´å½±é…åˆï¼Œé¿å…å†…å±‚æº¢å‡º */
  }
  .card-header {
    padding: 16px 18px 10px;
    border-bottom: 1px solid #eef1f5;
    background: linear-gradient(180deg, #fafbfd 0%, #ffffff 100%);
  }

  /* ===== å·¥å…·æ ï¼ˆæ ‡é¢˜ã€ç»Ÿè®¡ã€å¿«æ·æŒ‰é’®ï¼‰ ===== */
  .toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap; /* ä¿è¯å°å±ä¸æŒ¤å‹æ¢è¡Œ */
  }
  .toolbar .stats-info {
    color: #6b7280;
    font-size: 0.9rem;
  }

  /* ===== æŸ¥è¯¢è¡¨å•ä¸å…ƒç´  ===== */
  .query-form {
    padding: 12px 18px 4px;
  }
  .query-form .form-label {
    font-weight: 600;
    color: #374151;
  }
  .btn-search {
    background: #2563eb;
    border-color: #2563eb;
    color: #fff;
  }
  .btn-search:hover {
    background: #1e40af;
    border-color: #1e40af;
    color: #fff;
  }

  /* ===== åˆ—è¡¨è¡¨æ ¼åŒºåŸŸ ===== */
  .table-wrap {
    padding: 10px 12px 16px;
  }
  .table-responsive {
    max-height: 62vh; /* çºµå‘ç©ºé—´é™åˆ¶ï¼Œå¤´éƒ¨ sticky å¯ç”¨ */
    overflow: auto;
    border-radius: 10px;
    border: 1px solid #eef1f5;
  }
  .delivery-table {
    width: 100%;
    border-collapse: separate; /* å…è®¸ sticky ä¸åœ†è§’æ›´å¥½é…åˆ */
    border-spacing: 0;
  }
  .delivery-table thead th {
    position: sticky; /* å›ºå®šè¡¨å¤´ */
    top: 0;
    z-index: 2;
    background: #f8fafc;
    color: #374151;
    font-weight: 700;
    font-size: 0.92rem;
    border-bottom: 1px solid #e5e7eb;
    padding: 10px 12px;
    white-space: nowrap; /* é˜²æ­¢è¡¨å¤´æ¢è¡Œ */
  }
  .delivery-table tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid #f1f5f9;
    color: #1f2937;
    vertical-align: middle;
    white-space: nowrap; /* é¿å…æ•°æ®æ¢è¡Œå½±å“è¡Œé«˜ */
  }
  .delivery-table tbody tr:hover {
    background: #fafafa;
  }

  /* ===== å¾½ç« ä¸æ“ä½œæŒ‰é’® ===== */
  .badge {
    border-radius: 999px;
    padding: 0.35rem 0.6rem;
    font-weight: 600;
  }
  .btn-action {
    padding: 6px 10px;
    border-radius: 8px;
  }

  /* ===== ç©ºçŠ¶æ€å±•ç¤º ===== */
  .empty-state {
    text-align: center;
    color: #6b7280;
    height: 200px;
    vertical-align: middle;
  }
  .empty-state .inner {
    display: flex;
    height: 200px;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 6px;
  }

  /* ===== å“åº”å¼ä¼˜åŒ– ===== */
  @media (max-width: 768px) {
    .table-responsive { max-height: 60vh; }
    .btn-action { padding: 6px 8px; }
  }
</style>
{% endblock %}

{% block content %}
  <!-- é¡µæ ‡é¢˜ï¼ˆå¯å¤ç”¨é¡¹ç›®æ ·å¼ï¼‰ -->
  <div class="form-title-container">
    <h1 class="form-title">ğŸ“œ æ‰§è¡Œè¿‡è´¦</h1>
  </div>
  
<div class="page-container">
  <!-- ä¸»å¡ç‰‡ï¼šåŒ…å«å·¥å…·æ ã€æŸ¥è¯¢è¡¨å•ã€ç»“æœè¡¨æ ¼ -->
  <div class="delivery-card animate-fade">
    <div class="card-header">
      <!-- å·¥å…·æ ï¼šæ ‡é¢˜ + ç»Ÿè®¡ + å¿«æ·æ“ä½œ -->
      <div class="toolbar">
        <div>
          <i class="bi bi-list-ul me-2"></i>
          <strong>å¾…è¿‡è´¦å‘è´§å•åˆ—è¡¨</strong>
          <!-- ç»Ÿè®¡æ•°é‡ï¼šdeliveries å·²è¢«è§†å›¾å‡†å¤‡ä¸ºå¾…è¿‡è´¦é›†åˆ -->
          <span class="stats-info ms-3">å…±æ‰¾åˆ° {{ deliveries|length }} æ¡è®°å½•</span>
        </div>
        <div class="d-flex gap-2">
          <!-- æ–°å»ºå‘è´§å•å…¥å£ -->
          <a href="{{ url_for('delivery.create_delivery') }}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> æ–°å»ºå‘è´§å•
          </a>
          <!-- æ‰“å°å½“å‰é¡µé¢ -->
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> æ‰“å°
          </button>
        </div>
      </div>

      <!-- æŸ¥è¯¢è¡¨å•ï¼šæ”¯æŒæŒ‰å‘è´§å•å·ã€é”€å”®è®¢å•å·ã€æ—¥æœŸèŒƒå›´è¿‡æ»¤ -->
      <form method="post" class="row g-3 query-form align-items-end">
        {{ form.csrf_token }} <!-- CSRF é˜²æŠ¤ä»¤ç‰Œ -->

        <!-- å‘è´§å• IDï¼šå¸¦å°çª—é€‰æ‹© -->
        <div class="col-md-2">
            <label class="form-label" for="delivery_id">{{ form.delivery_id.label.text }}</label>
            <div class="input-group">
              {{ form.delivery_id(class="form-control", id="delivery_id") }}
              <!-- æ‰“å¼€å‘è´§å•é€‰æ‹©è¾…åŠ©å¼¹çª—ï¼ˆopenCentered éœ€å…¨å±€å®šä¹‰ï¼‰ -->
              <button type="button" class="btn btn-outline-secondary"
                      onclick="openCentered('{{ url_for('delivery.delivery_helper') }}', 'deliveryHelper', 800, 600)">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>

          <!-- é”€å”®è®¢å• IDï¼šå¸¦å°çª—é€‰æ‹© -->
          <div class="col-md-2">
            <label class="form-label" for="sales_order_id">{{ form.sales_order_id.label.text }}</label>
            <div class="input-group">
              {{ form.sales_order_id(class="form-control", id="sales_order_id") }}
              <!-- æ‰“å¼€é”€å”®è®¢å•é€‰æ‹©è¾…åŠ©å¼¹çª— -->
              <button type="button" class="btn btn-outline-secondary"
                      onclick="openCentered('{{ url_for('delivery.sales_helper') }}', 'salesHelper', 800, 600)">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>

        <!-- æ—¥æœŸèŒƒå›´ï¼šå¼€å§‹ -->
        <div class="col-md-2">
          {{ form.start_date.label(class="form-label") }}
          {{ form.start_date(class="form-control", type="date") }}
        </div>

        <!-- æ—¥æœŸèŒƒå›´ï¼šç»“æŸ -->
        <div class="col-md-2">
          {{ form.end_date.label(class="form-label") }}
          {{ form.end_date(class="form-control", type="date") }}
        </div>

        <!-- æäº¤æŒ‰é’® -->
        <div class="col-md-2">
          {{ form.submit(class="btn btn-search w-100") }}
        </div>
      </form>
    </div>

    <!-- ç»“æœè¡¨æ ¼åŒºåŸŸ -->
    <div class="table-wrap">
      <div class="table-responsive">
        <table class="delivery-table table-hover">
          <thead>
            <tr>
              <th>å‘è´§å•å·</th>
              <th>é”€å”®è®¢å•å·</th>
              <th>å‘è´§æ—¥æœŸ</th>
              <th>ä»“åº“ä»£ç </th>
              <th>çŠ¶æ€</th>
              <th>è¿‡è´¦äºº</th>
              <th>è¿‡è´¦æ—¶é—´</th>
              <th>å¤‡æ³¨</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {% for delivery in deliveries %}
            <tr>
              <!-- å‘è´§å•å·ï¼šè·³è½¬è¯¦æƒ…é¡µ -->
              <td>
                <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}"
                   class="text-decoration-none fw-bold text-primary">
                  {{ delivery.delivery_note_id }}
                </a>
              </td>

              <!-- å…³è”é”€å”®è®¢å•å· -->
              <td><span class="text-muted">{{ delivery.sales_order_id }}</span></td>

              <!-- å‘è´§æ—¥æœŸï¼šå…è®¸ä¸ºç©º -->
              <td>{{ delivery.delivery_date.strftime('%Y-%m-%d') if delivery.delivery_date else '-' }}</td>

              <!-- ä»“åº“ä»£ç ï¼šç”¨æµ…è‰²å¾½ç« å±•ç¤º -->
              <td><span class="badge bg-light text-dark">{{ delivery.warehouse_code }}</span></td>

              <!-- çŠ¶æ€ï¼šæ ¹æ®ä¸åŒçŠ¶æ€æ˜¾ç¤ºä¸åŒé¢œè‰² -->
              <td>
                <span class="badge
                  {% if delivery.status == 'å·²åˆ›å»º' %}bg-primary
                  {% elif delivery.status == 'å·²æ‹£è´§' %}bg-warning
                  {% elif delivery.status == 'å·²å‘è´§' %}bg-primary
                  {% elif delivery.status == 'å·²è¿‡è´¦' %}bg-success
                  {% elif delivery.status == 'å·²å–æ¶ˆ' %}bg-danger
                  {% else %}bg-secondary{% endif %}">
                  {{ delivery.status }}
                </span>
              </td>

              <!-- è¿‡è´¦äºº/æ—¶é—´/å¤‡æ³¨ï¼šä¸ºç©ºæ—¶æ˜¾ç¤º '-' -->
              <td><small class="text-muted">{{ delivery.posted_by or '-' }}</small></td>
              <td><small class="text-muted">{{ delivery.posted_at.strftime('%Y-%m-%d %H:%M') if delivery.posted_at else '-' }}</small></td>
              <td><small class="text-muted">{{ delivery.remarks or '-' }}</small></td>

              <!-- æ“ä½œæŒ‰é’®ï¼š
                   - å·²å‘è´§ï¼šå¯è¿›å…¥â€œè¿‡è´¦â€æ“ä½œ
                   - è¯¦æƒ…ï¼šæ€»æ˜¯å¯è§ -->
              <td>
                <div class="d-flex flex-wrap gap-1">
                  {% if delivery.status == 'å·²å‘è´§' %}
                    <a href="{{ url_for('delivery.post_delivery', delivery_id=delivery.delivery_note_id) }}"
                       class="btn btn-outline-success btn-action" title="å»è¿‡è´¦">
                      <i class="bi bi-journal-check"></i>
                    </a>
                  {% endif %}
                  <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}"
                     class="btn btn-outline-secondary btn-action" title="è¯¦æƒ…">
                    <i class="bi bi-eye"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% else %}
            <!-- å½“ deliveries ä¸ºç©ºæ—¶çš„å ä½è¡Œ -->
            <tr>
              <td colspan="9" class="empty-state">
                <div class="inner">
                  <i class="bi bi-inbox display-5 d-block mb-1"></i>
                  <h5 class="mb-1">æš‚æ— å¾…è¿‡è´¦çš„å‘è´§å•</h5>
                  <p class="text-muted mb-0">å·²å‘è´§ä½†æœªè¿‡è´¦çš„è®°å½•ä¼šå‡ºç°åœ¨è¿™é‡Œã€‚</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  /**
   * è‡ªåŠ¨å…³é—­å¸¦å…³é—­æŒ‰é’®çš„ Bootstrap Alert
   * - 5 ç§’åä¾æ¬¡å…³é—­é¡µé¢ä¸Šæ‰€æœ‰ .alert-dismissible
   */
  setTimeout(() => {
    document.querySelectorAll('.alert-dismissible').forEach(alert => {
      new bootstrap.Alert(alert).close();
    });
  }, 5000);

  /**
   * è¡Œç‚¹å‡»è·³è½¬é€»è¾‘ï¼š
   * - ç‚¹å‡»ä¸€è¡Œæ—¶ï¼Œå¦‚æœæœªç‚¹å‡»åˆ° aã€buttonã€form ç­‰äº¤äº’å…ƒç´ ï¼Œåˆ™è·³è½¬åˆ°è¡Œå†…â€œè¯¦æƒ…â€é“¾æ¥
   * - ä¾¿äºæ•´è¡Œå¯ç‚¹å‡»çš„æµè§ˆä½“éªŒ
   */
  document.querySelectorAll('tbody tr').forEach(row => {
    row.addEventListener('click', e => {
      // å¿½ç•¥åœ¨é“¾æ¥ã€æŒ‰é’®ã€æˆ–è¡¨å•ä¸Šçš„ç‚¹å‡»ï¼Œé¿å…å†²çª
      if (e.target.closest('a, button, form')) return;
      // æ‰¾åˆ°è¯¥è¡Œä¸­çš„è¯¦æƒ…é“¾æ¥ï¼ˆåŒ…å« delivery_detail çš„é“¾æ¥ï¼‰
      const link = row.querySelector('a[href*="delivery_detail"]');
      if (link) window.location.href = link.href;
    });
  });
</script>
{% endblock %}
