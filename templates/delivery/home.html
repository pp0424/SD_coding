{% extends 'delivery/base.html' %}

{% block title %}发货管理首页{% endblock %}

{% block head_extra %}
<!-- 图表库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- 地图库 -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
  body {
    margin: 0;
    font-family: "Microsoft YaHei", sans-serif;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  h3.page-title { font-weight: 700; color: #0d6efd; }
  .card {
    border-radius: 14px;
    background: linear-gradient(135deg, #ffffff, #f5f9ff);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
  }
  /* 四核指标卡片样式 */
  .kpi-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .kpi-card {
    text-align: center;
    padding: 8px;
    border-radius: 12px;
    color: white;
    height: 90px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: transform 0.2s ease;
  }
  .kpi-card:hover { transform: scale(1.05); }
  .kpi-icon { font-size: 1.2rem; margin-bottom: 4px; }
  .kpi-delivery   { background: linear-gradient(135deg, #b9d9f5, #9e60f5); }
  .kpi-pending    { background: linear-gradient(135deg, #efae5e, #e0d49c); }
  .kpi-created    { background: linear-gradient(135deg, #6d51f7, #7c9bf1); }
  .kpi-picked     { background: linear-gradient(135deg, #e189f5, #e57f7f); }
  .kpi-shipped    { background: linear-gradient(135deg, #9f8bef, #78aeca); }
  .kpi-posted     { background: linear-gradient(135deg, #6a11cb, #2575fc); }
  .kpi-cancelled  { background: linear-gradient(135deg, #a4c5fa, #e68ff2); }
  .kpi-on-time    { background: linear-gradient(135deg, #e16262, #b8f5f2); }
  .kpi-late       { background: linear-gradient(135deg, #ff9966, #ff5e62); }
  .trend-up { color: #28a745; }
  .trend-down { color: #dc3545; }

  /* 地图容器 */
  #warehouse-map {
    width: 100%;
    height: 400px;
    border-radius: 8px;
    overflow: hidden;
    background: #1e2a38;
  }

  /* 仓库标记弹出窗口样式 */
  .warehouse-popup .leaflet-popup-content { min-width: 200px; font-size: 14px; }
  .warehouse-popup h4 {
    margin-top: 0; color: #0d6efd; border-bottom: 1px solid #eee; padding-bottom: 5px;
  }
  .warehouse-popup .stats { margin-top: 10px; }
  .warehouse-popup .stat-item {
    display: flex; justify-content: space-between; margin-bottom: 5px;
  }
  .warehouse-popup .stat-value { font-weight: bold; }

  /* 响应式调整 */
  @media (max-width: 992px) { .kpi-container { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 576px) { .kpi-container { grid-template-columns: 1fr; } }

  .card:hover { transform: scale(1.01); }
  .card-title { font-weight: 600; color: #34495e; }
  .card-text { font-size: 0.95rem; color: #6c757d; }
  .btn-sm { font-size: 0.85rem; border-radius: 8px; }
  .list-group-item a { text-decoration: none; color: #0d6efd; font-weight: 500; }
  .list-group-item:hover { background-color: #f7faff; }
  .table-sm thead { background-color: #eef4ff; font-size: 0.85rem; }
  .table-sm td { font-size: 0.85rem; vertical-align: middle; }
  .table-sm tbody tr:hover { background-color: #f0f8ff; transition: background-color 0.2s ease; }
  .text-danger { font-weight: bold; }
  hr { border-top: 1px solid #dee2e6; }

  /* Workflow container */
  .workflow-steps {
    display: flex; flex-wrap: nowrap; justify-content: flex-start; align-items: center;
    gap: 12px; overflow-x: auto; padding: 8px; scrollbar-width: thin; margin-bottom:30px;
  }
  .workflow-steps::-webkit-scrollbar { height: 6px; }
  .workflow-steps::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
  .workflow-steps .step-card {
    flex: 0 0 auto; min-width: 150px; max-width: 200px; padding: 15px 10px; border-radius: 12px;
    text-align: center; transition: all 0.3s ease; background: linear-gradient(135deg, #f580d0, #77a1f5);
    color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
</style>
{% endblock %}

{% block content %}
<div class="form-title-container">
  <h1 class="form-title"> 🚚 发货管理首页 </h1>
</div>

<div class="kpi-container">
  <!-- 今日发货量 -->
  <div class="kpi-card kpi-delivery">
    <div class="kpi-icon">🚚</div>
    <div class="kpi-title">今日发货量</div>
    <div class="kpi-value">{{ today_delivery_count }}</div>
  </div>

  <!-- 待处理订单 -->
  <div class="kpi-card kpi-pending">
    <div class="kpi-icon">📦</div>
    <div class="kpi-title">待处理订单</div>
    <div class="kpi-value">{{ pending_orders }}</div>
  </div>

  <!-- 已创建 -->
  <div class="kpi-card kpi-created">
    <div class="kpi-icon">📝</div>
    <div class="kpi-title">已创建</div>
    <div class="kpi-value">{{ status_counts['已创建'] }}</div>
  </div>

  <!-- 已拣货 -->
  <div class="kpi-card kpi-picked">
    <div class="kpi-icon">🛒</div>
    <div class="kpi-title">已拣货</div>
    <div class="kpi-value">{{ status_counts['已拣货'] }}</div>
  </div>

  <!-- 已发货 -->
  <div class="kpi-card kpi-shipped">
    <div class="kpi-icon">📤</div>
    <div class="kpi-title">已发货</div>
    <div class="kpi-value">{{ status_counts['已发货'] }}</div>
  </div>

  <!-- 已过账 -->
  <div class="kpi-card kpi-posted">
    <div class="kpi-icon">✅</div>
    <div class="kpi-title">已过账</div>
    <div class="kpi-value">{{ status_counts['已过账'] }}</div>
  </div>

  <!-- 已取消 -->
  <div class="kpi-card kpi-cancelled">
    <div class="kpi-icon">❌</div>
    <div class="kpi-title">已取消</div>
    <div class="kpi-value">{{ status_counts['已取消'] }}</div>
  </div>

  <!-- 准时发货率 -->
  <div class="kpi-card kpi-on-time">
    <div class="kpi-icon">⏱</div>
    <div class="kpi-title">准时发货率</div>
    <div class="kpi-value">{{ on_time_rate }}%</div>
  </div>

  <!-- 延迟发货率 -->
  <div class="kpi-card kpi-late">
    <div class="kpi-icon">🐌</div>
    <div class="kpi-title">延迟发货率</div>
    <div class="kpi-value">{{ late_rate }}%</div>
  </div>
</div>


<div class="workflow-steps animate-fade">
  <div class="step-card" style="background: linear-gradient(135deg, #358df9dd, #ee39ff);">发货流程</div>
  <div class="step-arrow">👉</div>
  <a href="{{ url_for('delivery.create_delivery') }}">
    <div class="step-card">创建发货</div>
  </a>
  <div class="step-arrow">👉</div>
  <a href="{{ url_for('delivery.picking_task_list') }}">
    <div class="step-card">拣货</div>
  </a>
  <div class="step-arrow">👉</div>
  <a href="{{ url_for('delivery.inventory_movement') }}">
    <div class="step-card">库存变动查询</div>
  </a>
  <div class="step-arrow">👉</div>
  <a href="{{ url_for('delivery.shipment_list') }}">
    <div class="step-card">发货</div>
  </a>
  <div class="step-arrow">👉</div>
  <a href="{{ url_for('delivery.inventory_movement') }}">
    <div class="step-card">库存变动查询</div>
  </a>
  <div class="step-arrow">👉</div>
  <a href="{{ url_for('delivery.post_list') }}">
    <div class="step-card">过账</div>
  </a>
  <div class="step-arrow">👉</div>
  <a href="{{ url_for('delivery.inventory_movement') }}">
    <div class="step-card">库存变动查询</div>
  </a>
</div>

<!-- 仓储地图区域 -->
<h5 class="fw-bold mb-3">🏭 仓储分布图</h5>
<div id="warehouse-map"></div>
<hr class="my-4">
{%endblock%}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // 从后端注入数据（确保后端传了 all_warehouses）
  const provincesData = {{ warehouses | tojson | safe }} || [];
  const allWarehouses = {{ all_warehouses | tojson | safe }} || [];

  const chinaBounds = L.latLngBounds([3.85, 73.66], [53.55, 135.05]);
  const map = L.map('warehouse-map').setView([35.0, 105.0], 4);

  L.tileLayer(
    'https://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}',
    { attribution: '高德地图', maxZoom: 18 }
  ).addTo(map);
  map.setMaxBounds(chinaBounds);

  // 修复在某些布局下 Leaflet 容器尺寸计算错误的问题
  map.whenReady(function() {
    setTimeout(function(){ map.invalidateSize(); }, 200);
  });

  let markerGroup = L.featureGroup().addTo(map);

  function calcRadius(stock) {
    stock = Number(stock) || 0;
    if (stock <= 0) return 6;
    // log 计算确保随着数量增加半对数增长
    return Math.max(6, Math.log10(stock + 1) * 6);
  }

function renderPoints(data, level = 'province') {
  // 清空旧图层
  markerGroup.clearLayers();

  // 计算最大库存，用于颜色渐变（可选）
  const maxStock = Math.max(...data.map(w => Number(w.stock) || 0), 1);

  // 颜色映射函数
  function getColorByStock(stock) {
    stock = Number(stock) || 0;
    if (stock <= 0) return '#999';          // 无库存灰色
    else if (stock < 100) return '#00bfff'; // 蓝
    else if (stock < 1000) return '#32cd32'; // 绿
    else if (stock < 2000) return '#ffa500'; // 橙
    else if (stock < 3000) return '#ff8c00'; // 深橙
    else if (stock < 4000) return '#ff6347'; // 番茄红
    else if (stock < 5000) return '#ff4500'; // 橘红
    else if (stock < 6000) return '#ff0000'; // 红
    else return '#8b0000'; // 深红
  }

  // 半径计算函数
  function calcRadius(stock) {
    stock = Number(stock) || 0;
    if (stock <= 0) return 4;                  // 最小半径更小
    return Math.max(4, Math.log10(stock + 1) * 3); // 放大系数改成3，点不会太大
  }
  data.forEach((w) => {
    if (w.lat == null || w.lng == null) return;
    const stock = Number(w.stock) || 0;
    const available = Number(w.available) || 0;

    let popupHtml;
    if (level === 'province') {
      popupHtml = `
        <div class="warehouse-popup">
          <h4>${w.name}</h4>
          <div>库存总量: ${stock.toLocaleString()}</div>
          <div>可用库存量: ${available.toLocaleString()}</div>
        </div>
      `;
    } else {
      popupHtml = `
        <div class="warehouse-popup">
          <h4>${w.name}</h4>
          <div>库区/仓库: ${w.name}</div>
          <div>库存总量: ${stock.toLocaleString()}</div>
          <div>可用库存: ${available.toLocaleString()}</div>
        </div>
      `;
    }

    // 创建圆点，大小 + 颜色随库存量变化
    const marker = L.circleMarker([w.lat, w.lng], {
      radius: calcRadius(stock),
      fillColor: getColorByStock(stock),
      color: '#fff',
      weight: 1,
      fillOpacity: 0.9
    }).bindPopup(popupHtml);

    markerGroup.addLayer(marker);
  });

  if (markerGroup.getLayers().length > 0) {
    map.fitBounds(markerGroup.getBounds().pad(0.12));
  } else {
    map.setView([35.0, 105.0], 4);
  }
}

// 渲染省级数据
renderPoints(provincesData, 'province');

  // 点击省份 → 本地过滤仓库
  window.loadProvinceDetails = function (provinceName) {
    // 防止 undefined
    if (!Array.isArray(allWarehouses)) return;
    const provincePoints = allWarehouses
      .filter(w => w.province === provinceName && w.lat != null && w.lng != null);

    renderPoints(provincePoints, 'warehouse');
  };

});
</script>

{% endblock %}


