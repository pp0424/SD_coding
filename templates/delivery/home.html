{% extends 'delivery/base.html' %}

{# é¡µé¢æ ‡é¢˜å—ï¼šåœ¨ base æ¨¡æ¿ä¸­å¡«å…… title #}
{% block title %}å‘è´§ç®¡ç†é¦–é¡µ{% endblock %}

{% block head_extra %}
<!-- å¼•å…¥ç¬¬ä¸‰æ–¹åº“ï¼šChart.jsï¼ˆå›¾è¡¨ï¼‰ã€Leafletï¼ˆåœ°å›¾ï¼‰ã€Leaflet Heatï¼ˆçƒ­åŠ›å›¾æ‹“å±•ï¼‰ -->
<!-- è¿™äº›è„šæœ¬/æ ·å¼ä¼šåœ¨é¡µé¢ head åŒºåŸŸå¼•å…¥ï¼Œç¡®ä¿åœ°å›¾ä¸å›¾è¡¨åŠŸèƒ½å¯ç”¨ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
  /* å…¨å±€é¡µé¢æ ·å¼ */
  body {
    margin: 0;
    font-family: "Microsoft YaHei", sans-serif;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  /* é¡µé¢ä¸»æ ‡é¢˜æ ·å¼ */
  h3.page-title { font-weight: 700; color: #0d6efd; }

  /* å¡ç‰‡åŸºæ ·å¼ï¼ˆä¾› KPI å¡ã€æµç¨‹å¡ç­‰å¤ç”¨ï¼‰ */
  .card {
    border-radius: 14px;
    background: linear-gradient(135deg, #ffffff, #f5f9ff);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
  }

  /* KPI å®¹å™¨ï¼šä½¿ç”¨ css gridï¼Œè‡ªåŠ¨é€‚é…åˆ—æ•° */
  .kpi-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  /* KPI å¡ç‰‡ï¼šå‚ç›´å¸ƒå±€ï¼Œå±…ä¸­æ˜¾ç¤ºå†…å®¹ */
  .kpi-card {
    text-align: center;
    padding: 8px;
    border-radius: 12px;
    color: white;
    height: 90px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: transform 0.2s ease;
  }
  .kpi-card:hover { transform: scale(1.05); }
  .kpi-icon { font-size: 1.2rem; margin-bottom: 4px; }

  /* ä¸åŒ KPI å¡ç‰‡çš„æ¸å˜ä¸»é¢˜è‰²ï¼ˆä¾¿äºè§†è§‰åˆ†ç±»ï¼‰ */
  .kpi-delivery   { background: linear-gradient(135deg, #b9d9f5, #9e60f5); }
  .kpi-pending    { background: linear-gradient(135deg, #efae5e, #e0d49c); }
  .kpi-created    { background: linear-gradient(135deg, #6d51f7, #7c9bf1); }
  .kpi-picked     { background: linear-gradient(135deg, #e189f5, #e57f7f); }
  .kpi-shipped    { background: linear-gradient(135deg, #9f8bef, #78aeca); }
  .kpi-posted     { background: linear-gradient(135deg, #6a11cb, #2575fc); }
  .kpi-cancelled  { background: linear-gradient(135deg, #a4c5fa, #e68ff2); }
  .kpi-on-time    { background: linear-gradient(135deg, #e16262, #b8f5f2); }
  .kpi-late       { background: linear-gradient(135deg, #ff9966, #ff5e62); }

  /* ä¸Šå‡/ä¸‹é™è¶‹åŠ¿é¢œè‰²ç±»ï¼ˆå¯åœ¨æœªæ¥æ˜¾ç¤ºç™¾åˆ†æ¯”å˜åŒ–æ—¶ä½¿ç”¨ï¼‰ */
  .trend-up { color: #28a745; }
  .trend-down { color: #dc3545; }

  /* åœ°å›¾å®¹å™¨æ ·å¼ï¼Œç»™ Leaflet å®¹å™¨é«˜åº¦å’Œåœ†è§’ */
  #warehouse-map {
    width: 100%;
    height: 400px;
    border-radius: 8px;
    overflow: hidden;
    background: #1e2a38;
  }

  /* ä»“åº“å¼¹çª—å†…å®¹æ ·å¼ï¼šæé«˜å¯è¯»æ€§ */
  .warehouse-popup .leaflet-popup-content { min-width: 200px; font-size: 14px; }
  .warehouse-popup h4 {
    margin-top: 0; color: #0d6efd; border-bottom: 1px solid #eee; padding-bottom: 5px;
  }
  .warehouse-popup .stats { margin-top: 10px; }
  .warehouse-popup .stat-item {
    display: flex; justify-content: space-between; margin-bottom: 5px;
  }
  .warehouse-popup .stat-value { font-weight: bold; }

  /* å“åº”å¼å¸ƒå±€ï¼šä¸­å°å±æ—¶è°ƒæ•´ KPI åˆ—æ•° */
  @media (max-width: 992px) { .kpi-container { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 576px) { .kpi-container { grid-template-columns: 1fr; } }

  .card:hover { transform: scale(1.01); }
  .card-title { font-weight: 600; color: #34495e; }
  .card-text { font-size: 0.95rem; color: #6c757d; }
  .btn-sm { font-size: 0.85rem; border-radius: 8px; }
  .list-group-item a { text-decoration: none; color: #0d6efd; font-weight: 500; }
  .list-group-item:hover { background-color: #f7faff; }
  .table-sm thead { background-color: #eef4ff; font-size: 0.85rem; }
  .table-sm td { font-size: 0.85rem; vertical-align: middle; }
  .table-sm tbody tr:hover { background-color: #f0f8ff; transition: background-color 0.2s ease; }
  .text-danger { font-weight: bold; }
  hr { border-top: 1px solid #dee2e6; }

  /* å·¥ä½œæµæ¨ªå‘æ­¥éª¤æ¡ï¼šå…è®¸æ¨ªå‘æ»šåŠ¨ä»¥é€‚é…çª„å± */
  .workflow-steps {
    display: flex; flex-wrap: nowrap; justify-content: flex-start; align-items: center;
    gap: 12px; overflow-x: auto; padding: 8px; scrollbar-width: thin; margin-bottom:30px;
  }
  .workflow-steps::-webkit-scrollbar { height: 6px; }
  .workflow-steps::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }

  /* å•ä¸ªæ­¥éª¤å¡ç‰‡æ ·å¼ï¼šç”¨äºâ€œåˆ›å»º->æ‹£è´§->å‘è´§â€ç­‰æ˜¾ç¤º */
  .workflow-steps .step-card {
    flex: 0 0 auto; min-width: 150px; max-width: 200px; padding: 15px 10px; border-radius: 12px;
    text-align: center; transition: all 0.3s ease; background: linear-gradient(135deg, #f580d0, #77a1f5);
    color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
</style>
{% endblock %}

{% block content %}
{# é¡µé¢ä¸»æ ‡é¢˜ï¼šå±•ç¤ºåœ¨é¡µé¢é¡¶éƒ¨ #}
<div class="form-title-container">
  <h1 class="form-title"> ğŸšš å‘è´§ç®¡ç†é¦–é¡µ </h1>
</div>

{# KPI åŒºåŸŸï¼šå°†åç«¯æ³¨å…¥çš„å˜é‡æ¸²æŸ“åˆ°ä¸åŒå¡ç‰‡ä¸­
   é‡è¦å˜é‡è¯´æ˜ï¼ˆç”±åç«¯ä¼ å…¥ï¼‰ï¼š
   - today_delivery_count: ä»Šæ—¥å‘è´§é‡ï¼ˆæ•´æ•°ï¼‰
   - pending_orders: å¾…å¤„ç†è®¢å•æ•°ï¼ˆæ•´æ•°ï¼‰
   - status_counts: å­—å…¸/æ˜ å°„ï¼ŒåŒ…å«ä¸åŒçŠ¶æ€çš„è®¡æ•°ï¼Œä¾‹å¦‚ status_counts['å·²åˆ›å»º'] ç­‰
   - on_time_rate: å‡†æ—¶å‘è´§ç‡ï¼ˆç™¾åˆ†æ¯”æ•°å€¼ï¼Œä¸å¸¦ % ç¬¦å·ï¼‰
   - late_rate: å»¶è¿Ÿå‘è´§ç‡ï¼ˆç™¾åˆ†æ¯”æ•°å€¼ï¼‰
#}
<div class="kpi-container">
  <!-- ä»Šæ—¥å‘è´§é‡ -->
  <div class="kpi-card kpi-delivery">
    <div class="kpi-icon">ğŸšš</div>
    <div class="kpi-title">ä»Šæ—¥å‘è´§é‡</div>
    <div class="kpi-value">{{ today_delivery_count }}</div>
  </div>

  <!-- å¾…å¤„ç†è®¢å• -->
  <div class="kpi-card kpi-pending">
    <div class="kpi-icon">ğŸ“¦</div>
    <div class="kpi-title">å¾…å¤„ç†è®¢å•</div>
    <div class="kpi-value">{{ pending_orders }}</div>
  </div>

  <!-- å·²åˆ›å»º -->
  <div class="kpi-card kpi-created">
    <div class="kpi-icon">ğŸ“</div>
    <div class="kpi-title">å·²åˆ›å»º</div>
    <div class="kpi-value">{{ status_counts['å·²åˆ›å»º'] }}</div>
  </div>

  <!-- å·²æ‹£è´§ -->
  <div class="kpi-card kpi-picked">
    <div class="kpi-icon">ğŸ›’</div>
    <div class="kpi-title">å·²æ‹£è´§</div>
    <div class="kpi-value">{{ status_counts['å·²æ‹£è´§'] }}</div>
  </div>

  <!-- å·²å‘è´§ -->
  <div class="kpi-card kpi-shipped">
    <div class="kpi-icon">ğŸ“¤</div>
    <div class="kpi-title">å·²å‘è´§</div>
    <div class="kpi-value">{{ status_counts['å·²å‘è´§'] }}</div>
  </div>

  <!-- å·²è¿‡è´¦ -->
  <div class="kpi-card kpi-posted">
    <div class="kpi-icon">âœ…</div>
    <div class="kpi-title">å·²è¿‡è´¦</div>
    <div class="kpi-value">{{ status_counts['å·²è¿‡è´¦'] }}</div>
  </div>

  <!-- å·²å–æ¶ˆ -->
  <div class="kpi-card kpi-cancelled">
    <div class="kpi-icon">âŒ</div>
    <div class="kpi-title">å·²å–æ¶ˆ</div>
    <div class="kpi-value">{{ status_counts['å·²å–æ¶ˆ'] }}</div>
  </div>

  <!-- å‡†æ—¶å‘è´§ç‡ -->
  <div class="kpi-card kpi-on-time">
    <div class="kpi-icon">â±</div>
    <div class="kpi-title">å‡†æ—¶å‘è´§ç‡</div>
    <div class="kpi-value">{{ on_time_rate }}%</div>
  </div>

  <!-- å»¶è¿Ÿå‘è´§ç‡ -->
  <div class="kpi-card kpi-late">
    <div class="kpi-icon">ğŸŒ</div>
    <div class="kpi-title">å»¶è¿Ÿå‘è´§ç‡</div>
    <div class="kpi-value">{{ late_rate }}%</div>
  </div>
</div>

{# æ¨ªå‘æµç¨‹æ¡ï¼šå¯¼èˆªåˆ°å„ä¸ªå¸¸ç”¨é¡µé¢ï¼ˆä½¿ç”¨ url_for ç”Ÿæˆè·¯ç”±ï¼‰ #}
<div class="workflow-steps animate-fade">
  <div class="step-card" style="background: linear-gradient(135deg, #358df9dd, #ee39ff);">å‘è´§æµç¨‹</div>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.create_delivery') }}">
    <div class="step-card">åˆ›å»ºå‘è´§</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.picking_task_list') }}">
    <div class="step-card">æ‹£è´§</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.inventory_movement') }}">
    <div class="step-card">åº“å­˜å˜åŠ¨æŸ¥è¯¢</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.shipment_list') }}">
    <div class="step-card">å‘è´§</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.inventory_movement') }}">
    <div class="step-card">åº“å­˜å˜åŠ¨æŸ¥è¯¢</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.post_list') }}">
    <div class="step-card">è¿‡è´¦</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.inventory_movement') }}">
    <div class="step-card">åº“å­˜å˜åŠ¨æŸ¥è¯¢</div>
  </a>
</div>

{# åœ°å›¾åŒºåŸŸæ ‡é¢˜ä¸å®¹å™¨ï¼ˆLeaflet åœ°å›¾ä¼šæŒ‚è½½åˆ° #warehouse-mapï¼‰ #}
<h5 class="fw-bold mb-3">ğŸ­ ä»“å‚¨åˆ†å¸ƒå›¾</h5>
<div id="warehouse-map"></div>
<hr class="my-4">
{%endblock%}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // ==== ä»åç«¯æ³¨å…¥çš„æ•°æ®å˜é‡è¯´æ˜ ====
  // provincesData: çœ/åŒºåŸŸçº§åˆ«çš„æ±‡æ€»ç‚¹æ•°ç»„ï¼ˆç”¨äºå±•ç¤ºçœçº§è§†å›¾ï¼‰
  //   æ¯ä¸ªå…ƒç´ ç»“æ„ç¤ºä¾‹ï¼š{ "lat": 25.04, "lng": 102.71, "name": "WH-äº‘å—çœ", "stock": 2544, "available":71 }
  // allWarehouses: æ‰€æœ‰ä»“åº“çš„è¯¦ç»†ç‚¹æ•°ç»„ï¼ˆç”¨äºç‚¹å‡»çœä»½åå±•ç¤ºç«™ç‚¹çº§åˆ«ï¼‰
  //   æ¯ä¸ªå…ƒç´ åº”åŒ…å« province å­—æ®µä»¥ä¾¿æŒ‰çœè¿‡æ»¤ï¼š { "province": "äº‘å—çœ", "lat":..., "lng":..., "name":..., "stock":..., "available":... }
  const provincesData = {{ warehouses | tojson | safe }} || [];
  const allWarehouses = {{ all_warehouses | tojson | safe }} || [];

  // ==== åœ°å›¾åˆå§‹åŒ–ä¸è¾¹ç•Œé™åˆ¶ ====
  // chinaBounds ç”¨äºé™åˆ¶åœ°å›¾ç¼©æ”¾ä¸æ‹–æ‹½çš„è¾¹ç•Œï¼Œé¿å…ç”¨æˆ·æ‹–å‡ºåœ°å›¾è¿‡è¿œ
  const chinaBounds = L.latLngBounds([3.85, 73.66], [53.55, 135.05]);
  // åˆ›å»ºåœ°å›¾å¹¶è®¾ç½®é»˜è®¤è§†ç‚¹ä¸ºä¸­å›½ä¸­å¿ƒé™„è¿‘
  const map = L.map('warehouse-map').setView([35.0, 105.0], 4);

  // ä½¿ç”¨é«˜å¾·åœ°å›¾ç“¦ç‰‡
  L.tileLayer(
    'https://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}',
    { attribution: 'é«˜å¾·åœ°å›¾', maxZoom: 18 }
  ).addTo(map);

  map.setMaxBounds(chinaBounds);

  // ä¿®å¤åœ¨æŸäº›å¸ƒå±€ä¸‹ Leaflet å®¹å™¨å°ºå¯¸è®¡ç®—é”™è¯¯çš„é—®é¢˜ï¼ˆå¸¸è§äºéšè—æˆ–å¼¹å‡ºå®¹å™¨ï¼‰
  map.whenReady(function() {
    // å»¶è¿Ÿè§¦å‘ invalidateSizeï¼Œç¡®ä¿åœ°å›¾æ¸²æŸ“æ­£ç¡®
    setTimeout(function(){ map.invalidateSize(); }, 200);
  });

  // ä½¿ç”¨ä¸€ä¸ª featureGroup æ¥ç»Ÿä¸€ç®¡ç†ç‚¹å›¾å±‚ï¼Œæ–¹ä¾¿æ¸…ç©º/fitBounds ç­‰æ“ä½œ
  let markerGroup = L.featureGroup().addTo(map);

  // åŠå¯¹æ•°åŠå¾„è®¡ç®—ï¼ˆç¤ºä¾‹å®ç°ï¼‰
  function calcRadius(stock) {
    stock = Number(stock) || 0;
    if (stock <= 0) return 6;
    // log è®¡ç®—ç¡®ä¿éšç€æ•°é‡å¢åŠ åŠå¯¹æ•°å¢é•¿
    return Math.max(6, Math.log10(stock + 1) * 6);
  }

  // æ¸²æŸ“ç‚¹é›†åˆçš„ä¸»å‡½æ•°
  // å‚æ•° data: ç‚¹æ•°ç»„ï¼Œ level: 'province' æˆ– 'warehouse' ï¼ˆå†³å®šå¼¹çª—å†…å®¹ï¼‰
  function renderPoints(data, level = 'province') {
    // æ¸…ç©ºæ—§å›¾å±‚ï¼ˆé¿å…é‡å¤æ¸²æŸ“ï¼‰
    markerGroup.clearLayers();

    // è®¡ç®—æœ€å¤§åº“å­˜ï¼Œç”¨äºå°†æ¥åšåŸºäºæœ€å¤§å€¼çš„æ¸å˜æ¯”ä¾‹ï¼ˆå½“å‰å®ç°ç”¨ç¦»æ•£åˆ†æ®µï¼‰
    const maxStock = Math.max(...data.map(w => Number(w.stock) || 0), 1);

    // é¢œè‰²æ˜ å°„å‡½æ•°ï¼šæ ¹æ®åº“å­˜é‡è¿”å›å¯¹åº”é¢œè‰²ï¼ˆå¯æ ¹æ®éœ€æ±‚è°ƒæ•´åˆ†æ®µé˜ˆå€¼ï¼‰
    function getColorByStock(stock) {
      stock = Number(stock) || 0;
      if (stock <= 0) return '#999';          // æ— åº“å­˜ç°è‰²
      else if (stock < 100) return '#00bfff'; // è“
      else if (stock < 1000) return '#32cd32'; // ç»¿
      else if (stock < 2000) return '#ffa500'; // æ©™
      else if (stock < 3000) return '#ff8c00'; // æ·±æ©™
      else if (stock < 4000) return '#ff6347'; // ç•ªèŒ„çº¢
      else if (stock < 5000) return '#ff4500'; // æ©˜çº¢
      else if (stock < 6000) return '#ff0000'; // çº¢
      else return '#8b0000'; // æ·±çº¢ï¼ˆè¶…å‡ºé˜ˆå€¼ï¼‰
    }

    // æ›´ç´§å‡‘çš„åŠå¾„è®¡ç®—ï¼šé¿å…åœ¨å¤§æ•°æ®ä¸‹ç‚¹è¿‡å¤§è¦†ç›–åœ°å›¾
    function calcRadius(stock) {
      stock = Number(stock) || 0;
      if (stock <= 0) return 4;                  // æœ€å°åŠå¾„æ›´å°
      return Math.max(4, Math.log10(stock + 1) * 3); // æ”¾å¤§ç³»æ•°æ”¹æˆ3ï¼Œç‚¹ä¸ä¼šå¤ªå¤§
    }

    // éå†æ•°æ®ï¼Œåˆ›å»º circleMarker å¹¶ç»‘å®šå¼¹çª—
    data.forEach((w) => {
      // å¦‚æœç¼ºå°‘ç»çº¬åº¦ï¼Œè·³è¿‡ï¼ˆé¿å… runtime é”™è¯¯ï¼‰
      if (w.lat == null || w.lng == null) return;
      const stock = Number(w.stock) || 0;
      const available = Number(w.available) || 0;

      // æ ¹æ®ä¸åŒå±‚çº§ç”Ÿæˆä¸åŒçš„å¼¹çª—å†…å®¹ï¼ˆçœçº§ vs ä»“åº“çº§ï¼‰
      let popupHtml;
      if (level === 'province') {
        popupHtml = `
          <div class="warehouse-popup">
            <h4>${w.name}</h4>
            <div>åº“å­˜æ€»é‡: ${stock.toLocaleString()}</div>
            <div>å¯ç”¨åº“å­˜é‡: ${available.toLocaleString()}</div>
          </div>
        `;
      } else {
        popupHtml = `
          <div class="warehouse-popup">
            <h4>${w.name}</h4>
            <div>åº“åŒº/ä»“åº“: ${w.name}</div>
            <div>åº“å­˜æ€»é‡: ${stock.toLocaleString()}</div>
            <div>å¯ç”¨åº“å­˜: ${available.toLocaleString()}</div>
          </div>
        `;
      }

      // åˆ›å»ºåœ†ç‚¹ï¼Œå¤§å° + é¢œè‰²éšåº“å­˜é‡å˜åŒ–
      const marker = L.circleMarker([w.lat, w.lng], {
        radius: calcRadius(stock),
        fillColor: getColorByStock(stock),
        color: '#fff',      // åœ†ç‚¹è¾¹æ¡†è‰²ï¼ˆç™½è‰²ï¼‰
        weight: 1,
        fillOpacity: 0.9
      }).bindPopup(popupHtml);

      markerGroup.addLayer(marker);
    });

    // è‹¥æœ‰ç‚¹åˆ™è‡ªåŠ¨ç¼©æ”¾åˆ°å¯è§èŒƒå›´ï¼Œpad å¢åŠ ä¸€ç‚¹ç•™ç™½
    if (markerGroup.getLayers().length > 0) {
      map.fitBounds(markerGroup.getBounds().pad(0.12));
    } else {
      // æ²¡æœ‰ç‚¹æ—¶è¿˜åŸåˆ°é»˜è®¤è§†å›¾
      map.setView([35.0, 105.0], 4);
    }
  }

  // é¦–æ¬¡æ¸²æŸ“ä¸ºçœçº§æ•°æ®ï¼ˆè‹¥åç«¯ä¼ å…¥ provincesDataï¼‰
  renderPoints(provincesData, 'province');

  // æš´éœ²ä¸€ä¸ªå…¨å±€æ–¹æ³•ï¼Œä¾¿äºåœ¨é¡µé¢å…¶å®ƒåœ°æ–¹è°ƒç”¨ï¼ˆä¾‹å¦‚ç‚¹å‡»çœä»½å…ƒç´ ï¼‰
  // å‚æ•° provinceNameï¼šç‚¹å‡»æ—¶ä¼ å…¥çš„çœåç§°ï¼Œç”¨æ¥è¿‡æ»¤ allWarehouses å¹¶æ¸²æŸ“è¯¥çœä¸‹çš„ä»“åº“ç‚¹
  window.loadProvinceDetails = function (provinceName) {
    // é˜²æ­¢ allWarehouses ä¸æ˜¯æ•°ç»„ï¼ˆå‰ç«¯å®¹é”™ï¼‰
    if (!Array.isArray(allWarehouses)) return;

    // è¿‡æ»¤å‡ºè¯¥çœæœ‰ç»çº¬åº¦çš„ä»“åº“ç‚¹
    const provincePoints = allWarehouses
      .filter(w => w.province === provinceName && w.lat != null && w.lng != null);

    // å°†åœ°å›¾åˆ‡æ¢åˆ°ä»“åº“çº§åˆ«æ¸²æŸ“
    renderPoints(provincePoints, 'warehouse');
  };

}); // DOMContentLoaded end
</script>

{% endblock %}
