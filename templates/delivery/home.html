{% extends 'delivery/base.html' %}

{% block title %}å‘è´§ç®¡ç†é¦–é¡µ{% endblock %}

{% block head_extra %}
<!-- å›¾è¡¨åº“ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- åœ°å›¾åº“ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
  body {
    margin: 0;
    font-family: "Microsoft YaHei", sans-serif;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  h3.page-title { font-weight: 700; color: #0d6efd; }
  .card {
    border-radius: 14px;
    background: linear-gradient(135deg, #ffffff, #f5f9ff);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
  }
  /* å››æ ¸æŒ‡æ ‡å¡ç‰‡æ ·å¼ */
  .kpi-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .kpi-card {
    text-align: center;
    padding: 8px;
    border-radius: 12px;
    color: white;
    height: 90px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: transform 0.2s ease;
  }
  .kpi-card:hover { transform: scale(1.05); }
  .kpi-icon { font-size: 1.2rem; margin-bottom: 4px; }
  .kpi-delivery   { background: linear-gradient(135deg, #b9d9f5, #9e60f5); }
  .kpi-pending    { background: linear-gradient(135deg, #efae5e, #e0d49c); }
  .kpi-created    { background: linear-gradient(135deg, #6d51f7, #7c9bf1); }
  .kpi-picked     { background: linear-gradient(135deg, #e189f5, #e57f7f); }
  .kpi-shipped    { background: linear-gradient(135deg, #9f8bef, #78aeca); }
  .kpi-posted     { background: linear-gradient(135deg, #6a11cb, #2575fc); }
  .kpi-cancelled  { background: linear-gradient(135deg, #a4c5fa, #e68ff2); }
  .kpi-on-time    { background: linear-gradient(135deg, #e16262, #b8f5f2); }
  .kpi-late       { background: linear-gradient(135deg, #ff9966, #ff5e62); }
  .trend-up { color: #28a745; }
  .trend-down { color: #dc3545; }

  /* åœ°å›¾å®¹å™¨ */
  #warehouse-map {
    width: 100%;
    height: 400px;
    border-radius: 8px;
    overflow: hidden;
    background: #1e2a38;
  }

  /* ä»“åº“æ ‡è®°å¼¹å‡ºçª—å£æ ·å¼ */
  .warehouse-popup .leaflet-popup-content { min-width: 200px; font-size: 14px; }
  .warehouse-popup h4 {
    margin-top: 0; color: #0d6efd; border-bottom: 1px solid #eee; padding-bottom: 5px;
  }
  .warehouse-popup .stats { margin-top: 10px; }
  .warehouse-popup .stat-item {
    display: flex; justify-content: space-between; margin-bottom: 5px;
  }
  .warehouse-popup .stat-value { font-weight: bold; }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 992px) { .kpi-container { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 576px) { .kpi-container { grid-template-columns: 1fr; } }

  .card:hover { transform: scale(1.01); }
  .card-title { font-weight: 600; color: #34495e; }
  .card-text { font-size: 0.95rem; color: #6c757d; }
  .btn-sm { font-size: 0.85rem; border-radius: 8px; }
  .list-group-item a { text-decoration: none; color: #0d6efd; font-weight: 500; }
  .list-group-item:hover { background-color: #f7faff; }
  .table-sm thead { background-color: #eef4ff; font-size: 0.85rem; }
  .table-sm td { font-size: 0.85rem; vertical-align: middle; }
  .table-sm tbody tr:hover { background-color: #f0f8ff; transition: background-color 0.2s ease; }
  .text-danger { font-weight: bold; }
  hr { border-top: 1px solid #dee2e6; }

  /* Workflow container */
  .workflow-steps {
    display: flex; flex-wrap: nowrap; justify-content: flex-start; align-items: center;
    gap: 12px; overflow-x: auto; padding: 8px; scrollbar-width: thin; margin-bottom:30px;
  }
  .workflow-steps::-webkit-scrollbar { height: 6px; }
  .workflow-steps::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
  .workflow-steps .step-card {
    flex: 0 0 auto; min-width: 150px; max-width: 200px; padding: 15px 10px; border-radius: 12px;
    text-align: center; transition: all 0.3s ease; background: linear-gradient(135deg, #f580d0, #77a1f5);
    color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
</style>
{% endblock %}

{% block content %}
<div class="form-title-container">
  <h1 class="form-title"> ğŸšš å‘è´§ç®¡ç†é¦–é¡µ </h1>
</div>

<div class="kpi-container">
  <!-- ä»Šæ—¥å‘è´§é‡ -->
  <div class="kpi-card kpi-delivery">
    <div class="kpi-icon">ğŸšš</div>
    <div class="kpi-title">ä»Šæ—¥å‘è´§é‡</div>
    <div class="kpi-value">{{ today_delivery_count }}</div>
  </div>

  <!-- å¾…å¤„ç†è®¢å• -->
  <div class="kpi-card kpi-pending">
    <div class="kpi-icon">ğŸ“¦</div>
    <div class="kpi-title">å¾…å¤„ç†è®¢å•</div>
    <div class="kpi-value">{{ pending_orders }}</div>
  </div>

  <!-- å·²åˆ›å»º -->
  <div class="kpi-card kpi-created">
    <div class="kpi-icon">ğŸ“</div>
    <div class="kpi-title">å·²åˆ›å»º</div>
    <div class="kpi-value">{{ status_counts['å·²åˆ›å»º'] }}</div>
  </div>

  <!-- å·²æ‹£è´§ -->
  <div class="kpi-card kpi-picked">
    <div class="kpi-icon">ğŸ›’</div>
    <div class="kpi-title">å·²æ‹£è´§</div>
    <div class="kpi-value">{{ status_counts['å·²æ‹£è´§'] }}</div>
  </div>

  <!-- å·²å‘è´§ -->
  <div class="kpi-card kpi-shipped">
    <div class="kpi-icon">ğŸ“¤</div>
    <div class="kpi-title">å·²å‘è´§</div>
    <div class="kpi-value">{{ status_counts['å·²å‘è´§'] }}</div>
  </div>

  <!-- å·²è¿‡è´¦ -->
  <div class="kpi-card kpi-posted">
    <div class="kpi-icon">âœ…</div>
    <div class="kpi-title">å·²è¿‡è´¦</div>
    <div class="kpi-value">{{ status_counts['å·²è¿‡è´¦'] }}</div>
  </div>

  <!-- å·²å–æ¶ˆ -->
  <div class="kpi-card kpi-cancelled">
    <div class="kpi-icon">âŒ</div>
    <div class="kpi-title">å·²å–æ¶ˆ</div>
    <div class="kpi-value">{{ status_counts['å·²å–æ¶ˆ'] }}</div>
  </div>

  <!-- å‡†æ—¶å‘è´§ç‡ -->
  <div class="kpi-card kpi-on-time">
    <div class="kpi-icon">â±</div>
    <div class="kpi-title">å‡†æ—¶å‘è´§ç‡</div>
    <div class="kpi-value">{{ on_time_rate }}%</div>
  </div>

  <!-- å»¶è¿Ÿå‘è´§ç‡ -->
  <div class="kpi-card kpi-late">
    <div class="kpi-icon">ğŸŒ</div>
    <div class="kpi-title">å»¶è¿Ÿå‘è´§ç‡</div>
    <div class="kpi-value">{{ late_rate }}%</div>
  </div>
</div>


<div class="workflow-steps animate-fade">
  <div class="step-card" style="background: linear-gradient(135deg, #358df9dd, #ee39ff);">å‘è´§æµç¨‹</div>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.create_delivery') }}">
    <div class="step-card">åˆ›å»ºå‘è´§</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.picking_task_list') }}">
    <div class="step-card">æ‹£è´§</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.inventory_movement') }}">
    <div class="step-card">åº“å­˜å˜åŠ¨æŸ¥è¯¢</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.shipment_list') }}">
    <div class="step-card">å‘è´§</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.inventory_movement') }}">
    <div class="step-card">åº“å­˜å˜åŠ¨æŸ¥è¯¢</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.post_list') }}">
    <div class="step-card">è¿‡è´¦</div>
  </a>
  <div class="step-arrow">ğŸ‘‰</div>
  <a href="{{ url_for('delivery.inventory_movement') }}">
    <div class="step-card">åº“å­˜å˜åŠ¨æŸ¥è¯¢</div>
  </a>
</div>

<!-- ä»“å‚¨åœ°å›¾åŒºåŸŸ -->
<h5 class="fw-bold mb-3">ğŸ­ ä»“å‚¨åˆ†å¸ƒå›¾</h5>
<div id="warehouse-map"></div>
<hr class="my-4">
{%endblock%}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // ä»åç«¯æ³¨å…¥æ•°æ®ï¼ˆç¡®ä¿åç«¯ä¼ äº† all_warehousesï¼‰
  const provincesData = {{ warehouses | tojson | safe }} || [];
  const allWarehouses = {{ all_warehouses | tojson | safe }} || [];

  const chinaBounds = L.latLngBounds([3.85, 73.66], [53.55, 135.05]);
  const map = L.map('warehouse-map').setView([35.0, 105.0], 4);

  L.tileLayer(
    'https://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}',
    { attribution: 'é«˜å¾·åœ°å›¾', maxZoom: 18 }
  ).addTo(map);
  map.setMaxBounds(chinaBounds);

  // ä¿®å¤åœ¨æŸäº›å¸ƒå±€ä¸‹ Leaflet å®¹å™¨å°ºå¯¸è®¡ç®—é”™è¯¯çš„é—®é¢˜
  map.whenReady(function() {
    setTimeout(function(){ map.invalidateSize(); }, 200);
  });

  let markerGroup = L.featureGroup().addTo(map);

  function calcRadius(stock) {
    stock = Number(stock) || 0;
    if (stock <= 0) return 6;
    // log è®¡ç®—ç¡®ä¿éšç€æ•°é‡å¢åŠ åŠå¯¹æ•°å¢é•¿
    return Math.max(6, Math.log10(stock + 1) * 6);
  }

function renderPoints(data, level = 'province') {
  // æ¸…ç©ºæ—§å›¾å±‚
  markerGroup.clearLayers();

  // è®¡ç®—æœ€å¤§åº“å­˜ï¼Œç”¨äºé¢œè‰²æ¸å˜ï¼ˆå¯é€‰ï¼‰
  const maxStock = Math.max(...data.map(w => Number(w.stock) || 0), 1);

  // é¢œè‰²æ˜ å°„å‡½æ•°
  function getColorByStock(stock) {
    stock = Number(stock) || 0;
    if (stock <= 0) return '#999';          // æ— åº“å­˜ç°è‰²
    else if (stock < 100) return '#00bfff'; // è“
    else if (stock < 1000) return '#32cd32'; // ç»¿
    else if (stock < 2000) return '#ffa500'; // æ©™
    else if (stock < 3000) return '#ff8c00'; // æ·±æ©™
    else if (stock < 4000) return '#ff6347'; // ç•ªèŒ„çº¢
    else if (stock < 5000) return '#ff4500'; // æ©˜çº¢
    else if (stock < 6000) return '#ff0000'; // çº¢
    else return '#8b0000'; // æ·±çº¢
  }

  // åŠå¾„è®¡ç®—å‡½æ•°
  function calcRadius(stock) {
    stock = Number(stock) || 0;
    if (stock <= 0) return 4;                  // æœ€å°åŠå¾„æ›´å°
    return Math.max(4, Math.log10(stock + 1) * 3); // æ”¾å¤§ç³»æ•°æ”¹æˆ3ï¼Œç‚¹ä¸ä¼šå¤ªå¤§
  }
  data.forEach((w) => {
    if (w.lat == null || w.lng == null) return;
    const stock = Number(w.stock) || 0;
    const available = Number(w.available) || 0;

    let popupHtml;
    if (level === 'province') {
      popupHtml = `
        <div class="warehouse-popup">
          <h4>${w.name}</h4>
          <div>åº“å­˜æ€»é‡: ${stock.toLocaleString()}</div>
          <div>å¯ç”¨åº“å­˜é‡: ${available.toLocaleString()}</div>
        </div>
      `;
    } else {
      popupHtml = `
        <div class="warehouse-popup">
          <h4>${w.name}</h4>
          <div>åº“åŒº/ä»“åº“: ${w.name}</div>
          <div>åº“å­˜æ€»é‡: ${stock.toLocaleString()}</div>
          <div>å¯ç”¨åº“å­˜: ${available.toLocaleString()}</div>
        </div>
      `;
    }

    // åˆ›å»ºåœ†ç‚¹ï¼Œå¤§å° + é¢œè‰²éšåº“å­˜é‡å˜åŒ–
    const marker = L.circleMarker([w.lat, w.lng], {
      radius: calcRadius(stock),
      fillColor: getColorByStock(stock),
      color: '#fff',
      weight: 1,
      fillOpacity: 0.9
    }).bindPopup(popupHtml);

    markerGroup.addLayer(marker);
  });

  if (markerGroup.getLayers().length > 0) {
    map.fitBounds(markerGroup.getBounds().pad(0.12));
  } else {
    map.setView([35.0, 105.0], 4);
  }
}

// æ¸²æŸ“çœçº§æ•°æ®
renderPoints(provincesData, 'province');

  // ç‚¹å‡»çœä»½ â†’ æœ¬åœ°è¿‡æ»¤ä»“åº“
  window.loadProvinceDetails = function (provinceName) {
    // é˜²æ­¢ undefined
    if (!Array.isArray(allWarehouses)) return;
    const provincePoints = allWarehouses
      .filter(w => w.province === provinceName && w.lat != null && w.lng != null);

    renderPoints(provincePoints, 'warehouse');
  };

});
</script>

{% endblock %}


