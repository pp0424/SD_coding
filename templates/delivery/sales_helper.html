{% extends 'delivery/base_popup.html' %}
{% block title %}é”€å”®è®¢å•å·æŸ¥è¯¢{% endblock %}
{% block content %}

<div class="card gradient-bg shadow-sm">
  <div class="card-header position-relative py-3 text-center">
    <strong class="text-white fs-5">ğŸ” é”€å”®è®¢å•å·æŸ¥è¯¢</strong>
    <button type="button" class="btn btn-sm btn-outline-light position-absolute top-50 end-0 translate-middle-y me-2"
            onclick="window.close()">å…³é—­</button>
  </div>

  <div class="card-body">
    <form method="get" class="row g-2 mb-3">
      <div class="col-md-3">
        <input type="text" name="customer_id" value="{{ request.args.get('customer_id','') }}" class="form-control" placeholder="å®¢æˆ·ID">
      </div>
      <div class="col-md-3">
        <select name="status" class="form-select">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
          {% for st in ['è‰ç¨¿','å·²åˆ›å»º','å·²å®¡æ ¸','éƒ¨åˆ†å‘è´§','å·²å‘è´§','å·²å®Œæˆ','å·²å–æ¶ˆ'] %}
          <option value="{{ st }}" {% if request.args.get('status') == st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <input type="date" name="date_from" value="{{ request.args.get('date_from','') }}" class="form-control">
      </div>
      <div class="col-md-3">
        <input type="date" name="date_to" value="{{ request.args.get('date_to','') }}" class="form-control">
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100"><i class="bi bi-search"></i> æŸ¥è¯¢</button>
      </div>
    </form>

    {% if items %}
    <div class="table-responsive" style="max-height: 60vh;">
      <table class="table table-hover table-sm align-middle">
        <thead class="table-light sticky-top">
          <tr>
            <th>å®¢æˆ·ID</th>
            <th>è®¢å•æ—¥æœŸ</th>
            <th>äº¤è´§æ—¥æœŸ</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {% for r in items %}
          <tr>
            <td>{{ r.customer_id }}</td>
            <td>{{ r.order_date.strftime('%Y-%m-%d') }}</td>
            <td>{{ r.required_delivery_date.strftime('%Y-%m-%d') }}</td>
            <td>{{ r.status or '-' }}</td>
            <td>
            <button type="button" class="btn btn-success btn-sm"
              data-sales-order-id="{{ r.sales_order_id }}"
              onclick="selectSales(this)">
              é€‰æ‹©
            </button>

            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- åˆ†é¡µ -->
    {% if pagination %}
    <div class="d-flex justify-content-between mt-2">
      <span class="text-white small">ç¬¬ {{ pagination.page }} / {{ pagination.pages }} é¡µï¼Œå…± {{ pagination.total }} æ¡</span>
      <div class="btn-group">
        {% if pagination.has_prev %}
        <a class="btn btn-sm btn-outline-light" href="{{ url_for('delivery.sales_helper', page=pagination.page-1, **args) }}">ä¸Šä¸€é¡µ</a>
        {% endif %}
        {% if pagination.has_next %}
        <a class="btn btn-sm btn-outline-light" href="{{ url_for('delivery.sales_helper', page=pagination.page+1, **args) }}">ä¸‹ä¸€é¡µ</a>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% elif request.args %}
    <div class="text-white">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…è®°å½•</div>
    {% endif %}
  </div>
</div>

<script>
/**
 * ä»æŒ‰é’®çš„ data-* å±æ€§å›å¡«çˆ¶çª—å£å­—æ®µï¼Œé¿å…æ¨¡æ¿ JS æ³¨å…¥ä¸å®Œæ•´å¯¼è‡´ SyntaxErrorã€‚
 * usage: onclick="selectSales(this)"
 */
function selectSales(btn) {
  try {
    console.log('selectSales called', btn);
    if (!window.opener || window.opener.closed) {
      alert('çˆ¶çª—å£å·²å…³é—­æˆ–ä¸å­˜åœ¨ï¼Œæ— æ³•å›å¡«');
      window.close();
      return;
    }

    const getData = (attr) => btn.getAttribute('data-' + attr) ?? '';

    const payload = {
      salesOrderId: getData('sales-order-id'),
      customerId: getData('customer-id'),
      orderDate: getData('order-date'),
      requiredDeliveryDate: getData('required-delivery-date'),
      status: getData('status')
    };

    const setIfExists = (idOrName, val) => {
      const doc = window.opener.document;
      let el = doc.getElementById(idOrName);
      if (!el) el = doc.querySelector('[name="' + idOrName + '"]');
      if (!el) return false;
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') {
        el.value = val;
        el.dispatchEvent(new Event('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
      } else {
        el.textContent = val;
      }
      return true;
    };

    // ä¸»å­—æ®µå›å¡«ï¼ˆæ ¹æ®çˆ¶é¡µå®é™… id/name è°ƒæ•´ï¼‰
      setIfExists('sales_order_id', payload.salesOrderId)

  } catch (err) {
    console.error('å›å¡«å¼‚å¸¸', err);
    alert('å›å¡«å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ï¼š' + (err && err.message));
  } finally {
    window.close();
  }
}
</script>


<style>
/* å±€éƒ¨ style */
.gradient-bg { background: linear-gradient(135deg, #5a96f1, #ef7df9); color: #fff; border: none; border-radius: 12px; }
.gradient-bg .card-header { background: transparent; border-bottom: 1px solid rgba(255,255,255,0.25); }
.table-hover tbody tr:hover { background-color: rgba(255,255,255,0.06); }
.btn-outline-light { color:#fff; border-color: rgba(255,255,255,0.6); }
</style>

{% endblock %}
