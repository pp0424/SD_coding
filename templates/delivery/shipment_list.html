{# ç»§æ‰¿åŸºç¡€å¸ƒå±€ï¼Œç»Ÿä¸€å¯¼èˆª/æ ·å¼ #}
{% extends 'delivery/base.html' %}

{# é¡µé¢ <title> #}
{% block title %}å‘è´§å•åˆ—è¡¨{% endblock %}

{% block head_extra %}
{# å¼•å…¥æ¨¡å—ä¸“ç”¨æ ·å¼ï¼ˆå¯åœ¨æ­¤æ–‡ä»¶ä¸­æ”¾é€šç”¨ç»„ä»¶æ ·å¼ï¼‰ #}
<link rel="stylesheet" href="{{ url_for('static', filename='delivery/delivery_styles.css') }}">

<style>
  /* é¡µé¢æœ€å¤§å®½åº¦ä¸å±…ä¸­ */
  .page-container { max-width: 1180px; margin: 0 auto; padding: 16px; }

  /* å®¹å™¨å¡ç‰‡ï¼šè¾¹æ¡†+é˜´å½±+åœ†è§’ */
  .delivery-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); overflow: hidden; }

  /* é¡¶éƒ¨å·¥å…·æ ä¸æ ‡é¢˜åŒºåŸŸ */
  .card-header { padding: 16px 18px 8px; background: linear-gradient(180deg, #fafbfc 0%, #ffffff 100%); border-bottom: 1px solid #e5e7eb; }
  .toolbar { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
  .stats-info { font-size: 0.9rem; color: #6b7280; }

  /* æŸ¥è¯¢è¡¨å•åŒºåŸŸæ ·å¼ */
  .query-form { padding: 12px 18px 8px; }
  .query-form .form-label { font-weight: 600; color: #374151; }
  .btn-search { background: #2563eb; border-color: #2563eb; color: white; }
  .btn-search:hover { background: #1e40af; border-color: #1e40af; color: white; }

  /* è¡¨æ ¼å®¹å™¨ä¸è¡¨æ ¼æ ·å¼ */
  .table-section { padding: 12px 18px 18px; }
  .table-responsive { max-height: 62vh; border: 1px solid #e5e7eb; border-radius: 8px; overflow: auto; }
  .delivery-table { width: 100%; border-collapse: separate; border-spacing: 0; }
  .delivery-table thead th { position: sticky; top: 0; background: #f8fafc; font-weight: 700; color: #374151; padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
  .delivery-table tbody td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; color: #1f2937; vertical-align: middle; }
  .delivery-table tbody tr:hover { background: #f9fafb; }

  /* å¾½ç« å’Œæ“ä½œæŒ‰é’®æ ·å¼ */
  .badge { border-radius: 999px; padding: 0.35rem 0.6rem; }
  .btn-action { padding: 6px 10px; border-radius: 8px; }

  /* ç©ºæ•°æ®çŠ¶æ€æ ·å¼ */
  .empty-state { text-align: center; color: #6b7280; }
  .empty-state .inner { display: flex; height: 200px; align-items: center; justify-content: center; flex-direction: column; gap: 6px; }

  /*  table-layout å¯åœ¨å†…å®¹åˆ—å®½ä¸ç¨³å®šæ—¶è€ƒè™‘ fixed æå‡ç¨³å®šæ€§ã€‚ */
  .delivery-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    table-layout: auto; /* æˆ– fixedï¼Œæ ¹æ®éœ€è¦è°ƒæ•´åˆ—å®½åˆ†å¸ƒ */
  }

  .delivery-table th,
  .delivery-table td {
    white-space: nowrap; /* ä¸æ¢è¡Œï¼Œæ­é…å¤–å±‚æ¨ªå‘æ»šåŠ¨ä»¥é¿å…æ‹¥æŒ¤ */
  }

  .table-responsive {
    overflow-x: auto; /* åˆ—è¾ƒå¤šæ—¶å…è®¸æ¨ªå‘æ»šåŠ¨ */
  }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
  <div class="form-title-container">
    {# é¡µé¢ä¸»æ ‡é¢˜ï¼ˆä¸æµè§ˆå™¨æ ‡é¢˜åˆ†å¼€ï¼‰ #}
    <h1 class="form-title">ğŸšš æ‰§è¡Œå‘è´§</h1>
  </div>

  <div class="delivery-card animate-fade">
    {# é¡¶éƒ¨å·¥å…·æ ï¼šå·¦ä¾§åˆ—è¡¨ç»Ÿè®¡ï¼Œå³ä¾§å¿«æ·æ“ä½œ #}
    <div class="card-header">
      <div class="toolbar">
        <div>
          <i class="bi bi-list-ul me-2"></i>
          <strong>å‘è´§å•åˆ—è¡¨</strong>
          <span class="stats-info ms-3">å…±æ‰¾åˆ° {{ deliveries|length }} æ¡è®°å½•</span>
        </div>
        <div class="d-flex gap-2">
          {# æ–°å»ºå‘è´§å•æŒ‰é’® #}
          <a href="{{ url_for('delivery.create_delivery') }}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> æ–°å»ºå‘è´§å•
          </a>
          {# æ‰“å°å½“å‰é¡µé¢ï¼ˆæµè§ˆå™¨æ‰“å°ï¼‰ #}
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> æ‰“å°
          </button>
        </div>
      </div>

      {# æŸ¥è¯¢è¡¨å•ï¼šPOST æäº¤ï¼ŒåŒ…å« CSRFï¼›æ”¯æŒæŒ‰å‘è´§å•ã€é”€å”®è®¢å•ã€æ—¥æœŸèŒƒå›´è¿‡æ»¤ #}
      <form method="post" class="row g-3 query-form align-items-end">
        {{ form.csrf_token }}

        {# å‘è´§å•å·è¾“å…¥ + è¾…åŠ©é€‰æ‹©å™¨å¼¹çª— #}
        <div class="col-md-2">
            <label class="form-label" for="delivery_id">{{ form.delivery_id.label.text }}</label>
            <div class="input-group">
              {{ form.delivery_id(class="form-control", id="delivery_id") }}
              <button type="button" class="btn btn-outline-secondary"
                      onclick="openCentered('{{ url_for('delivery.delivery_helper') }}', 'deliveryHelper', 800, 600)">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>

          {# é”€å”®è®¢å• ID è¾“å…¥ + è¾…åŠ©é€‰æ‹©å™¨å¼¹çª— #}
          <div class="col-md-2">
            <label class="form-label" for="sales_order_id">{{ form.sales_order_id.label.text }}</label>
            <div class="input-group">
              {{ form.sales_order_id(class="form-control", id="sales_order_id") }}
              <button type="button" class="btn btn-outline-secondary"
                      onclick="openCentered('{{ url_for('delivery.sales_helper') }}', 'salesHelper', 800, 600)">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>

        {# æ—¥æœŸèŒƒå›´ï¼šèµ·å§‹æ—¥æœŸ #}
        <div class="col-md-2">
          {{ form.start_date.label(class="form-label") }}
          {{ form.start_date(class="form-control", type="date") }}
        </div>

        {# æ—¥æœŸèŒƒå›´ï¼šç»“æŸæ—¥æœŸ #}
        <div class="col-md-2">
          {{ form.end_date.label(class="form-label") }}
          {{ form.end_date(class="form-control", type="date") }}
        </div>

        {# æäº¤æŒ‰é’®ï¼ˆå…¨å®½ä¾¿äºè§¦æ§ï¼‰ #}
        <div class="col-md-2">
          {{ form.submit(class="btn btn-search w-100") }}
        </div>
      </form>
    </div>

    {# è¡¨æ ¼åˆ—è¡¨åŒºåŸŸ #}
    <div class="table-section">
      <div class="table-responsive">
        <table class="delivery-table table-hover">
          <thead>
            <tr>
              <th>å‘è´§å•å·</th>
              <th>æ‹£è´§ä»»åŠ¡</th>
              <th>é”€å”®è®¢å•å·</th>
              <th>å‘è´§æ—¥æœŸ</th>
              <th>ä»“åº“ä»£ç </th>
              <th>çŠ¶æ€</th>
              <th>æ‹£è´§å‘˜</th>
              <th>å¤‡æ³¨</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {# è¿­ä»£åˆ—è¡¨ï¼šdeliveries ä¸º (dn, pt) äºŒå…ƒç»„ï¼Œdn=å‘è´§å•å¯¹è±¡ï¼Œpt=æ‹£è´§ä»»åŠ¡å¯¹è±¡ #}
            {% for dn, pt in deliveries %}
            <tr>
              {# å‘è´§å•å·ï¼šå¯ç‚¹å‡»è¿›å…¥è¯¦æƒ…é¡µ #}
              <td>
                <a href="{{ url_for('delivery.delivery_detail', delivery_id=dn.delivery_note_id) }}"
                   class="text-decoration-none fw-bold text-primary">{{ dn.delivery_note_id }}</a>
              </td>

              {# æ‹£è´§ä»»åŠ¡å·ï¼šå¯ç‚¹å‡»è¿›å…¥æ‹£è´§ä»»åŠ¡è¯¦æƒ… #}
              <td>
                <a href="{{ url_for('delivery.picking_task_detail', task_id=dn.picking_task_id) }}"
                   class="text-decoration-none fw-bold text-primary">{{ dn.picking_task_id }}</a>
              </td>

              {# é”€å”®è®¢å•å·ï¼ˆå¼±åŒ–æ–‡å­—é¢œè‰²ï¼‰ #}
              <td><span class="text-muted">{{ dn.sales_order_id }}</span></td>

              {# å‘è´§æ—¥æœŸï¼šç©ºå€¼æ˜¾ç¤º '-' #}
              <td>{{ dn.delivery_date.strftime('%Y-%m-%d') if dn.delivery_date else '-' }}</td>

              {# ä»“åº“ä»£ç ï¼šç”¨æµ…åº•å¾½ç« æ˜¾ç¤º #}
              <td><span class="badge bg-light text-dark">{{ dn.warehouse_code }}</span></td>

              {# çŠ¶æ€å¾½ç« ï¼šæŒ‰ä¸åŒçŠ¶æ€ç»™ä¸åŒé¢œè‰² #}
              <td>
                <span class="badge 
                  {% if dn.status == 'å·²åˆ›å»º' %}bg-primary
                  {% elif dn.status == 'å·²æ‹£è´§' %}bg-warning
                  {% elif dn.status == 'å·²å‘è´§' %}bg-primary
                  {% elif dn.status == 'å·²è¿‡è´¦' %}bg-success
                  {% elif dn.status == 'å·²å®Œæˆ' %}bg-light text-dark
                  {% elif dn.status == 'å·²å–æ¶ˆ' %}bg-danger
                  {% else %}bg-secondary{% endif %}">
                  {{ dn.status }}
                </span>
              </td>

              {# æ‹£è´§å‘˜æ¥è‡ªæ‹£è´§ä»»åŠ¡å¯¹è±¡ï¼Œç©ºå€¼æ˜¾ç¤º '-' #}
              <td><small class="text-muted">{{ pt.picker or '-' }}</small></td>

              {# å¤‡æ³¨ #}
              <td><small class="text-muted">{{ dn.remarks or '-' }}</small></td>

              {# æ“ä½œåŒºï¼šæ ¹æ®çŠ¶æ€æ˜¾ç¤ºå¯æ‰§è¡ŒåŠ¨ä½œ #}
              <td>
                <div class="d-flex flex-wrap gap-1">
                  {# ä»…â€œå·²æ‹£è´§â€çŠ¶æ€æ˜¾ç¤ºâ€œå‘è´§â€æŒ‰é’®ï¼›è¡¨å•æºå¸¦ CSRF ä»¤ç‰Œ #}
                  {% if dn.status == 'å·²æ‹£è´§' %}
                  <form action="{{ url_for('delivery.shipment', delivery_id=dn.delivery_note_id) }}" method="POST">
                    {{ form.csrf_token }}
                    <button type="submit" class="btn btn-outline-primary btn-action" title="å‘è´§">
                      <i class="bi bi-box-arrow-up"></i>
                    </button>
                  </form>
                  {% endif %}

                  {# è¯¦æƒ…æŒ‰é’®ï¼šéšæ—¶å¯è§ #}
                  <a href="{{ url_for('delivery.delivery_detail', delivery_id=dn.delivery_note_id) }}"
                     class="btn btn-outline-secondary btn-action" title="è¯¦æƒ…">
                    <i class="bi bi-eye"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% else %}
            {# ç©ºæ•°æ®çŠ¶æ€ï¼šåˆå¹¶å…¨éƒ¨ 9 åˆ— #}
            <tr>
              <td colspan="9" class="empty-state">
                <div class="inner">
                  <i class="bi bi-inbox display-4 d-block mb-2"></i>
                  <h5>æš‚æ— ç¬¦åˆæ¡ä»¶çš„å‘è´§å•è®°å½•</h5>
                  <p class="text-muted">è¯·è°ƒæ•´æŸ¥è¯¢æ¡ä»¶æˆ– <a href="{{ url_for('delivery.create_delivery') }}">åˆ›å»ºæ–°çš„å‘è´§å•</a></p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
{% endblock %}
