{% extends 'delivery/base.html' %}
{% block title %}å‘è´§å•åˆ—è¡¨{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='delivery/delivery_styles.css') }}">
<style>
      /* è¡¨æ ¼æ‰€æœ‰å•å…ƒæ ¼ä¸æ¢è¡Œ */
      .delivery-table th,
      .delivery-table td {
        white-space: nowrap;   /* ç¦æ­¢è‡ªåŠ¨æ¢è¡Œ */
        vertical-align: middle; /* è®©å†…å®¹å‚ç›´å±…ä¸­ï¼Œå¯é€‰ */
      }

      .delivery-card {
        width: 100%;
      }
</style>
{% endblock %}

{% block content %}
<div class="form-title-container">
  <h1 class="form-title">ğŸšš æ‰§è¡Œå‘è´§</h1>
</div>

<div class="delivery-card animate-fade">
  <form method="post" class="row g-3 query-form align-items-end">
    {{ form.csrf_token }}
    <div class="col-md-2">
      {{ form.delivery_id.label(class="form-label") }}
      {{ form.delivery_id(class="form-control", placeholder="å‘è´§å•å·") }}
    </div>
    <div class="col-md-2">
      {{ form.sales_order_id.label(class="form-label") }}
      {{ form.sales_order_id(class="form-control", placeholder="é”€å”®è®¢å•å·") }}
    </div>
    <div class="col-md-2">
      {{ form.start_date.label(class="form-label") }}
      {{ form.start_date(class="form-control", type="date") }}
    </div>
    <div class="col-md-2">
      {{ form.end_date.label(class="form-label") }}
      {{ form.end_date(class="form-control", type="date") }}
    </div>
    <div class="col-md-2">
      {{ form.submit(class="btn btn-search w-100") }}
    </div>
  </form>
</div>

<div class="delivery-card animate-fade">
  <div class="card-header">
    <div class="toolbar">
      <div>
        <i class="bi bi-list-ul me-2"></i>
        <strong>å‘è´§å•åˆ—è¡¨</strong>
        <span class="stats-info ms-3">å…±æ‰¾åˆ° {{ deliveries|length }} æ¡è®°å½•</span>
      </div>
      <div>
        <a href="{{ url_for('delivery.create_delivery') }}" class="btn btn-primary btn-sm">
          <i class="bi bi-plus-circle me-1"></i> æ–°å»ºå‘è´§å•
        </a>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print()">
          <i class="bi bi-printer me-1"></i> æ‰“å°
        </button>
      </div>
    </div>
  </div>

  <div class="table-responsive" style="max-height: 70vh;">
    <table class="delivery-table table-hover">
      <thead>
        <tr>
          <th>å‘è´§å•å·</th>
          <th>é”€å”®è®¢å•å·</th>
          <th>å‘è´§æ—¥æœŸ</th>
          <th>ä»“åº“ä»£ç </th>
          <th>çŠ¶æ€</th>
          <th>è¿‡è´¦äºº</th>
          <th>è¿‡è´¦æ—¶é—´</th>
          <th>å¤‡æ³¨</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for delivery in deliveries %}
        <tr>
          <td><a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}" class="text-decoration-none fw-bold text-primary">{{ delivery.delivery_note_id }}</a></td>
          <td><span class="text-muted">{{ delivery.sales_order_id }}</span></td>
          <td>{{ delivery.delivery_date.strftime('%Y-%m-%d') if delivery.delivery_date else '-' }}</td>
          <td><span class="badge bg-light text-dark">{{ delivery.warehouse_code }}</span></td>
          <td>
            <span class="badge 
              {% if delivery.status == 'å·²åˆ›å»º' %}bg-primary
              {% elif delivery.status == 'å·²æ‹£è´§' %}bg-warning
              {% elif delivery.status == 'å·²å‘è´§' %}bg-primary
              {% elif delivery.status == 'å·²è¿‡è´¦' %}bg-success
              {% elif delivery.status == 'å·²å®Œæˆ' %}bg-light text-dark
              {% elif delivery.status == 'å·²å–æ¶ˆ' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ delivery.status }}
            </span>
          </td>
          <td><small class="text-muted">{{ delivery.posted_by or '-' }}</small></td>
          <td><small class="text-muted">{{ delivery.posted_at.strftime('%Y-%m-%d %H:%M') if delivery.posted_at else '-' }}</small></td>
          <td><small class="text-muted">{{ delivery.remarks or '-' }}</small></td>
          <td>
            <div class="d-flex flex-wrap gap-1">
              <!-- å‘è´§æŒ‰é’® -->
              {% if delivery.status == 'å·²æ‹£è´§' %}
              <form action="{{ url_for('delivery.shipment', delivery_id=delivery.delivery_note_id) }}" method="POST">
                {{ form.csrf_token }}
                <button type="submit" class="btn btn-outline-primary btn-action" title="å‘è´§">
                  <i class="bi bi-box-arrow-up"></i>
                </button>
              </form>
              {% endif %}
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="empty-state">
            <i class="bi bi-inbox display-4 d-block mb-2"></i>
            <h5>æš‚æ— ç¬¦åˆæ¡ä»¶çš„å‘è´§å•è®°å½•</h5>
            <p class="text-muted">è¯·è°ƒæ•´æŸ¥è¯¢æ¡ä»¶æˆ– <a href="{{ url_for('delivery.create_delivery') }}">åˆ›å»ºæ–°çš„å‘è´§å•</a></p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
setTimeout(() => {
  document.querySelectorAll('.alert-dismissible').forEach(alert => {
    new bootstrap.Alert(alert).close();
  });
}, 5000);

document.querySelectorAll('tbody tr').forEach(row => {
  row.addEventListener('click', e => {
    if (e.target.closest('a, button, form')) return;
    const link = row.querySelector('a[href*="delivery_detail"]');
    if (link) window.location.href = link.href;
  });
});
</script>
{% endblock %}

