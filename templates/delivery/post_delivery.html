{# templates/delivery/post_delivery.html #}
{% extends "delivery/base.html" %}
{% block title %}æ‰§è¡Œè¿‡è´¦{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ¡ -->
<div class="form-title-container">
    <h1 class="form-title">
      ğŸ“œ æ‰§è¡Œè¿‡è´¦ #{{ delivery.delivery_note_id }}
    </h1>
  </div>

  <!-- åŸºæœ¬ä¿¡æ¯ -->
  <div class="px-3 py-2 small text-muted border-bottom">
    é”€å”®è®¢å•ï¼š{{ delivery.sales_order_id }}
    &nbsp;&nbsp;|&nbsp;&nbsp; ä»“åº“ï¼š{{ delivery.warehouse_code }}
    &nbsp;&nbsp;|&nbsp;&nbsp; å½“å‰çŠ¶æ€ï¼š{{ delivery.status }}
  </div>

  <!-- é—ªå­˜æ¶ˆæ¯ -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="px-3 pt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'warning' if category=='danger' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- è¡¨å• -->
  <form method="post" action="{{ url_for('delivery.post_delivery', delivery_id=delivery.delivery_note_id) }}">
    {{ form.csrf_token }}

    <div class="table-responsive">
      <table class="table mb-0 align-middle text-center">
        <thead class="table-light">
          <tr>
            <th>è¡Œå·</th>
            <th>ç‰©æ–™ç¼–å·</th>
            <th>ç‰©æ–™æè¿°</th>
            <th>è®¡åˆ’æ•°é‡</th>
            <th>å®é™…æ•°é‡</th>
            <th>å¤‡æ³¨</th>
          </tr>
        </thead>
        <tbody>
          {% for item_form in form.items %}
            {% set i = loop.index0 %}
            {% set di = delivery.items[i] %}
            <tr data-row="{{ i }}">
              <!-- å±•ç¤ºç”¨æ–‡æœ¬ -->
              <td class="text-center">{{ di.item_no }}</td>
              <td class="text-center">{{ di.material_id }}</td>
              <td class="text-start">
                {{ di.material.description }}
              </td>
              <td class="text-end">
                {{ '%.4f'|format(item_form.planned_quantity.data or 0) }}
              </td>

              <!-- å¯ç¼–è¾‘è¾“å…¥ -->
              <td>
                {{ item_form.actual_quantity(
                    class="form-control text-end actual",
                    step="0.0001",
                    min="0",
                    inputmode="decimal",
                    autocomplete="off",
                    **{'data-planned': item_form.planned_quantity.data or 0}
                ) }}
                <div class="text-danger small mt-1 d-none" data-error></div>
                {% if item_form.actual_quantity.errors %}
                  <div class="text-danger small mt-1">
                    {{ item_form.actual_quantity.errors|join('ï¼Œ') }}
                  </div>
                {% endif %}
              </td>

              <!-- è¡Œå¤‡æ³¨ï¼šä¸åç«¯ request.form.get(f"items-{i}-line_remark") å¯¹é½ -->
              <td>
                <input
                  type="text"
                  name="items-{{ i }}-line_remark"
                  class="form-control form-control-sm"
                  placeholder="çŸ­å‘/å¤šå‘è¯´æ˜"
                  value="{% if request.method == 'POST' %}{{ request.form.get('items-' ~ i ~ '-line_remark', '') }}{% else %}{{ di.line_remark or '' }}{% endif %}"
                >
              </td>

              <!-- éšè—åŸŸï¼šæäº¤æ‰€éœ€çš„åå°å­—æ®µ -->
              {{ item_form.item_no(type="hidden") }}
              {{ item_form.material_id(type="hidden") }}
              {{ item_form.planned_quantity(type="hidden", class="planned-hidden") }}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- è¿‡è´¦å¤‡æ³¨ -->
    <div class="p-3 border-top">
      <label class="form-label fw-bold">
        è¿‡è´¦å¤‡æ³¨ <small class="text-muted">(è‹¥ä¸è®¡åˆ’æ•°é‡ä¸ç¬¦è¯·è¡¥å……è¯´æ˜)</small>
      </label>
      {{ form.remarks(class="form-control", rows="3", placeholder="å°†ä»¥ [è¿‡è´¦å¤‡æ³¨] å‰ç¼€è¿½åŠ åˆ°å‘è´§å•å¤‡æ³¨ä¸­") }}
    </div>

    <!-- æŒ‰é’® -->
    <div class="p-3 d-flex justify-content-end gap-2 border-top">
      <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}"
         class="btn btn-light">å–æ¶ˆ</a>
      <button type="submit" class="btn btn-primary" id="submitBtn">ç¡®è®¤è¿‡è´¦</button>
    </div>
  </form>
</div>

<!-- äºŒæ¬¡ç¡®è®¤å¼¹çª— -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="confirmModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>æ“ä½œç¡®è®¤
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">ç¡®è®¤è¦æ‰§è¡Œè¿‡è´¦å—ï¼Ÿæ­¤æ“ä½œå°†ä¼šæ›´æ–°åº“å­˜å’Œè®¢å•æ•°æ®ï¼Œä¸”å¯èƒ½æ— æ³•æ’¤é”€ã€‚</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="modalConfirmBtn">ç¡®è®¤è¿‡è´¦</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
  const form = document.querySelector('form');
  const submitBtn = document.getElementById('submitBtn');
  const rows = document.querySelectorAll('tr[data-row]');
  const modal = new bootstrap.Modal(document.getElementById('confirmModal'), { backdrop: false });
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');

  function toNum(v){
    return v === '' || v === null ? NaN : Number(v);
  }

  function validateRow(tr){
    const actualInput = tr.querySelector('.actual');
    const planned = toNum(actualInput.getAttribute('data-planned'));
    const actual = toNum(actualInput.value);
    const errEl = tr.querySelector('[data-error]');
    let ok = true, msg = '';

    if(isNaN(actual)) { ok = false; msg = 'è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—'; }
    else if(actual < 0) { ok = false; msg = 'å®é™…æ•°é‡ä¸èƒ½ä¸ºè´Ÿ'; }
    else if(!isNaN(planned) && actual > planned) { ok = false; msg = `å®é™…æ•°é‡ä¸èƒ½å¤§äºè®¡åˆ’ï¼ˆæœ€å¤§ ${planned}ï¼‰`; }

    if(!ok){
      errEl.textContent = msg;
      errEl.classList.remove('d-none');
      actualInput.classList.add('is-invalid');
    } else {
      errEl.textContent = '';
      errEl.classList.add('d-none');
      actualInput.classList.remove('is-invalid');
    }
    return ok;
  }

  function validateAll(){
    let allOk = true;
    rows.forEach(tr => { if(!validateRow(tr)) allOk = false; });
    if(submitBtn) submitBtn.disabled = !allOk;
    return allOk;
  }

  rows.forEach(tr => {
    const actual = tr.querySelector('.actual');
    if(actual){
      actual.addEventListener('input', validateAll);
      actual.addEventListener('blur', validateAll);
    }
  });

  // æ‹¦æˆªæäº¤
form.addEventListener('submit', function(e){
    e.preventDefault(); // å…ˆé˜»æ­¢é»˜è®¤æäº¤
    if (!validateAll()) {
      return; // ä¸å¼¹çª—ï¼Œç›´æ¥è¿”å›
    }
    // åªæœ‰æ ¡éªŒé€šè¿‡æ‰æ˜¾ç¤ºäºŒæ¬¡ç¡®è®¤æ¡†
    modal.show();
  });

// äºŒæ¬¡ç¡®è®¤æŒ‰é’®ç‚¹å‡»åæ‰æäº¤è¡¨å•
modalConfirmBtn.addEventListener('click', function(){
  modal.hide();
  // ç”¨ setTimeout é¿å… Bootstrap åŠ¨ç”»é˜»å¡æäº¤
  setTimeout(() => form.submit(), 200);
});


  // æ¨¡æ€æ¡†é‡Œçš„â€œç¡®è®¤è¿‡è´¦â€æŒ‰é’®
  modalConfirmBtn.addEventListener('click', function(){
    modal.hide();
    form.submit();
  });

  validateAll();
})();
</script>
{% endblock %}
