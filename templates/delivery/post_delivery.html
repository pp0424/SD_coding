{% extends 'delivery/base.html' %}

{% block title %}å‘è´§å•è¿‡è´¦ - {{ delivery.delivery_note_id }}{% endblock %}

{% block head_extra %}
<style>
  .table-fixed { table-layout: fixed; word-wrap: break-word; }
  .text-right, .text-end { text-align: right; }
  .modal-content { border-radius: 12px; }
  .modal-title { font-weight: 600; }

  .modal { z-index: 2055 !important; }
  .modal-backdrop { z-index: 2050 !important; }
</style>
{% endblock %}

{% block content %}
<div class="form-title-container">
  <h1 class="form-title">ğŸ“œ æ‰§è¡Œè¿‡è´¦ï¼š{{ delivery.delivery_note_id }}</h1>
</div>

<div class="container py-3">
  <p>é”€å”®è®¢å•ï¼š{{ delivery.sales_order_id }} &nbsp; ä»“åº“ï¼š{{ delivery.warehouse_code }}</p>

  <form method="post" id="post-delivery-form" data-items-count="{{ form.items|length }}">
    {{ form.hidden_tag() }}

    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>è¡¨å•éªŒè¯é”™è¯¯ï¼š</strong>
        <ul class="mb-0">
        {% for field, errs in form.errors.items() %}
          {% for err in errs %}
            <li>{{ err }}</li>
          {% endfor %}
        {% endfor %}
        </ul>
      </div>
    {% endif %}

    <table class="table table-bordered table-fixed">
      <thead class="table-light">
        <tr>
          <th style="width: 6%">è¡Œå·</th>
          <th style="width: 6%">ç‰©æ–™ç¼–å·</th>
          <th style="width: 10%" >å•ç‰©æ–™æè¿°</th>
          <th style="width: 8%" >è®¡åˆ’æ•°é‡</th>
          <th style="width: 8%" >å®é™…å‘è´§æ•°é‡</th>
          <th style="width: 18%">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</th>
        </tr>
      </thead>
      <tbody>
        {% for subform in form.items %}
          {% set di = delivery.items[loop.index0] %}
          <tr>
            <td class="align-middle">{{ loop.index }}</td>

            <!-- ç‰©æ–™ç¼–å·åˆ—ï¼šæ˜¾ç¤º material_idï¼Œä¿ç•™éšè—è¡¨å•å­—æ®µæäº¤ -->
            <td class="align-middle">
              {{ subform.material_id(type="hidden") }}
              {{ di.material_id }}
            </td>

            <!-- æè¿°åˆ— -->
            <td>
              {{ subform.item_no(type="hidden") }}

              <div class="align-middle">{{ di.material.description if di.material else '' }}</div>
            </td>

            <!-- è®¡åˆ’æ•°é‡ -->
            <td class="text-right align-middle">
              {{ subform.planned_quantity(class="form-control-plaintext", readonly=true) }}
            </td>

            <!-- å®é™…å‘è´§æ•°é‡ -->
            <td class="text-right">
              {{ subform.actual_quantity(class="form-control form-control-sm text-end", min="0", step="0.0001") }}
            </td>

            <!-- å¤‡æ³¨ -->
            <td>
              <input type="text" 
                    name="items-{{ loop.index0 }}-line_remark" 
                    class="form-control form-control-sm" 
                    placeholder="ä¾‹å¦‚ï¼šçŸ­ç¼º/å¤šå‘è¯´æ˜"
                    value="{{ di.line_remark | default('') }}">
            </td>
          </tr>

          <input type="hidden" name="items-{{ loop.index0 }}-sales_order_item_no" value="{{ di.sales_order_item_no }}">
        {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted">æš‚æ— å‘è´§æ˜ç»†</td>
          </tr>
        {% endfor %}
      </tbody>

    </table>

    <div class="mb-3">
      <label class="form-label">è¿‡è´¦å¤‡æ³¨ï¼ˆè‹¥æœ¬æ¬¡å‘è´§æ•°é‡ä¸è®¡åˆ’ä¸ç¬¦è¯·å¿…å¡«ï¼‰</label>
      {{ form.remarks(class="form-control", rows=3, id="post-remarks") }}
    </div>

    <div class="d-flex gap-2">
      <a href="{{ url_for('delivery.post_list', delivery_id=delivery.delivery_note_id) }}" class="btn btn-secondary">å–æ¶ˆ</a>
      <button id="submit-btn" type="submit" class="btn btn-primary">ç¡®è®¤è¿‡è´¦</button>
    </div>
  </form>
</div>

<!-- æ¨¡æ€æ¡†ï¼ˆåˆå§‹å¯ä»¥åœ¨ content é‡Œï¼›æ˜¾ç¤ºå‰ä¼šè¢« JS æŒªåˆ° body ç›´ä¸‹ï¼‰ -->
<div class="modal fade" id="confirmPostModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-3">
      <div class="modal-header border-0">
        <h5 class="modal-title d-flex align-items-center">
          <span class="fs-3 me-2">ğŸšš</span>
          <span>ç¡®è®¤å‘è´§è¿‡è´¦</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
      </div>

      <div class="modal-body">
        <p class="mb-2">ä½ å°†å¯¹å‘è´§å• <strong id="post-modal-so">{{ delivery.delivery_note_id }}</strong> æ‰§è¡Œ <em>è¿‡è´¦</em> æ“ä½œã€‚</p>
        <ul class="small text-muted mb-2">
          <li>è¯¥æ“ä½œä¼š <strong>æ‰£å‡åº“å­˜</strong> å¹¶ <strong>æ›´æ–°é”€å”®è®¢å•çš„å·²å‘è´§æ•°é‡</strong>ã€‚</li>
          <li>å¦‚æœå®é™…å‘è´§æ•°é‡ä¸è®¡åˆ’ä¸ç¬¦ï¼Œè¯·ç¡®ä¿å·²åœ¨â€œè¿‡è´¦å¤‡æ³¨â€é‡Œå¡«å†™å·®å¼‚è¯´æ˜ã€‚</li>
        </ul>
        <div id="confirm-warning" class="alert alert-warning small mb-0 d-none"></div>
      </div>

      <div class="modal-footer border-0">
        <button data-modal-cancel type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button data-modal-confirm type="button" class="btn btn-primary">
          <span class="modal-confirm-text">ç¡®è®¤å¹¶è¿‡è´¦</span>
          <span class="spinner-border spinner-border-sm modal-spinner d-none ms-2" role="status" aria-hidden="true"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const form = document.getElementById('post-delivery-form');
  const submitBtn = document.getElementById('submit-btn');
  const rows = parseInt(form.dataset.itemsCount || '0', 10);

  function quickValidateAndDetectDiff() {
    let diff = false;
    for (let i = 0; i < rows; i++) {
      const plannedEl = document.querySelector(`[name="items-${i}-planned_quantity"]`);
      const actualEl  = document.querySelector(`[name="items-${i}-actual_quantity"]`);
      if (!plannedEl || !actualEl) continue;

      const planned = parseFloat(plannedEl.value || '0');
      const actual  = parseFloat(actualEl.value || '0');

      if (actual < 0) return { ok: false, message: `ç¬¬ ${i+1} è¡Œå®é™…å‘è´§æ•°é‡ä¸èƒ½ä¸ºè´Ÿ` };
      if (actual > planned + 1e-9) return { ok: false, message: `ç¬¬ ${i+1} è¡Œå®é™…å‘è´§æ•°é‡ (${actual}) ä¸èƒ½å¤§äºè®¡åˆ’æ•°é‡ (${planned})` };
      if (Math.abs(planned - actual) > 1e-9) diff = true;
    }

    const remarksEl = document.getElementById('post-remarks');
    if (diff && (!remarksEl.value || remarksEl.value.trim().length === 0)) {
      return { ok: false, message: 'æ£€æµ‹åˆ°å®é™…å‘è´§æ•°é‡ä¸è®¡åˆ’æ•°é‡ä¸ä¸€è‡´ï¼Œè¯·åœ¨â€œè¿‡è´¦å¤‡æ³¨â€ä¸­è¯´æ˜å·®å¼‚åŸå› ï¼ˆå¿…å¡«ï¼‰ã€‚' };
    }
    return { ok: true, diff: diff };
  }

  // æ‰“å¼€å‰æŠŠæ¨¡æ€æ¡†ç§»åˆ° bodyï¼Œé¿å¼€ä»»ä½•çˆ¶çº§çš„å±‚å ä¸Šä¸‹æ–‡/transform
  function showConfirmModal(prepareFn) {
    const modalEl = document.getElementById('confirmPostModal');
    if (!modalEl) return false;

    // å¦‚æœ‰éœ€è¦ï¼Œå…ˆæ‰§è¡Œå‡†å¤‡é€»è¾‘ï¼ˆå†™å…¥è­¦å‘Šæ–‡æœ¬ç­‰ï¼‰
    if (typeof prepareFn === 'function') {
      try { prepareFn(modalEl); } catch (err) {}
    }

    // å¦‚æœæ¨¡æ€æ¡†ä¸åœ¨ body ç›´ä¸‹ï¼Œç§»åŠ¨è¿‡å»
    if (modalEl.parentNode !== document.body) {
      document.body.appendChild(modalEl);
    }

    // åªç»‘å®šä¸€æ¬¡ç¡®è®¤æŒ‰é’®äº‹ä»¶
    const confirmBtn = modalEl.querySelector('[data-modal-confirm]');
    const spinner = modalEl.querySelector('.modal-spinner');
    const confirmTextEl = modalEl.querySelector('.modal-confirm-text');
    if (!modalEl.dataset.bound) {
      if (confirmBtn) {
        confirmBtn.addEventListener('click', function () {
          confirmBtn.disabled = true;
          if (spinner) spinner.classList.remove('d-none');
          if (confirmTextEl) confirmTextEl.textContent = 'æ­£åœ¨è¿‡è´¦...';
          setTimeout(() => form.requestSubmit(), 80);
        });
      }
      modalEl.addEventListener('hidden.bs.modal', function () {
        if (confirmBtn) confirmBtn.disabled = false;
        if (spinner) spinner.classList.add('d-none');
        if (confirmTextEl) confirmTextEl.textContent = 'ç¡®è®¤å¹¶è¿‡è´¦';
      });
      modalEl.dataset.bound = '1';
    }

    // åˆå§‹åŒ–æˆ–å¤ç”¨å®ä¾‹å¹¶æ˜¾ç¤º
    if (window.bootstrap && typeof bootstrap.Modal === 'function') {
      const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl, { keyboard: true, backdrop: true });
      bsModal.show();
      return true;
    } else {
      // æœªåŠ è½½ Bootstrap JS çš„å…œåº•
      if (window.confirm('ç¡®è®¤è¦å¯¹è¯¥å‘è´§å•æ‰§è¡Œè¿‡è´¦æ“ä½œï¼Ÿ')) form.submit();
      return true;
    }
  }

  if (form && !form.dataset.boundConfirm) {
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      submitBtn.disabled = true;

      const check = quickValidateAndDetectDiff();
      if (!check.ok) {
        alert(check.message);
        submitBtn.disabled = false;
        return false;
      }

      showConfirmModal(function (modalEl) {
        const warnEl = modalEl.querySelector('#confirm-warning');
        if (warnEl) {
          if (check.diff) {
            warnEl.textContent = 'æ£€æµ‹åˆ°å®é™…å‘è´§æ•°é‡ä¸è®¡åˆ’æ•°é‡ä¸ä¸€è‡´ï¼Œè¯·ç¡®è®¤å¹¶åœ¨å¤‡æ³¨ä¸­è¯´æ˜åŸå› ã€‚';
            warnEl.classList.remove('d-none');
          } else {
            warnEl.textContent = '';
            warnEl.classList.add('d-none');
          }
        }
      });

      return false;
    });

    form.dataset.boundConfirm = '1';
  }
})();
</script>
{% endblock %}
