{# templates/delivery/post_delivery.html #}
{% extends 'delivery/base.html' %}
{% block title %}发货单过账 - {{ delivery.delivery_note_id }}{% endblock %}

{% block head_extra %}
<style>
  .table-fixed { table-layout: fixed; word-wrap: break-word; }
  .text-right { text-align: right; }
  .text-end { text-align: right; }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
  <h3>发货单过账：{{ delivery.delivery_note_id }}</h3>
  <p>销售订单：{{ delivery.sales_order_id }} &nbsp; 仓库：{{ delivery.warehouse_code }}</p>

  {# 把 items 长度放到 data-items-count，避免在 JS 中直接写 Jinja 表达式 #}
  <form method="post" id="post-delivery-form" data-items-count="{{ form.items|length }}">
    {{ form.hidden_tag() }}

    <div class="mb-3 row">
      <label class="col-sm-2 col-form-label">实际发货日期</label>
      <div class="col-sm-4">
        {# 如果表单有 data，WTForms 会处理；这里给个默认值备用 #}
        {{ form.actual_delivery_date(class="form-control", value=form.actual_delivery_date.data or (delivery.delivery_date.strftime('%Y-%m-%d') if delivery.delivery_date else '')) }}
      </div>
    </div>

    <table class="table table-bordered table-fixed">
      <thead class="table-light">
        <tr>
          <th style="width: 6%">行号</th>
          <th style="width: 28%">物料编号 / 描述</th>
          <th style="width: 18%" class="text-right">计划数量</th>
          <th style="width: 18%" class="text-right">实际发货数量</th>
          <th style="width: 16%">单位</th>
          <th style="width: 14%">备注（可选）</th>
        </tr>
      </thead>
      <tbody>
        {# 逐行渲染 form.items —— 后端 GET 时会 append_entry 填好初值 #}
        {% for subform in form.items %}
          <tr>
            <td class="align-middle">{{ loop.index }}</td>

            <td>
              {{ subform.material_id(class="form-control-plaintext", readonly=true) }}
              {% set di = delivery.items[loop.index0] %}
              <div class="small text-muted">{{ di.material.description if di.material else '' }}</div>
            </td>

            <td class="text-right align-middle">
              {{ subform.planned_quantity(class="form-control-plaintext", readonly=true) }}
            </td>

            <td class="text-right">
              {{ subform.actual_quantity(class="form-control form-control-sm text-end", min="0", step="0.0001") }}
            </td>

            <td class="align-middle">
              {{ subform.unit(class="form-control-plaintext", readonly=true) }}
            </td>

            <td>
              <input type="text" name="items-{{ loop.index0 }}-line_remark" class="form-control form-control-sm" placeholder="例如：短缺/多发说明">
            </td>
          </tr>

          {# 隐藏字段：把 sales_order_item_no 放到 post 表单里，后端 POST 时读取 #}
          <input type="hidden" name="items-{{ loop.index0 }}-sales_order_item_no" value="{{ delivery.items[loop.index0].sales_order_item_no }}">
        {% endfor %}
      </tbody>
    </table>

    <div class="mb-3">
      <label class="form-label">过账备注（若本次发货数量与计划不符请必填）</label>
      {{ form.remarks(class="form-control", rows=3, id="post-remarks") }}
    </div>

    <div class="d-flex gap-2">
      <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}" class="btn btn-secondary">取消</a>
      <button id="submit-btn" type="submit" class="btn btn-primary">确认过账</button>
    </div>
  </form>
</div>

<script>
(function(){
  const form = document.getElementById('post-delivery-form');
  const submitBtn = document.getElementById('submit-btn');
  const rows = parseInt(form.dataset.itemsCount || '0', 10);

  form.addEventListener('submit', function(e){
    // 防止重复提交
    submitBtn.disabled = true;

    // 验证：如果任意行实际 != 计划，则 require remarks（前端快速校验；服务器端仍会二次校验）
    let diff = false;
    for (let i = 0; i < rows; i++) {
      const plannedEl = document.querySelector(`[name="items-${i}-planned_quantity"]`);
      const actualEl  = document.querySelector(`[name="items-${i}-actual_quantity"]`);
      if (!plannedEl || !actualEl) continue;
      const planned = parseFloat(plannedEl.value || '0');
      const actual  = parseFloat(actualEl.value || '0');
      if (Number.isNaN(planned) || Number.isNaN(actual)) {
        alert(`第 ${i+1} 行数量格式不正确，请检查`);
        submitBtn.disabled = false;
        e.preventDefault();
        return false;
      }
      if (Math.abs(planned - actual) > 1e-9) {
        diff = true;
        break;
      }
    }

    const remarks = document.getElementById('post-remarks');
    if (diff && (!remarks.value || remarks.value.trim().length === 0)) {
      alert('检测到实际发货数量与计划数量不一致，请在“过账备注”中说明差异原因（必填）。');
      submitBtn.disabled = false;
      e.preventDefault();
      return false;
    }

    // 最终确认
    if (!confirm('确认要对该发货单执行过账操作？该操作会扣减库存并更新销售订单已发货数量。')) {
      submitBtn.disabled = false;
      e.preventDefault();
      return false;
    }

    // 允许提交
  });
})();
</script>
{% endblock %}
