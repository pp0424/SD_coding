{# templates/delivery/post_delivery.html #}
{% extends "delivery/base.html" %}
{% block title %}æ‰§è¡Œè¿‡è´¦{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ¡ï¼šå±•ç¤ºå½“å‰å¤„ç†çš„å‘è´§å•å· -->
  <div class="form-title-container">
    <h1 class="form-title">
      ğŸ“œ æ‰§è¡Œè¿‡è´¦ #{{ delivery.delivery_note_id }}
    </h1>
  </div>

  <!-- åŸºæœ¬ä¿¡æ¯æ¦‚è§ˆï¼šå…³è”é”€å”®å•ã€ä»“åº“ä¸å½“å‰çŠ¶æ€ -->
  <div class="px-3 py-2 small text-muted border-bottom">
    é”€å”®è®¢å•ï¼š{{ delivery.sales_order_id }}
    &nbsp;&nbsp;|&nbsp;&nbsp; ä»“åº“ï¼š{{ delivery.warehouse_code }}
    &nbsp;&nbsp;|&nbsp;&nbsp; å½“å‰çŠ¶æ€ï¼š{{ delivery.status }}
  </div>

  <!-- é—ªå­˜æ¶ˆæ¯ï¼šç»Ÿä¸€å±•ç¤ºæˆåŠŸ/è­¦å‘Š/é”™è¯¯ç­‰æç¤º -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="px-3 pt-3">
        {% for category, message in messages %}
          <!-- å°† danger è½¬æ¢ä¸º warning æ ·å¼ä»¥ä¾¿è§†è§‰ç»Ÿä¸€ -->
          <div class="alert alert-{{ 'warning' if category=='danger' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- è¿‡è´¦è¡¨å•ï¼šæäº¤åç”±åç«¯æ‰§è¡Œåº“å­˜ä¸è®¢å•æ›´æ–° -->
  <form method="post" action="{{ url_for('delivery.post_delivery', delivery_id=delivery.delivery_note_id) }}">
    {{ form.csrf_token }} {# CSRF é˜²æŠ¤ #}

    <!-- æ˜ç»†è¡Œè¡¨æ ¼ï¼šåŒ…å«è®¡åˆ’æ•°é‡ä¸å¯ç¼–è¾‘çš„å®é™…æ•°é‡ -->
    <div class="table-responsive">
      <table class="table mb-0 align-middle text-center">
        <thead class="table-light">
          <tr>
            <th>è¡Œå·</th>
            <th>ç‰©æ–™ç¼–å·</th>
            <th>ç‰©æ–™æè¿°</th>
            <th>è®¡åˆ’æ•°é‡</th>
            <th>å®é™…æ•°é‡</th>
            <th>å¤‡æ³¨</th>
          </tr>
        </thead>
        <tbody>
          {% for item_form in form.items %}
            {% set i = loop.index0 %}
            {% set di = delivery.items[i] %}
            <tr data-row="{{ i }}">
              <!-- åªè¯»å±•ç¤ºå­—æ®µï¼ˆæ¥è‡ª delivery.itemsï¼‰ -->
              <td class="text-center">{{ di.item_no }}</td>
              <td class="text-center">{{ di.material_id }}</td>
              <td class="text-start">
                {{ di.material.description }}
              </td>
              <td class="text-end">
                {{ '%.4f'|format(item_form.planned_quantity.data or 0) }}
              </td>

              <!-- å¯ç¼–è¾‘ï¼šå®é™…æ•°é‡ã€‚é€šè¿‡ data-planned å¸¦å…¥è¡Œå†…æ ¡éªŒçš„ä¸Šé™ -->
              <td>
                {{ item_form.actual_quantity(
                    class="form-control text-end actual",
                    step="0.0001",
                    min="0",
                    inputmode="decimal",
                    autocomplete="off",
                    **{'data-planned': item_form.planned_quantity.data or 0}
                ) }}
                <!-- è¡Œå†…æ ¡éªŒé”™è¯¯ä¿¡æ¯å®¹å™¨ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div class="text-danger small mt-1 d-none" data-error></div>
                {% if item_form.actual_quantity.errors %}
                  <!-- åç«¯ WTForms æ ¡éªŒé”™è¯¯ï¼ˆæäº¤åè¿”å›ï¼‰ -->
                  <div class="text-danger small mt-1">
                    {{ item_form.actual_quantity.errors|join('ï¼Œ') }}
                  </div>
                {% endif %}
              </td>

              <!-- è¡Œå¤‡æ³¨ï¼šåç§°ä¸åç«¯è§£æ keys å¯¹é½ items-{i}-line_remark -->
              <td>
                <input
                  type="text"
                  name="items-{{ i }}-line_remark"
                  class="form-control form-control-sm"
                  placeholder="çŸ­å‘/å¤šå‘è¯´æ˜"
                  value="{% if request.method == 'POST' %}{{ request.form.get('items-' ~ i ~ '-line_remark', '') }}{% else %}{{ di.line_remark or '' }}{% endif %}"
                >
              </td>

              <!-- éšè—åŸŸï¼šæäº¤æ‰€éœ€åå°å­—æ®µï¼Œä¿æŒä¸åªè¯»åˆ—åŒæ­¥ -->
              {{ item_form.item_no(type="hidden") }}
              {{ item_form.material_id(type="hidden") }}
              {{ item_form.planned_quantity(type="hidden", class="planned-hidden") }}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- æ•´å•è¿‡è´¦å¤‡æ³¨ï¼šå°†é™„åŠ åˆ°å‘è´§å•å¤‡æ³¨ï¼ˆå¸¦å‰ç¼€ï¼‰ -->
    <div class="p-3 border-top">
      <label class="form-label fw-bold">
        è¿‡è´¦å¤‡æ³¨ <small class="text-muted">(è‹¥ä¸è®¡åˆ’æ•°é‡ä¸ç¬¦è¯·è¡¥å……è¯´æ˜)</small>
      </label>
      {{ form.remarks(class="form-control", rows="3", placeholder="å°†ä»¥ [è¿‡è´¦å¤‡æ³¨] å‰ç¼€è¿½åŠ åˆ°å‘è´§å•å¤‡æ³¨ä¸­") }}
    </div>

    <!-- è¡¨å•æ“ä½œæŒ‰é’®ï¼šå–æ¶ˆè¿”å›è¯¦æƒ… / æäº¤è§¦å‘äºŒæ¬¡ç¡®è®¤ -->
    <div class="p-3 d-flex justify-content-end gap-2 border-top">
      <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}"
         class="btn btn-light">å–æ¶ˆ</a>
      <button type="submit" class="btn btn-primary" id="submitBtn">ç¡®è®¤è¿‡è´¦</button>
    </div>
  </form>
</div>

<!-- äºŒæ¬¡ç¡®è®¤å¼¹çª—ï¼šé¿å…è¯¯æ“ä½œ -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="confirmModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>æ“ä½œç¡®è®¤
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">ç¡®è®¤è¦æ‰§è¡Œè¿‡è´¦å—ï¼Ÿæ­¤æ“ä½œå°†ä¼šæ›´æ–°åº“å­˜å’Œè®¢å•æ•°æ®ï¼Œä¸”å¯èƒ½æ— æ³•æ’¤é”€ã€‚</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="modalConfirmBtn">ç¡®è®¤è¿‡è´¦</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
/**
 * è¿‡è´¦é¡µé¢å‰ç«¯è„šæœ¬ï¼š
 * - è¡Œå†…æ ¡éªŒå®é™…æ•°é‡ï¼ˆæ•°å­—æœ‰æ•ˆã€éè´Ÿã€ä¸è¶…è¿‡è®¡åˆ’ï¼‰
 * - é˜»æ­¢ç›´æ¥æäº¤ï¼Œæ ¡éªŒé€šè¿‡åå¼¹å‡ºäºŒæ¬¡ç¡®è®¤
 * - ç¡®è®¤åå†æäº¤è¡¨å•
 */
(function(){
  // åŸºç¡€ DOM å¼•ç”¨
  const form = document.querySelector('form');
  const submitBtn = document.getElementById('submitBtn');
  const rows = document.querySelectorAll('tr[data-row]');
  // åˆå§‹åŒ– Bootstrap æ¨¡æ€æ¡†ï¼›backdrop: false é¿å…é®ç½©æ‹¦æˆªäº¤äº’ï¼ˆæ ¹æ®éœ€æ±‚å¯æ”¹ä¸º trueï¼‰
  const modal = new bootstrap.Modal(document.getElementById('confirmModal'), { backdrop: false });
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');

  // å·¥å…·ï¼šå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—ï¼›ç©ºä¸²æˆ– null è¿”å› NaN ä»¥ä¾¿ isNaN åˆ¤æ–­
  function toNum(v){
    return v === '' || v === null ? NaN : Number(v);
  }

  /**
   * æ ¡éªŒå•è¡Œï¼š
   * - å®é™…æ•°é‡å¿…é¡»ä¸ºæœ‰æ•ˆæ•°å­—
   * - ä¸èƒ½ä¸ºè´Ÿæ•°
   * - ä¸å¾—å¤§äºè®¡åˆ’æ•°é‡ï¼ˆåŸºäº data-plannedï¼‰
   * æ˜¾ç¤º/éšè—é”™è¯¯ä¿¡æ¯ï¼Œå¹¶åˆ‡æ¢è¾“å…¥æ¡†çš„ is-invalid æ ·å¼
   */
  function validateRow(tr){
    const actualInput = tr.querySelector('.actual');
    const planned = toNum(actualInput.getAttribute('data-planned'));
    const actual = toNum(actualInput.value);
    const errEl = tr.querySelector('[data-error]');
    let ok = true, msg = '';

    if(isNaN(actual)) { ok = false; msg = 'è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—'; }
    else if(actual < 0) { ok = false; msg = 'å®é™…æ•°é‡ä¸èƒ½ä¸ºè´Ÿ'; }
    else if(!isNaN(planned) && actual > planned) { ok = false; msg = `å®é™…æ•°é‡ä¸èƒ½å¤§äºè®¡åˆ’ï¼ˆæœ€å¤§ ${planned}ï¼‰`; }

    if(!ok){
      errEl.textContent = msg;
      errEl.classList.remove('d-none');
      actualInput.classList.add('is-invalid');
    } else {
      errEl.textContent = '';
      errEl.classList.add('d-none');
      actualInput.classList.remove('is-invalid');
    }
    return ok;
  }

  /**
   * æ ¡éªŒæ‰€æœ‰è¡Œï¼š
   * - é€è¡Œè°ƒç”¨ validateRow
   * - æ ¹æ®æ±‡æ€»ç»“æœå¯ç”¨/ç¦ç”¨æäº¤æŒ‰é’®
   */
  function validateAll(){
    let allOk = true;
    rows.forEach(tr => { if(!validateRow(tr)) allOk = false; });
    if(submitBtn) submitBtn.disabled = !allOk;
    return allOk;
  }

  // ç»‘å®šè¾“å…¥ä¸å¤±ç„¦äº‹ä»¶ï¼šå®æ—¶æ ¡éªŒ
  rows.forEach(tr => {
    const actual = tr.querySelector('.actual');
    if(actual){
      actual.addEventListener('input', validateAll);
      actual.addEventListener('blur', validateAll);
    }
  });

  /**
   * æ‹¦æˆªè¡¨å•æäº¤ï¼š
   * - å…ˆé˜»æ­¢é»˜è®¤æäº¤
   * - æ ¡éªŒä¸é€šè¿‡ï¼šç›´æ¥è¿”å›
   * - æ ¡éªŒé€šè¿‡ï¼šå¼¹å‡ºäºŒæ¬¡ç¡®è®¤æ¨¡æ€æ¡†
   */
  form.addEventListener('submit', function(e){
    e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤æµç¨‹
    if (!validateAll()) {
      return; // ä¸å¼¹çª—ï¼Œç­‰å¾…ç”¨æˆ·ä¿®æ­£è¾“å…¥
    }
    modal.show(); // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
  });

  /**
   * äºŒæ¬¡ç¡®è®¤æŒ‰é’®ï¼š
   * - éšè—æ¨¡æ€æ¡†åæ­£å¼æäº¤è¡¨å•
   * - ä½¿ç”¨ setTimeout ç•¥å»¶è¿Ÿï¼Œé¿å…å…³é—­åŠ¨ç”»å½±å“æäº¤
   */
  modalConfirmBtn.addEventListener('click', function(){
    modal.hide();
    setTimeout(() => form.submit(), 200);
  });

  // æ³¨æ„ï¼šä¸‹é¢è¿™æ®µæ˜¯é‡å¤çš„æäº¤ç›‘å¬ï¼Œä¼šå¯¼è‡´æäº¤ä¸¤æ¬¡ï¼Œå»ºè®®åˆ é™¤ä¿ç•™ä¸Šé¢å¸¦ setTimeout çš„ç‰ˆæœ¬
  // modalConfirmBtn.addEventListener('click', function(){
  //   modal.hide();
  //   form.submit();
  // });

  // åˆå§‹æ‰§è¡Œä¸€æ¬¡æ ¡éªŒä»¥è®¾ç½®æŒ‰é’®çŠ¶æ€
  validateAll();
})();
</script>
{% endblock %}