{% extends 'delivery/base.html' %}

{% block title %}å‘è´§å•è¿‡è´¦ - {{ delivery.delivery_note_id }}{% endblock %}

{% block head_extra %}
<style>
  .table-fixed { table-layout: fixed; word-wrap: break-word; }
  .text-right, .text-end { text-align: right; }
  .modal-content { border-radius: 12px; }
  .modal-title { font-weight: 600; }
  .modal { z-index: 2055 !important; }
  .modal-backdrop { z-index: 2050 !important; }
</style>
{% endblock %}

{% block content %}
<div class="form-title-container">
  <h1 class="form-title">ğŸ“œ æ‰§è¡Œè¿‡è´¦ï¼š{{ delivery.delivery_note_id }}</h1>
</div>

<div class="container py-3">
  <p>é”€å”®è®¢å•ï¼š{{ delivery.sales_order_id }} &nbsp; ä»“åº“ï¼š{{ delivery.warehouse_code }}</p>

  <form method="post" id="post-delivery-form" data-items-count="{{ form.items|length }}">
    {{ form.hidden_tag() }}

    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>è¡¨å•éªŒè¯é”™è¯¯ï¼š</strong>
        <ul class="mb-0">
        {% for field, errs in form.errors.items() %}
          {% for err in errs %}
            <li>{{ err }}</li>
          {% endfor %}
        {% endfor %}
        </ul>
      </div>
    {% endif %}

    <table class="table table-bordered table-fixed">
      <thead class="table-light">
        <tr>
          <th style="width:6%">è¡Œå·</th>
          <th style="width:6%">ç‰©æ–™ç¼–å·</th>
          <th style="width:10%">å•ç‰©æ–™æè¿°</th>
          <th style="width:8%">è®¡åˆ’æ•°é‡</th>
          <th style="width:8%">å®é™…å‘è´§æ•°é‡</th>
          <th style="width:18%">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</th>
        </tr>
      </thead>
      <tbody>
        {% for subform in form.items %}
          {% set di = delivery.items[loop.index0] %}
          <tr>
            <td class="align-middle">{{ loop.index }}</td>
            <td class="align-middle">
              {{ subform.material_id(type="hidden") }}
              {{ di.material_id }}
            </td>
            <td>
              {{ subform.item_no(type="hidden") }}
              <div class="align-middle">{{ di.material.description if di.material else '' }}</div>
            </td>
            <td class="text-right align-middle">{{ subform.planned_quantity(class="form-control-plaintext", readonly=true) }}</td>
            <td class="text-right">
              {{ subform.actual_quantity(class="form-control form-control-sm text-end", min="0", step="0.0001") }}
            </td>
            <td>
              <input type="text"
                     name="items-{{ loop.index0 }}-line_remark"
                     class="form-control form-control-sm"
                     placeholder="ä¾‹å¦‚ï¼šçŸ­ç¼º/å¤šå‘è¯´æ˜"
                     value="{{ di.line_remark | default('') }}">
            </td>
          </tr>
          <input type="hidden" name="items-{{ loop.index0 }}-sales_order_item_no" value="{{ di.sales_order_item_no }}">
        {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted">æš‚æ— å‘è´§æ˜ç»†</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="mb-3">
      <label class="form-label">è¿‡è´¦å¤‡æ³¨ï¼ˆè‹¥æœ¬æ¬¡å‘è´§æ•°é‡ä¸è®¡åˆ’ä¸ç¬¦è¯·å¿…å¡«ï¼‰</label>
      {{ form.remarks(class="form-control", rows=3, id="post-remarks") }}
    </div>

    <div class="d-flex gap-2 justify-content-end">
      <a href="{{ url_for('delivery.post_list', delivery_id=delivery.delivery_note_id) }}" class="btn btn-secondary">å–æ¶ˆ</a>
      <button type="button" id="open-confirm-post" class="btn btn-primary">ç¡®è®¤è¿‡è´¦</button>
    </div>
  </form>
</div>

<!-- äºŒæ¬¡ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="confirmPostModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-3">
      <div class="modal-header border-0">
        <h5 class="modal-title d-flex align-items-center">
          <span class="fs-3 me-2">ğŸšš</span>
          <span>ç¡®è®¤å‘è´§è¿‡è´¦</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
      </div>
      <div class="modal-body">
        <p>ä½ å°†å¯¹å‘è´§å• <strong id="post-modal-so">{{ delivery.delivery_note_id }}</strong> æ‰§è¡Œ <em>è¿‡è´¦</em> æ“ä½œã€‚</p>
        <ul class="small text-muted mb-2">
          <li>æ­¤æ“ä½œå°† <strong>æ‰£å‡åº“å­˜</strong> å¹¶ <strong>æ›´æ–°é”€å”®è®¢å•çš„å·²å‘è´§æ•°é‡</strong>ã€‚</li>
          {% if form.items|length > 0 %}
          <li>æœ¬æ¬¡å°†å¤„ç† <strong>{{ form.items|length }}</strong> è¡Œæ˜ç»†ã€‚</li>
          {% endif %}
        </ul>
        <div id="confirm-warning" class="alert alert-warning small mb-0 d-none"></div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" id="confirm-post-btn" class="btn btn-primary">
          <span class="modal-confirm-text">ç¡®è®¤å¹¶è¿‡è´¦</span>
          <span class="spinner-border spinner-border-sm modal-spinner d-none ms-2" role="status" aria-hidden="true"></span>
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('post-delivery-form');
  const openBtn = document.getElementById('open-confirm-post');
  const modalEl = document.getElementById('confirmPostModal');
  const confirmBtn = document.getElementById('confirm-post-btn');
  const spinner = confirmBtn.querySelector('.modal-spinner');
  const confirmText = confirmBtn.querySelector('.modal-confirm-text');
  const warnEl = modalEl.querySelector('#confirm-warning');
  const rows = parseInt(form.dataset.itemsCount || '0', 10);

  if (!form || !modalEl || !openBtn || !confirmBtn) return;

  // å°†æ¨¡æ€æ¡†ç§»åˆ° body ä¸‹
  if (modalEl.parentNode !== document.body) document.body.appendChild(modalEl);
  const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl, { keyboard: true, backdrop: true });

  // æ ¡éªŒå‡½æ•°
  function validate() {
    let diff = false;
    for (let i = 0; i < rows; i++) {
      const plannedEl = form.querySelector(`[name="items-${i}-planned_quantity"]`);
      const actualEl = form.querySelector(`[name="items-${i}-actual_quantity"]`);
      if (!plannedEl || !actualEl) continue;
      const planned = parseFloat(plannedEl.value || 0);
      const actual = parseFloat(actualEl.value || 0);
      if (actual < 0) return { ok: false, message: `ç¬¬ ${i+1} è¡Œå®é™…å‘è´§æ•°é‡ä¸èƒ½ä¸ºè´Ÿ` };
      if (actual > planned + 1e-9) return { ok: false, message: `ç¬¬ ${i+1} è¡Œå®é™…å‘è´§æ•°é‡ä¸èƒ½å¤§äºè®¡åˆ’æ•°é‡` };
      if (Math.abs(planned - actual) > 1e-9) diff = true;
    }
    const remarksEl = document.getElementById('post-remarks');
    if (diff && (!remarksEl.value.trim())) return { ok: false, message: 'å·®å¼‚æ•°é‡è¯·åœ¨å¤‡æ³¨ä¸­è¯´æ˜' };
    return { ok: true, diff };
  }

  // æ‰“å¼€æ¨¡æ€æ¡†
  openBtn.addEventListener('click', () => {
    const check = validate();
    if (!check.ok) { alert(check.message); return; }

    if (check.diff) {
      warnEl.textContent = 'æ£€æµ‹åˆ°å®é™…å‘è´§æ•°é‡ä¸è®¡åˆ’æ•°é‡ä¸ä¸€è‡´ï¼Œè¯·ç¡®è®¤å¹¶åœ¨å¤‡æ³¨ä¸­è¯´æ˜åŸå› ã€‚';
      warnEl.classList.remove('d-none');
    } else {
      warnEl.classList.add('d-none');
    }
    bsModal.show();
  });

  // ç¡®è®¤æŒ‰é’®é€»è¾‘ï¼ˆå¸¦ loading & é˜²é‡å¤ç‚¹å‡»ï¼‰
  confirmBtn.addEventListener('click', () => {
    confirmBtn.disabled = true;
    spinner.classList.remove('d-none');
    confirmText.textContent = 'æ­£åœ¨è¿‡è´¦...';

    // ç”¨ form.submit æäº¤ï¼ˆä¿ç•™ CSRF æ”¯æŒï¼‰
    form.dataset.allowSubmit = 'true';
    form.submit();
  });

  // modal éšè—æ—¶æ¢å¤æŒ‰é’®çŠ¶æ€
  modalEl.addEventListener('hidden.bs.modal', () => {
    confirmBtn.disabled = false;
    spinner.classList.add('d-none');
    confirmText.textContent = 'ç¡®è®¤å¹¶è¿‡è´¦';
  });

  // é˜»æ­¢å›è½¦ç›´æ¥æäº¤ï¼Œç»Ÿä¸€æµç¨‹
  form.addEventListener('submit', e => {
    if (!form.dataset.allowSubmit) {
      e.preventDefault();
      openBtn.click();
    }
  });
});
</script>
{% endblock %}
