{# templates/delivery/post_delivery.html #}
{% extends "delivery/base.html" %}
{% block title %}执行过账{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
  <!-- 顶部标题条 -->
<div class="form-title-container">
    <h1 class="form-title">
      📜 执行过账 #{{ delivery.delivery_note_id }}
    </h1>
  </div>

  <!-- 基本信息 -->
  <div class="px-3 py-2 small text-muted border-bottom">
    销售订单：{{ delivery.sales_order_id }}
    &nbsp;&nbsp;|&nbsp;&nbsp; 仓库：{{ delivery.warehouse_code }}
    &nbsp;&nbsp;|&nbsp;&nbsp; 当前状态：{{ delivery.status }}
  </div>

  <!-- 闪存消息 -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="px-3 pt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'warning' if category=='danger' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- 表单 -->
  <form method="post" action="{{ url_for('delivery.post_delivery', delivery_id=delivery.delivery_note_id) }}">
    {{ form.csrf_token }}

    <div class="table-responsive">
      <table class="table mb-0 align-middle text-center">
        <thead class="table-light">
          <tr>
            <th>行号</th>
            <th>物料编号</th>
            <th>物料描述</th>
            <th>计划数量</th>
            <th>实际数量</th>
            <th>备注</th>
          </tr>
        </thead>
        <tbody>
          {% for item_form in form.items %}
            {% set i = loop.index0 %}
            {% set di = delivery.items[i] %}
            <tr data-row="{{ i }}">
              <!-- 展示用文本 -->
              <td class="text-center">{{ di.item_no }}</td>
              <td class="text-center">{{ di.material_id }}</td>
              <td class="text-start">
                {{ di.material.description }}
              </td>
              <td class="text-end">
                {{ '%.4f'|format(item_form.planned_quantity.data or 0) }}
              </td>

              <!-- 可编辑输入 -->
              <td>
                {{ item_form.actual_quantity(
                    class="form-control text-end actual",
                    step="0.0001",
                    min="0",
                    inputmode="decimal",
                    autocomplete="off",
                    **{'data-planned': item_form.planned_quantity.data or 0}
                ) }}
                <div class="text-danger small mt-1 d-none" data-error></div>
                {% if item_form.actual_quantity.errors %}
                  <div class="text-danger small mt-1">
                    {{ item_form.actual_quantity.errors|join('，') }}
                  </div>
                {% endif %}
              </td>

              <!-- 行备注：与后端 request.form.get(f"items-{i}-line_remark") 对齐 -->
              <td>
                <input
                  type="text"
                  name="items-{{ i }}-line_remark"
                  class="form-control form-control-sm"
                  placeholder="短发/多发说明"
                  value="{% if request.method == 'POST' %}{{ request.form.get('items-' ~ i ~ '-line_remark', '') }}{% else %}{{ di.line_remark or '' }}{% endif %}"
                >
              </td>

              <!-- 隐藏域：提交所需的后台字段 -->
              {{ item_form.item_no(type="hidden") }}
              {{ item_form.material_id(type="hidden") }}
              {{ item_form.planned_quantity(type="hidden", class="planned-hidden") }}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- 过账备注 -->
    <div class="p-3 border-top">
      <label class="form-label fw-bold">
        过账备注 <small class="text-muted">(若与计划数量不符请补充说明)</small>
      </label>
      {{ form.remarks(class="form-control", rows="3", placeholder="将以 [过账备注] 前缀追加到发货单备注中") }}
    </div>

    <!-- 按钮 -->
    <div class="p-3 d-flex justify-content-end gap-2 border-top">
      <a href="{{ url_for('delivery.delivery_detail', delivery_id=delivery.delivery_note_id) }}"
         class="btn btn-light">取消</a>
      <button type="submit" class="btn btn-primary" id="submitBtn">确认过账</button>
    </div>
  </form>
</div>

<!-- 二次确认弹窗 -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="confirmModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>操作确认
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">确认要执行过账吗？此操作将会更新库存和订单数据，且可能无法撤销。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="modalConfirmBtn">确认过账</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
  const form = document.querySelector('form');
  const submitBtn = document.getElementById('submitBtn');
  const rows = document.querySelectorAll('tr[data-row]');
  const modal = new bootstrap.Modal(document.getElementById('confirmModal'), { backdrop: false });
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');

  function toNum(v){
    return v === '' || v === null ? NaN : Number(v);
  }

  function validateRow(tr){
    const actualInput = tr.querySelector('.actual');
    const planned = toNum(actualInput.getAttribute('data-planned'));
    const actual = toNum(actualInput.value);
    const errEl = tr.querySelector('[data-error]');
    let ok = true, msg = '';

    if(isNaN(actual)) { ok = false; msg = '请输入有效数字'; }
    else if(actual < 0) { ok = false; msg = '实际数量不能为负'; }
    else if(!isNaN(planned) && actual > planned) { ok = false; msg = `实际数量不能大于计划（最大 ${planned}）`; }

    if(!ok){
      errEl.textContent = msg;
      errEl.classList.remove('d-none');
      actualInput.classList.add('is-invalid');
    } else {
      errEl.textContent = '';
      errEl.classList.add('d-none');
      actualInput.classList.remove('is-invalid');
    }
    return ok;
  }

  function validateAll(){
    let allOk = true;
    rows.forEach(tr => { if(!validateRow(tr)) allOk = false; });
    if(submitBtn) submitBtn.disabled = !allOk;
    return allOk;
  }

  rows.forEach(tr => {
    const actual = tr.querySelector('.actual');
    if(actual){
      actual.addEventListener('input', validateAll);
      actual.addEventListener('blur', validateAll);
    }
  });

  // 拦截提交
form.addEventListener('submit', function(e){
    e.preventDefault(); // 先阻止默认提交
    if (!validateAll()) {
      return; // 不弹窗，直接返回
    }
    // 只有校验通过才显示二次确认框
    modal.show();
  });

// 二次确认按钮点击后才提交表单
modalConfirmBtn.addEventListener('click', function(){
  modal.hide();
  // 用 setTimeout 避免 Bootstrap 动画阻塞提交
  setTimeout(() => form.submit(), 200);
});


  // 模态框里的“确认过账”按钮
  modalConfirmBtn.addEventListener('click', function(){
    modal.hide();
    form.submit();
  });

  validateAll();
})();
</script>
{% endblock %}
