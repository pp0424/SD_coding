{# 
  æ¨¡æ¿åŠŸèƒ½ï¼šå‘è´§å•å·æŸ¥è¯¢å¼¹å‡ºçª—å£
  ç»§æ‰¿ï¼šdelivery/base_popup.htmlï¼ˆç”¨äºå¼¹å‡ºå¼é¡µé¢çš„åŸºç¡€å¸ƒå±€ï¼‰
#}
{% extends 'delivery/base_popup.html' %}
{% block title %}å‘è´§å•å·æŸ¥è¯¢{% endblock %}

{% block content %}

<div class="card gradient-bg shadow-sm">
  <!-- ===== å¡ç‰‡å¤´éƒ¨ ===== -->
  <div class="card-header position-relative py-3 text-center">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <strong class="text-white fs-5">ğŸ” å‘è´§å•å·æŸ¥è¯¢</strong>
    <!-- å…³é—­æŒ‰é’®ï¼ˆç»å¯¹å®šä½åœ¨å³ä¾§ä¸­éƒ¨ï¼‰ -->
    <button type="button" class="btn btn-sm btn-outline-light position-absolute top-50 end-0 translate-middle-y me-2"
            onclick="window.close()">å…³é—­</button>
  </div>

  <!-- ===== æœç´¢è¡¨å•åŒºåŸŸ ===== -->
  <div class="card-body">
    <form method="get" class="row g-2 mb-3">
      <!-- å®¢æˆ·IDè¾“å…¥æ¡† -->
      <div class="col-md-3">
        <input type="text" name="customer_id" 
               value="{{ request.args.get('customer_id','') }}" 
               class="form-control" placeholder="å®¢æˆ·ID">
      </div>
      <!-- çŠ¶æ€ä¸‹æ‹‰æ¡† -->
      <div class="col-md-3">
        <select name="status" class="form-select">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
          {% for st in ['å·²åˆ›å»º','å·²æ‹£è´§','å·²å‘è´§','å·²è¿‡è´¦','å·²å–æ¶ˆ'] %}
          <!-- ä¿ç•™å½“å‰é€‰æ‹©çš„çŠ¶æ€ -->
          <option value="{{ st }}" {% if request.args.get('status') == st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- å‘è´§æ—¥æœŸèµ·å§‹ -->
      <div class="col-md-3">
        <input type="date" name="date_from" 
               value="{{ request.args.get('date_from','') }}" 
               class="form-control">
      </div>
      <!-- å‘è´§æ—¥æœŸç»“æŸ -->
      <div class="col-md-3">
        <input type="date" name="date_to" 
               value="{{ request.args.get('date_to','') }}" 
               class="form-control">
      </div>
      <!-- æŸ¥è¯¢æŒ‰é’® -->
      <div class="col-md-3">
        <button class="btn btn-primary w-100"><i class="bi bi-search"></i> æŸ¥è¯¢</button>
      </div>
    </form>

    <!-- ===== æŸ¥è¯¢ç»“æœè¡¨æ ¼ ===== -->
    {% if items %}
    <div class="table-responsive" style="max-height: 60vh;">
      <table class="table table-hover table-sm align-middle">
        <thead class="table-light sticky-top">
          <tr>
            <th>å®¢æˆ·ID</th>
            <th>å‘è´§æ—¥æœŸ</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {% for r in items %}
          <tr>
            <!-- å®¢æˆ·IDï¼šæ¥è‡ªå…³è”çš„é”€å”®è®¢å•ï¼Œè‹¥ä¸å­˜åœ¨æ˜¾ç¤º '-' -->
            <td>{{ r.sales_order.customer_id if r.sales_order else '-' }}</td>
            <!-- æ ¼å¼åŒ–å‘è´§æ—¥æœŸ -->
            <td>{{ r.delivery_date.strftime('%Y-%m-%d') }}</td>
            <!-- å‘è´§çŠ¶æ€ -->
            <td>{{ r.status }}</td>
            <td>
              <!-- æ“ä½œæŒ‰é’®ï¼šé€‰æ‹©å½“å‰å‘è´§å•ï¼Œä½¿ç”¨ data å±æ€§ä¼ é€’å‘è´§å•ID -->
              <!-- tojson æ³¨é‡Šï¼šåŸæœ¬å¯ç”¨äºå¤„ç†å¤æ‚å¯¹è±¡ï¼Œè¿™é‡Œç›´æ¥å­˜æ”¾ ID -->
              <button type="button" class="btn btn-success btn-sm"
                data-delivery-note-id="{{ r.delivery_note_id }}"
                onclick="selectDelivery(this)">
                é€‰æ‹©
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ===== åˆ†é¡µç»„ä»¶ ===== -->
    {% if pagination %}
    <div class="d-flex justify-content-between mt-2">
      <!-- å½“å‰é¡µä¿¡æ¯ -->
      <span class="text-white small">ç¬¬ {{ pagination.page }} / {{ pagination.pages }} é¡µï¼Œå…± {{ pagination.total }} æ¡</span>
      <!-- ä¸Šä¸€é¡µ / ä¸‹ä¸€é¡µæŒ‰é’® -->
      <div class="btn-group">
        {% if pagination.has_prev %}
        <a class="btn btn-sm btn-outline-light" 
           href="{{ url_for('delivery.delivery_helper', page=pagination.page-1, **args) }}">ä¸Šä¸€é¡µ</a>
        {% endif %}
        {% if pagination.has_next %}
        <a class="btn btn-sm btn-outline-light" 
           href="{{ url_for('delivery.delivery_helper', page=pagination.page+1, **args) }}">ä¸‹ä¸€é¡µ</a>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% elif request.args %}
    <!-- æ²¡æœ‰æ‰¾åˆ°åŒ¹é…æ•°æ®æ—¶çš„æç¤º -->
    <div class="text-white">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…è®°å½•</div>
    {% endif %}
  </div>
</div>

<!-- ===== JavaScriptï¼šé€‰æ‹©å¹¶å›å¡«æ•°æ®åˆ°çˆ¶çª—å£ ===== -->
<script>
function selectDelivery(btn) {
  try {
    // æ£€æŸ¥çˆ¶çª—å£æ˜¯å¦å­˜åœ¨
    if (!window.opener || window.opener.closed) {
      alert('çˆ¶çª—å£å·²å…³é—­æˆ–ä¸å­˜åœ¨ï¼Œæ— æ³•å›å¡«');
      window.close();
      return;
    }

    // è·å–æŒ‰é’®æ‰€åœ¨çš„è¡Œ
    const row = btn.closest('tr');
    const cells = row.querySelectorAll('td');
    
    // æ”¶é›†è¡Œæ•°æ®
    const payload = {
      deliveryNoteId: btn.getAttribute('data-delivery-note-id'),
      customerId: cells[0].textContent.trim(),
      deliveryDate: cells[1].textContent.trim(),
      status: cells[2].textContent.trim()
    };

    console.log('å›å¡«æ•°æ®:', payload);

    // å›å¡«æ–¹æ³•ï¼šä¼˜å…ˆé€šè¿‡ ID æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”¨ name
    const setIfExists = (idOrName, val) => {
      const doc = window.opener.document;
      let el = doc.getElementById(idOrName);
      if (!el) el = doc.querySelector('[name="' + idOrName + '"]');
      if (!el) return false;
      
      if (['INPUT','TEXTAREA','SELECT'].includes(el.tagName)) {
        el.value = val;
        // è§¦å‘ input å’Œ change äº‹ä»¶ï¼Œä¿è¯çˆ¶é¡µé¢èƒ½æ„ŸçŸ¥åˆ°å˜æ›´
        el.dispatchEvent(new Event('input', {bubbles: true}));
        el.dispatchEvent(new Event('change', {bubbles: true}));
      } else {
        el.textContent = val;
      }
      return true;
    };

    // å°†å‘è´§å•å·å›å¡«åˆ°çˆ¶çª—å£
    setIfExists('delivery_id', payload.deliveryNoteId);
    
  } catch(err) {
    console.error('å›å¡«å¼‚å¸¸', err);
    alert('å›å¡«å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ï¼š' + (err && err.message));
  } finally {
    // å®Œæˆåå…³é—­å½“å‰å¼¹çª—
    window.close();
  }
}
</script>

<!-- ===== å±€éƒ¨æ ·å¼===== -->
<style>
.gradient-bg { 
  background: linear-gradient(135deg, #5a96f1, #ef7df9); 
  color: #fff; 
  border: none; 
  border-radius: 12px; 
}
.gradient-bg .card-header { 
  background: transparent; 
  border-bottom: 1px solid rgba(255,255,255,0.25); 
}
.table-hover tbody tr:hover { 
  background-color: rgba(255,255,255,0.06); 
}
.btn-outline-light { 
  color:#fff; 
  border-color: rgba(255,255,255,0.6); 
}
</style>

{% endblock %}
