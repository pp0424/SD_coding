<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>文件流信息 - 单据详情</title>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f7f9fc;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      border-radius: 8px;
      padding: 25px 30px;
    }
    header h1 {
      font-weight: 700;
      margin-bottom: 20px;
      color: #2c3e50;
      border-bottom: 2px solid #2980b9;
      padding-bottom: 8px;
    }
    h2.section-title {
      margin-top: 35px;
      color: #2980b9;
      font-size: 1.6rem;
      border-left: 5px solid #2980b9;
      padding-left: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    h2.section-title i {
      color: #2980b9;
    }
    section {
      margin-top: 20px;
    }
    p {
      margin: 6px 0;
      line-height: 1.5;
    }
    ul {
      list-style: none;
      padding-left: 0;
      margin: 8px 0 16px 0;
    }
    ul li {
      background: #eef6fc;
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 6px;
      font-size: 0.95rem;
      border-left: 4px solid #2980b9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: left;
      font-size: 0.95rem;
    }
    th {
      background: #2980b9;
      color: white;
    }
    .footer {
      margin-top: 50px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
      text-align: center;
      font-size: 0.9rem;
      color: #666;
    }
    .status {
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 15px;
      font-size: 0.85rem;
      color: white;
      display: inline-block;
      text-transform: capitalize;
    }
    .complete {
      background-color: #27ae60;
    }
    .in-progress {
      background-color: #f39c12;
    }
    .not-complete {
      background-color: #c0392b;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>文件流信息 - 单据详情</h1>
    </header>

    {% if invoice %}
    <section>
      <h2 class="section-title">
        <i class="fas fa-file-invoice-dollar"></i>
        发票详情 (Invoice)
      </h2>
      <p><strong>发票编号：</strong> {{ invoice.invoice_id }}</p>
      <p><strong>客户编号：</strong> {{ invoice.customer_id }}</p>
      <p><strong>发票日期：</strong> {{ invoice.invoice_date }}</p>
      <p><strong>关联销售订单：</strong> 
        {% if sales_order %}
          {{ sales_order.sales_order_id }}
        {% else %}
          无
        {% endif %}
      </p>

      <h3>发票项目</h3>
      {% if invoice_items %}
      <table>
        <thead>
          <tr>
            <th>物料编号</th>
            <th>描述</th>
            <th>数量</th>
            <th>单位</th>
            <th>单价</th>
            <th>总价</th>
          </tr>
        </thead>
        <tbody>
          {% for item in invoice_items %}
          <tr>
            <td>{{ item.material_id }}</td>
            <td>{{ item.description or '--' }}</td>
            <td>{{ item.invoiced_quantity }}</td>
            <td>{{ item.unit }}</td>
            <td>{{ "%.2f"|format(item.unit_price) }}</td>
            <td>{{ "%.2f"|format(item.invoiced_quantity * item.unit_price) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>无发票项目数据</p>
      {% endif %}

      <h3>付款信息</h3>
      {% if payments %}
      <table>
        <thead>
          <tr>
            <th>付款编号</th>
            <th>金额</th>
            <th>付款日期</th>
            <th>支付方式</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in payments %}
          <tr>
            <td>{{ payment.payment_id }}</td>
            <td>{{ "%.2f"|format(payment.payment_amount) }}</td>
            <td>{{ payment.payment_date }}</td>
            <td>{{ payment.payment_method or '--' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>无付款信息</p>
      {% endif %}

      <h3>发货信息</h3>
      {% if delivery_info %}
      {% for delivery in delivery_info %}
      <div style="margin-bottom: 15px;">
        <strong>发货单编号：</strong> {{ delivery.note.delivery_note_id }} <br />
        <strong>发货日期：</strong> {{ delivery.note.delivery_date }} <br />
        <strong>状态：</strong> {{ delivery.note.status or '未知' }}
        <table style="margin-top: 8px;">
          <thead>
            <tr>
              <th>物料编号</th>
              <th>描述</th>
              <th>数量</th>
              <th>单位</th>
            </tr>
          </thead>
          <tbody>
            {% for d_item in delivery.items %}
            <tr>
              <td>{{ d_item.material_id }}</td>
              <td>{{ d_item.description or '--' }}</td>
              <td>{{ d_item.quantity }}</td>
              <td>{{ d_item.unit or '--' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endfor %}
      {% else %}
      <p>更多发货信息请到发货模块查看</p>
      {% endif %}
    </section>

    {% elif sales_order %}
    <section>
      <h2 class="section-title">
        <i class="fas fa-file-alt"></i>
        销售订单详情 (Sales Order)
      </h2>
      <p><strong>订单编号：</strong> {{ sales_order.sales_order_id }}</p>
      <p><strong>客户编号：</strong> {{ sales_order.customer_id }}</p>
      <p><strong>订单日期：</strong> {{ sales_order.order_date }}</p>
      <p><strong>订单状态：</strong> {{ sales_order.status or '未知' }}</p>

      <h3>订单明细</h3>
      {% if sales_order.items %}
      <table>
        <thead>
          <tr>
            <th>物料编号</th>
            <th>描述</th>
            <th>数量</th>
            <th>单位</th>
          </tr>
        </thead>
        <tbody>
          {% for item in sales_order.items %}
          <tr>
            <td>{{ item.material_id }}</td>
            <td>{{ item.description or '--' }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.unit }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>无订单明细数据</p>
      {% endif %}

      <h3>关联发票</h3>
      {% if invoices %}
      <ul>
        {% for inv in invoices %}
        <li>发票编号: {{ inv.invoice_id }} | 日期: {{ inv.invoice_date }} | 状态: {{ inv.status or '未知' }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <p>无相关发票</p>
      {% endif %}

      <h3>发货单</h3>
      {% if delivery_notes %}
      <ul>
        {% for dn in delivery_notes %}
        <li>发货单编号: {{ dn.delivery_note_id }} | 日期: {{ dn.delivery_date }} | 状态: {{ dn.status or '未知' }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <p>无发货单</p>
      {% endif %}
    </section>

    {% elif delivery %}
    <section>
      <h2 class="section-title">
        <i class="fas fa-truck"></i>
        发货单详情 (Delivery Note)
      </h2>
      <p><strong>发货单编号：</strong> {{ delivery.delivery_note_id }}</p>
      <p><strong>客户编号：</strong> {{ delivery.customer_id }}</p>
      <p><strong>发货日期：</strong> {{ delivery.delivery_date }}</p>
      <p><strong>发货状态：</strong> {{ delivery.status or '未知' }}</p>

      <h3>发货明细</h3>
      {% if items %}
      <table>
        <thead>
          <tr>
            <th>物料编号</th>
            <th>描述</th>
            <th>数量</th>
            <th>单位</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td>{{ item.material_id }}</td>
            <td>{{ item.description or '--' }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.unit or '--' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>更多发货明细请到发货模块查询</p>
      {% endif %}

      <h3>相关发票</h3>
      {% if related_invoices %}
      <ul>
        {% for inv in related_invoices %}
        <li>发票编号: {{ inv.invoice_id }} | 日期: {{ inv.invoice_date }} | 状态: {{ inv.status or '未知' }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <p>无相关发票</p>
      {% endif %}
    </section>

    {% elif inquiry %}
    <section>
      <h2 class="section-title">
        <i class="fas fa-question-circle"></i>
        询价单详情 (Inquiry)
      </h2>
      <p><strong>询价单编号：</strong> {{ inquiry.inquiry_id }}</p>
      <p><strong>客户编号：</strong> {{ inquiry.customer_id }}</p>
      <p><strong>询价日期：</strong> {{ inquiry.inquiry_date }}</p>
      <p><strong>状态：</strong> {{ inquiry.status or '未知' }}</p>

      {% if inquiry.details %}
      <h3>询价明细</h3>
      <table>
        <thead>
          <tr>
            <th>物料编号</th>
            <th>描述</th>
            <th>数量</th>
            <th>单位</th>
          </tr>
        </thead>
        <tbody>
          {% for detail in inquiry.details %}
          <tr>
            <td>{{ detail.material_id }}</td>
            <td>{{ detail.description or '--' }}</td>
            <td>{{ detail.quantity }}</td>
            <td>{{ detail.unit or '--' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>更多询价明细请到订单模块查询</p>
      {% endif %}
    </section>

    {% elif quotation %}
    <section>
      <h2 class="section-title">
        <i class="fas fa-file-signature"></i>
        报价单详情 (Quotation)
      </h2>
      <p><strong>报价单编号：</strong> {{ quotation.quotation_id }}</p>
      <p><strong>客户编号：</strong> {{ quotation.customer_id }}</p>
      <p><strong>报价日期：</strong> {{ quotation.quotation_date }}</p>
      <p><strong>状态：</strong> {{ quotation.status or '未知' }}</p>

      {% if quotation.details %}
      <h3>报价明细</h3>
      <table>
        <thead>
          <tr>
            <th>物料编号</th>
            <th>描述</th>
            <th>数量</th>
            <th>单位</th>
            <th>单价</th>
            <th>总价</th>
          </tr>
        </thead>
        <tbody>
          {% for detail in quotation.details %}
          <tr>
            <td>{{ detail.material_id }}</td>
            <td>{{ detail.description or '--' }}</td>
            <td>{{ detail.quantity }}</td>
            <td>{{ detail.unit or '--' }}</td>
            <td>{{ "%.2f"|format(detail.unit_price) }}</td>
            <td>{{ "%.2f"|format(detail.line_total) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>更多报价明细请到订单模块查询</p>
      {% endif %}
    </section>

    {% else %}
    <section>
      <p style="color:#c0392b; font-weight:600; font-size:1.1rem;">
        未找到该单据或单据类型不受支持
      </p>
    </section>
    {% endif %}

    <div class="footer">© 2025 ERP财务管理系统</div>
  </div>


    <script>
        // 从后端传入的数据
        
        
        const materialIdElement = document.getElementById('material-id');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const tableBody = document.getElementById('table-body');
        const noDataElement = document.getElementById('no-data');

        let currentIndex = 0;

        function updateTable() {
            tableBody.innerHTML = '';
            if (!materials || materials.length === 0) {
                materialIdElement.textContent = '--';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                noDataElement.style.display = 'block';
                return;
            }

            noDataElement.style.display = 'none';

            const currentMaterial = materials[currentIndex];
            materialIdElement.textContent = currentMaterial.id || '--';

            // 按钮状态
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === materials.length - 1;

            if (!currentMaterial.documents || currentMaterial.documents.length === 0) {
                // 无单据
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 7;
                td.textContent = '该物料暂无单据信息';
                td.style.color = '#888';
                tr.appendChild(td);
                tableBody.appendChild(tr);
                return;
            }

            currentMaterial.documents.forEach(doc => {
                const row = document.createElement('tr');

                let statusClass = '';
                let statusText = '';

                switch (doc.status) {
                    case 'complete':
                        statusClass = 'complete';
                        statusText = 'complete';
                        break;
                    case 'in-progress':
                        statusClass = 'in-progress';
                        statusText = 'in progress';
                        break;
                    case 'not-complete':
                        statusClass = 'not-complete';
                        statusText = 'not complete';
                        break;
                    default:
                        statusClass = '';
                        statusText = doc.status || '';
                }

                row.innerHTML = `
                    <td>${doc.type || '--'}</td>
                    <td class="document-id">${doc.id || '--'}</td>
                    <td>${doc.qty != null ? doc.qty : '--'}</td>
                    <td>${doc.unit || '--'}</td>
                    <td>${doc.price || '--'}</td>
                    <td>${doc.date || '--'}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                updateTable();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentIndex < materials.length - 1) {
                currentIndex++;
                updateTable();
            }
        });

        updateTable();
    </script>
</body>

</html>
