<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发票信息修改系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body {
            background: linear-gradient(135deg, #a8d8ff, #c1e3ff);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto; /* 支持页面滑动 */
        }
        .dashboard {
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: 50px;
        }
        .header {
            background: linear-gradient(135deg, #4da6ff, #80bdff);
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .header-left h1 { font-size: 36px; font-weight: 700; }
        .invoice-number {
            background: rgba(255, 255, 255, 0.25);
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 22px;
            font-weight: 600;
        }
        .content-area { display: flex; flex-wrap: wrap; padding: 30px 40px; gap: 30px; }
        .form-section {
            flex: 1;
            min-width: 300px;
            background: rgba(193, 227, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
        }
        .section-title { color: #2a6fc7; font-size: 24px; margin-bottom: 30px; font-weight: 600; display: flex; align-items: center; }
        .section-title i { margin-right: 15px; font-size: 28px; color: #4da6ff; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 18px; font-weight: 500; margin-bottom: 12px; color: #2a6fc7; display: flex; align-items: center; }
        .input-group label i { margin-right: 12px; width: 36px; height: 36px; background: rgba(77, 166, 255, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .input-group input, .input-group select {
            padding: 14px;
            font-size: 16px;
            border: 2px solid #a8d8ff;
            border-radius: 12px;
            background: white;
            transition: all 0.3s;
        }
        .input-group input:focus, .input-group select:focus { border-color: #4da6ff; outline: none; }
        .save-section {
            flex: 0 0 350px;
            background: linear-gradient(135deg, #80bdff, #4da6ff);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            color: white;
        }
        .btn-save {
            background: white;
            color: #4da6ff;
            border: none;
            padding: 18px 50px;
            font-size: 20px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 20px;
        }
        .btn-save:hover { background: #f0f8ff; }
        .notification {
            position: fixed;
            bottom: 40px;
            right: 40px;
            background: #4da6ff;
            color: white;
            padding: 20px 35px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateX(120%);
            transition: transform 0.4s ease;
            display: flex;
            align-items: center;
            font-size: 18px;
        }
        .notification.show { transform: translateX(0); }
        .notification i { margin-right: 15px; font-size: 28px; }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="header">
        <div class="header-left">
            <h1>发票信息修改</h1>
            <p>修改并保存发票信息</p>
        </div>
        <div class="invoice-number">发票号: {{ invoice.invoice_id }}</div>
    </div>

    <div class="content-area">
        <div class="form-section">
            <div class="section-title"><i class="fas fa-file-invoice"></i> 发票信息编辑</div>
            <div class="form-grid">
                <div class="input-group">
                    <label><i class="fas fa-money-bill-wave"></i> 发票金额 (¥)</label>
                    <input type="number" id="invoice-amount" value="{{ '%.2f'|format(invoice.total_amount or 0) }}" step="0.01">
                </div>
                <div class="input-group">
                    <label><i class="fas fa-receipt"></i> 税额 (¥)</label>
                    <input type="number" id="tax-amount" value="{{ '%.2f'|format(invoice.tax_amount or 0) }}" step="0.01">

                </div>
                <div class="input-group">
                    <label><i class="fas fa-calendar-day"></i> 开票日期</label>
                    <input type="date" id="invoice-date" value="{{ invoice.invoice_date.strftime('%Y-%m-%d') }}">
                </div>
                <div class="input-group">
                    <label><i class="fas fa-clock"></i> 付款期限</label>
                    <input type="date" id="due-date" value="{{ invoice.payment_deadline.strftime('%Y-%m-%d') }}">
                </div>
                <div class="input-group">
                    <label><i class="fas fa-info-circle"></i> 付款状态</label>
                    <select id="payment-status">
                        <option value="未付款" {% if invoice.payment_status == '未付款' %}selected{% endif %}>未付款</option>
                        <option value="已付款" {% if invoice.payment_status == '已付款' %}selected{% endif %}>已付款</option>
                        <option value="部分付款" {% if invoice.payment_status == '部分付款' %}selected{% endif %}>部分付款</option>
                    </select>
                </div>
                <div class="input-group">
                    <label><i class="fas fa-comment-dots"></i> 备注</label>
                    <input type="text" id="remarks" value="{{ invoice.remarks }}">
                </div>
            </div>
        </div>

        <div class="save-section">
            <h2>保存修改</h2>
            <p>确认修改信息无误后，点击下方按钮保存到系统数据库。</p>
            <button class="btn-save" id="save-btn">保存发票信息 <i class="fas fa-save"></i></button>
        </div>
    </div>
</div>

<div class="notification" id="notification">
    <i class="fas fa-check-circle"></i>
    <span>发票信息已成功更新！</span>
</div>

<script>
document.getElementById('save-btn').addEventListener('click', function() {
    const invoiceId = "{{ invoice.invoice_id }}";
    const payload = {
        total_amount: parseFloat(document.getElementById('invoice-amount').value),
        tax_amount: parseFloat(document.getElementById('tax-amount').value),
        invoice_date: document.getElementById('invoice-date').value,
        payment_deadline: document.getElementById('due-date').value,
        payment_status: document.getElementById('payment-status').value,
        remarks: document.getElementById('remarks').value
    };

    if (
    payload.total_amount === "" || isNaN(payload.total_amount) ||
    payload.tax_amount === "" || isNaN(payload.tax_amount) ||
    !payload.invoice_date ||
    !payload.payment_deadline
) {
    alert('请填写所有必填字段');
    return;
}

    fetch(`/finance/update-invoice/${invoiceId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const notification = document.getElementById('notification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                window.location.href = '/finance/';
            }, 3000);
        } else {
            alert('更新失败：' + data.message);
        }
    })
    .catch(err => {
        console.error(err);
        alert('更新过程中发生错误');
    });
});
</script>
</body>
</html>
