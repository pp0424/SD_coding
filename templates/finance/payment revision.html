<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>修改收款记录</title>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d5cb6;
            --primary-light: #e8f4ff;
            --secondary: #5a7eb5;
            --text: #1a3c6c;
            --light-bg: #f0f9ff;
            --card-bg: #ffffff;
            --border: #c2dcff;
            --success: #34a853;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #e6f7ff 0%, #f0f9ff 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        /* 顶部导航 */
        .top-nav {
            display: flex;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            position: relative;
        }
        .nav-buttons {
            display: flex;
            gap: 15px;
            position: absolute;
            left: 0;
        }
        .nav-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.3);
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 115, 232, 0.4);
        }
        .nav-btn i {
            font-size: 1.2rem;
        }
        .page-title {
            text-align: center;
            flex-grow: 1;
            font-size: 2.2rem;
            color: var(--primary-dark);
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        /* 发票信息 */
        .invoice-info {
            display: flex;
            gap: 30px;
            background: var(--card-bg);
            padding: 25px 35px;
            border-radius: 16px;
            box-shadow: 0 5px 20px rgba(0, 100, 255, 0.1);
            margin-bottom: 40px;
        }
        .info-box {
            flex: 1;
        }
        .info-label {
            font-size: 1.1rem;
            color: var(--secondary);
            margin-bottom: 10px;
            font-weight: 600;
        }
        .info-value {
            font-size: 1.5rem;
            color: var(--text);
            font-weight: 700;
            background: var(--primary-light);
            padding: 15px 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            word-break: break-word;
        }
        /* 表单区域 */
        .form-container {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 100, 255, 0.15);
            padding: 40px;
            margin-bottom: 60px;
            position: relative;
            overflow: hidden;
        }
        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 8px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--primary-dark));
        }
        .form-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 30px;
        }
        .form-label {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            color: var(--primary-dark);
            margin-bottom: 15px;
            font-weight: 600;
        }
        .form-label i {
            margin-right: 12px;
            font-size: 1.3rem;
            width: 30px;
            text-align: center;
        }
        .form-input {
            padding: 16px 22px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: #f8fbff;
            color: var(--text);
        }
        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.2);
            outline: none;
            background: white;
        }
        .form-input::placeholder {
            color: #a0c1f1;
        }
        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231a73e8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 22px center;
            background-size: 20px;
        }
        textarea.form-input {
            min-height: 140px;
            resize: vertical;
            line-height: 1.6;
        }
        /* 保存按钮 */
        .save-container {
            display: flex;
            justify-content: flex-end;
            padding: 0 20px;
        }
        .save-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 18px 55px;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
            transition: all 0.3s ease;
        }
        .save-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(26, 115, 232, 0.5);
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
        }
        .save-btn:active {
            transform: translateY(0);
        }
        .save-btn i {
            font-size: 1.4rem;
        }
        /* 响应式设计 */
        @media (max-width: 768px) {
            .invoice-info {
                flex-direction: column;
                gap: 20px;
            }
            .form-container {
                padding: 30px 20px 30px 28px;
            }
            .form-container::before {
                width: 6px;
            }
            .page-title {
                font-size: 1.8rem;
                margin-left: 60px;
            }
            .form-label {
                font-size: 1.1rem;
            }
            .form-input {
                padding: 14px 18px;
            }
            .save-btn {
                padding: 16px 45px;
                font-size: 1.1rem;
            }
        }
        /* 动画效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .form-container {
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        .save-btn {
            animation: pulse 2s infinite;
        }
        /* 表单验证样式 */
        .form-input.invalid {
            border-color: #ea4335;
            background-color: #ffebee;
        }
        .error-message {
            color: #ea4335;
            margin-top: 8px;
            font-size: 0.95rem;
            display: none;
        }
        /* 成功消息样式 */
        .success-alert {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 16px 35px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 5px 20px rgba(52, 168, 83, 0.4);
            z-index: 1000;
            animation: fadeIn 0.5s ease, slideDown 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部导航 -->
        <div class="top-nav">
            <div class="nav-buttons">
                <button class="nav-btn" title="返回上一页" onclick="window.history.back()">
                    <i class="fa fa-arrow-left"></i>
                </button>
                <button
                    class="nav-btn"
                    title="返回首页"
                    onclick="window.location.href='/dashboard'">
                    <i class="fa fa-home"></i>
                </button>
            </div>
            <h1 class="page-title">修改收款记录</h1>
        </div>

        <!-- 发票信息展示 -->
        <section class="invoice-info">
            <div class="info-box">
                <p class="info-label">发票编号</p>
                <p class="info-value">{{ invoice.invoice_id or '无' }}</p>
            </div>
            <div class="info-box">
                <p class="info-label">发票日期</p>
                <p class="info-value">
                    {{ invoice.invoice_date.strftime('%Y-%m-%d') if invoice and invoice.invoice_date else '无' }}
                </p>
            </div>
            <div class="info-box">
                <p class="info-label">发票金额</p>
                <p class="info-value">
                    {{ invoice.total_amount if invoice else '无' }}
                </p>
            </div>
            <div class="info-box">
                <p class="info-label">客户编号</p>
                <p class="info-value">
                    {{ invoice.customer_id if invoice else '无' }}
                </p>
            </div>
        </section>

        <!-- 表单 -->
        <form id="payment-form" class="form-container" onsubmit="return false;">
            <!-- 收款单号显示 -->
            <div class="form-row">
                <label class="form-label" for="payment-id"
                    ><i class="fa fa-file-invoice"></i>收款单号</label
                >
                <input
                    type="text"
                    id="payment-id"
                    class="form-input"
                    value="{{ payment.payment_id }}"
                    disabled
                />
            </div>

            <!-- 收款金额 -->
            <div class="form-row">
                <label class="form-label" for="amount"
                    ><i class="fa fa-yen-sign"></i>收款金额</label
                >
                <input
                    type="number"
                    id="amount"
                    class="form-input"
                    placeholder="请输入收款金额"
                    value="{{ payment.payment_amount }}"
                    min="0"
                    step="0.01"
                    required
                />
                <div class="error-message" id="amount-error">请输入有效的收款金额（≥0）</div>
            </div>

            <!-- 核销金额 -->
            <div class="form-row">
                <label class="form-label" for="write-off-amount"
                    ><i class="fa fa-check-circle"></i>核销金额</label
                >
                <input
                    type="number"
                    id="write-off-amount"
                    class="form-input"
                    placeholder="请输入核销金额"
                    value="{{ payment.write_off_amount or 0 }}"
                    min="0"
                    step="0.01"
                />
                <div class="error-message" id="writeoff-error">请输入有效的核销金额（≥0）</div>
            </div>

            <!-- 收款日期 -->
            <div class="form-row">
                <label class="form-label" for="date"
                    ><i class="fa fa-calendar-alt"></i>收款日期</label
                >
                <input
                    type="date"
                    id="date"
                    class="form-input"
                    value="{{ payment.payment_date.strftime('%Y-%m-%d') }}"
                    required
                />
                <div class="error-message" id="date-error">请选择收款日期</div>
            </div>

            <!-- 付款方式 -->
            <div class="form-row">
                <label class="form-label" for="method"
                    ><i class="fa fa-credit-card"></i>付款方式</label
                >
                <select id="method" class="form-input" required>
                    <option value="">请选择付款方式</option>
                    <option value="bank" {% if payment.payment_method == 'bank' %}selected{% endif %}>银行转账</option>
                    <option value="alipay" {% if payment.payment_method == 'alipay' %}selected{% endif %}>支付宝</option>
                    <option value="wechat" {% if payment.payment_method == 'wechat' %}selected{% endif %}>微信支付</option>
                    <option value="cash" {% if payment.payment_method == 'cash' %}selected{% endif %}>现金</option>
                    <option value="check" {% if payment.payment_method == 'check' %}selected{% endif %}>支票</option>
                    <option value="other" {% if payment.payment_method == 'other' %}selected{% endif %}>其他</option>
                </select>
                <div class="error-message" id="method-error">请选择付款方式</div>
            </div>

            <!-- 状态 -->
            <div class="form-row">
                <label class="form-label" for="status"
                    ><i class="fa fa-info-circle"></i>状态</label
                >
                <select id="status" class="form-input" required>
                    <option value="已确认" {% if payment.status == '已确认' %}selected{% endif %}>已确认</option>
                    <option value="待确认" {% if payment.status == '待确认' %}selected{% endif %}>待确认</option>
                    <option value="作废" {% if payment.status == '作废' %}selected{% endif %}>作废</option>
                </select>
            </div>

            <!-- 备注 -->
            <div class="form-row">
                <label class="form-label" for="note"
                    ><i class="fa fa-sticky-note"></i>备注</label
                >
                <textarea
                    id="note"
                    class="form-input"
                    placeholder="请输入备注信息（可选）"
                    maxlength="500"
                >{{ payment.remarks }}</textarea>
            </div>
        </form>

        <!-- 保存按钮 -->
        <div class="save-container">
            <button class="save-btn" onclick="saveChanges()">
                <i class="fa fa-floppy-disk"></i>保存修改
            </button>
        </div>
    </div>

    <script>
        const paymentId = "{{ payment.payment_id }}";

        // 表单验证简单示范
        function validateForm() {
            let valid = true;

            // 收款金额校验
            const amountInput = document.getElementById('amount');
            const amountError = document.getElementById('amount-error');
            if (!amountInput.value || isNaN(amountInput.value) || Number(amountInput.value) < 0) {
                amountInput.classList.add('invalid');
                amountError.style.display = 'block';
                valid = false;
            } else {
                amountInput.classList.remove('invalid');
                amountError.style.display = 'none';
            }

            // 核销金额校验
            const writeOffInput = document.getElementById('write-off-amount');
            const writeOffError = document.getElementById('writeoff-error');
            if (writeOffInput.value && (isNaN(writeOffInput.value) || Number(writeOffInput.value) < 0)) {
                writeOffInput.classList.add('invalid');
                writeOffError.style.display = 'block';
                valid = false;
            } else {
                writeOffInput.classList.remove('invalid');
                writeOffError.style.display = 'none';
            }

            // 收款日期校验
            const dateInput = document.getElementById('date');
            const dateError = document.getElementById('date-error');
            if (!dateInput.value) {
                dateInput.classList.add('invalid');
                dateError.style.display = 'block';
                valid = false;
            } else {
                dateInput.classList.remove('invalid');
                dateError.style.display = 'none';
            }

            // 付款方式校验
            const methodSelect = document.getElementById('method');
            const methodError = document.getElementById('method-error');
            if (!methodSelect.value) {
                methodSelect.classList.add('invalid');
                methodError.style.display = 'block';
                valid = false;
            } else {
                methodSelect.classList.remove('invalid');
                methodError.style.display = 'none';
            }

            return valid;
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.classList.add('success-alert');
            div.innerHTML = `<i class="fa fa-check-circle"></i> ${message}`;
            document.body.appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                setTimeout(() => div.remove(), 500);
            }, 2500);
        }

        async function saveChanges() {
            if (!validateForm()) {
                return;
            }

            const payment_amount = document.getElementById('amount').value.trim();
            const write_off_amount = document.getElementById('write-off-amount').value.trim() || "0";
            const payment_date = document.getElementById('date').value;
            const payment_method = document.getElementById('method').value;
            const status = document.getElementById('status').value;
            const remarks = document.getElementById('note').value.trim();

            try {
                const response = await fetch(`/finance/update-payment/${paymentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        payment_amount,
                        write_off_amount,
                        payment_date,
                        payment_method,
                        status,
                        remarks
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.message || '保存成功');
                    setTimeout(() => {
                        window.location.href = '/finance/';
                    }, 2000);
                } else {
                    alert(data.message || '保存失败，请稍后重试');
                }
            } catch (err) {
                alert('请求失败，请检查网络后重试');
                console.error(err);
            }
        }
    </script>
</body>
</html>
