<!DOCTYPE html>
<!-- 
æ–‡ä»¶ï¼šcreate_quotation.html
åŠŸèƒ½ï¼šåˆ›å»ºæŠ¥ä»·å•ï¼Œæ”¯æŒä»è¯¢ä»·å•å¤åˆ¶æ˜ç»†ä¿¡æ¯
ç‰¹è‰²åŠŸèƒ½ï¼šè¯¢ä»·å•ä¿¡æ¯å¤åˆ¶ã€åŠ¨æ€æ˜ç»†ç®¡ç†ã€çŠ¶æ€æ§åˆ¶
æŠ€æœ¯ä¾èµ–ï¼šBootstrap 5.3.0, Fetch API, åŸç”ŸJavaScript
-->
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åˆ›å»ºæŠ¥ä»·å•</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!--
  <style>
    /* ==========é¡µé¢ä¸»é¢˜æ ·å¼========== */
    body {
      /* èƒŒæ™¯ï¼šè®¢å•ä¸»é¢˜èƒŒæ™¯å›¾ï¼Œå›ºå®šå…¨å±è¦†ç›– */
      /* å­—ä½“ï¼šSegoe UIå­—ä½“æ ˆï¼Œç°ä»£åŒ–å¤–è§‚ */
    }
    
    /* ==========ä¸»å¡ç‰‡å®¹å™¨========== */
    .main-card {
      /* ç™½è‰²èƒŒæ™¯ï¼Œ1remåœ†è§’ */
      /* é˜´å½±æ•ˆæœï¼š0 0 15pxï¼Œå¢åŠ æ·±åº¦ */
      /* å†…è¾¹è·2remï¼Œå®½æ¾å¸ƒå±€ */
    }
    
    /* ==========æ ‡é¢˜æ ·å¼========== */
    h2 {
      /* Segoe UI Semiboldå­—ä½“ */
      /* æ–‡å­—é˜´å½±ï¼š1px 1px 2px #ccc */
    }
    
    /* ==========é«˜äº®æŒ‰é’®========== */
    .btn-highlight {
      /* è“è‰²æ¸å˜èƒŒæ™¯ï¼š#2563eb */
      /* å‘å…‰æ•ˆæœï¼š0 0 6px rgba(37,99,235,0.4) */
    }
    
    /* ==========è¡¨æ ¼è¾“å…¥æ¡†========== */
    table input {
      /* æœ€å°å®½åº¦120pxï¼Œç¡®ä¿å¯æ“ä½œæ€§ */
    }
  </style>-->
  <style>
    body {
      padding-top: 70px; /* ç»™å¯¼èˆªæ è®©å‡ºç©ºé—´ */
      background: url('/static/order_background.png') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      padding: 2rem;
    }
    h2 {
      font-family: 'Segoe UI Semibold';
      text-shadow: 1px 1px 2px #ccc;
    }
    .btn-highlight {
      background: #2563eb;
      color: white;
      font-weight: bold;
      box-shadow: 0 0 6px rgba(37,99,235,0.4);
    }
    .btn-highlight:hover {
      background: #1e40af;
    }
    table input {
      min-width: 120px;
    }
  </style>
</head>
<body>
  <nav style="position: fixed; top: 0; left: 0; right: 0; height: 56px; background: #1b5899; color: white; display: flex; align-items: center; justify-content: space-around; z-index: 9999; font-family: 'Segoe UI', sans-serif; font-size: 15px;">
  <a href="/dashboard" style="color: white; text-decoration: none;">ç³»ç»Ÿé¦–é¡µ</a>
  <a href="/order/create-inquiry" style="color: white; text-decoration: none;">ğŸ“ åˆ›å»ºè¯¢ä»·</a>
  <a href="/order/edit-inquiry" style="color: white; text-decoration: none;">âœï¸ ä¿®æ”¹è¯¢ä»·</a>
  <a href="/order/query-inquiry" style="color: white; text-decoration: none;">ğŸ” æŸ¥è¯¢è¯¢ä»·</a>
  <a href="/order/create-quote" style="color: white; text-decoration: none;">ğŸ“„ åˆ›å»ºæŠ¥ä»·</a>
  <a href="/order/edit-quote" style="color: white; text-decoration: none;">ğŸ–‹ï¸ ä¿®æ”¹æŠ¥ä»·</a>
  <a href="/order/query-quote" style="color: white; text-decoration: none;">ğŸ“Š æŸ¥è¯¢æŠ¥ä»·</a>
  <a href="/order/create-order" style="color: white; text-decoration: none;">ğŸ›’ åˆ›å»ºè®¢å•</a>
  <a href="/order/edit-order" style="color: white; text-decoration: none;">ğŸ” ä¿®æ”¹è®¢å•</a>
  <a href="/order/query-order" style="color: white; text-decoration: none;">ğŸ’¾ æŸ¥è¯¢è®¢å•</a>
</nav>
<div class="container py-5">
  <div class="main-card mx-auto" style="max-width: 1000px;">
    <h2 class="text-center mb-4">åˆ›å»ºæŠ¥ä»·å•</h2>
     <!-- ==========è¯¢ä»·å•å¤åˆ¶åŠŸèƒ½åŒº========== -->
    <div class="copy-section">
      <h6>ğŸ“‹ ä»è¯¢ä»·å•å¤åˆ¶è¡Œé¡¹ä¿¡æ¯</h6>
      <div class="row align-items-end">
        <div class="col-md-8">
          <label class="form-label">è¾“å…¥è¯¢ä»·å•å·</label>
          <div class="inquiry-input-group">
            <input type="text" class="form-control" id="copyInquiryId" placeholder="è¯·è¾“å…¥è¦å¤åˆ¶çš„è¯¢ä»·å•å·">
            <div class="loading-spinner" id="loadingSpinner"></div>
          </div>
        </div>
        <div class="col-md-4">
          <button type="button" class="btn btn-copy w-100" onclick="copyFromInquiry()">
            ğŸ”„ å¤åˆ¶è¯¢ä»·ä¿¡æ¯
          </button>
        </div>
      </div>
      <div id="copyResult" class="mt-2" style="display: none;">
        <small class="text-muted">å¤åˆ¶ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</small>
      </div>
    </div>
    <form method="POST">
<!-- ==========æŠ¥ä»·å•åŸºæœ¬ä¿¡æ¯========== -->
        <!-- ä½¿ç”¨Bootstrapæ …æ ¼ç³»ç»Ÿï¼Œ6åˆ—å¸ƒå±€ -->
     <!-- ä¸»ä¿¡æ¯ -->
<div class="row g-3">
  <div class="col-md-6">
    <label>æŠ¥ä»·å•å·</label>
    <input type="text" class="form-control" name="quotation_id" required id="quotation_id">
  </div>
  <div class="col-md-6">
    <label>å®¢æˆ·ç¼–å·</label>
    <input type="text" class="form-control" name="customer_id" id="customer_id">
  </div>
  <div class="col-md-6">
    <label>å…³è”è¯¢ä»·å•å·</label>
    <input type="text" class="form-control" name="inquiry_id" id="inquiry_id">
  </div>
  <div class="col-md-6">
    <label>æŠ¥ä»·æ—¥æœŸ</label>
    <input type="date" class="form-control" name="quotation_date" id="quotation_date">
  </div>
  <div class="col-md-6">
    <label>æœ‰æ•ˆæœŸè‡³</label>
    <input type="date" class="form-control" name="valid_until_date" id="valid_until_date">
  </div>
  <div class="col-md-6">
    <label>é”€å”®äººå‘˜ç¼–å·</label>
    <input type="text" class="form-control" name="salesperson_id" id="salesperson_id">
  </div>
  <div class="col-md-6">
    <label>æ€»é‡‘é¢</label>
    <input type="number" class="form-control" name="total_amount" id="total_amount" step="0.01">
  </div>
  <div class="col-md-6">
    <label>å¤‡æ³¨</label>
    <input type="text" class="form-control" name="remarks" id="remarks">
  </div>
</div>


      <!-- æ˜ç»†ä¿¡æ¯è¡¨æ ¼ -->
      <h5 class="mt-5 mb-3">æŠ¥ä»·æ˜ç»†</h5>
      <div class="table-responsive">
        <table class="table table-bordered align-middle text-center" id="itemTable">
          <thead class="table-light">
          <tr>
            <th>è¡Œå·</th><th>ç‰©æ–™ç¼–å·</th><th>æ•°é‡</th><th>å•ä»·</th><th>æŠ˜æ‰£%</th><th>é‡‘é¢</th><th>å•ä½</th><th>å…³è”è¯¢ä»·é¡¹</th><th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td><input name="item_no" type="number" class="form-control"></td>
            <td><input name="material_id" type="text" class="form-control"></td>
            <td><input name="quotation_quantity" type="number" class="form-control"></td>
            <td><input name="unit_price" type="number" step="0.01" class="form-control"></td>
            <td><input name="discount_rate" type="number" class="form-control"></td>
            <td><input name="item_amount" type="number" step="0.01" class="form-control"></td>
            <td><input name="unit" type="text" class="form-control"></td>
            <td><input name="inquiry_item_id" type="text" class="form-control"></td>
            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">åˆ é™¤</button></td>
          </tr>
          </tbody>
        </table>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRow()">â• æ–°å¢è¡Œ</button>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="mt-4 d-flex gap-3">
        <input type="hidden" name="status" value="è‰ç¨¿" id="statusField">
        <button type="submit" class="btn btn-highlight" onclick="document.getElementById('statusField').value='è‰ç¨¿'">ä¿å­˜è‰ç¨¿</button>
        <button type="submit" class="btn btn-success" onclick="document.getElementById('statusField').value='å·²å‘é€'">æäº¤å®¡æ ¸</button>
      </div>
    </form>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul style="color: green;">
          {% for msg in messages %}
            <li>{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
  </div>
</div>

<script>
  function addRow() {
     /*
      åŠŸèƒ½ï¼šæ·»åŠ æ–°çš„æŠ¥ä»·æ˜ç»†è¡Œ
      å®ç°ï¼šå…‹éš†ç¬¬ä¸€è¡Œä½œä¸ºæ¨¡æ¿ï¼Œæ¸…ç©ºè¾“å…¥å€¼
      */
    const table = document.getElementById('itemTable').querySelector('tbody');
    const newRow = table.rows[0].cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => input.value = '');
    table.appendChild(newRow);
  }
  function removeRow(button) {
     /*
      åŠŸèƒ½ï¼šåˆ é™¤æŒ‡å®šçš„æ˜ç»†è¡Œ
      é™åˆ¶ï¼šè‡³å°‘ä¿ç•™ä¸€è¡Œï¼Œé˜²æ­¢è¡¨æ ¼ä¸ºç©º
      å‚æ•°ï¼šbutton - è§¦å‘åˆ é™¤çš„æŒ‰é’®å…ƒç´ 
      */
    const row = button.closest('tr');
    const table = row.closest('tbody');
    if (table.rows.length > 1) {
      row.remove();
    }
  }
   // æ–°å¢åŠŸèƒ½ï¼šä»è¯¢ä»·å•å¤åˆ¶ä¿¡æ¯
  async function copyFromInquiry() {
     /*
      åŠŸèƒ½ï¼šä»æŒ‡å®šè¯¢ä»·å•å¤åˆ¶ä¿¡æ¯åˆ°å½“å‰æŠ¥ä»·è¡¨å•
      æµç¨‹è¯¦è§£ï¼š
      1. è¾“å…¥éªŒè¯ï¼šæ£€æŸ¥è¯¢ä»·å•å·æ˜¯å¦ä¸ºç©º
      2. UIçŠ¶æ€ï¼šæ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œéšè—ç»“æœåŒº
      3. APIè°ƒç”¨ï¼šå‘é€GETè¯·æ±‚è·å–è¯¢ä»·è¯¦æƒ…
      4. æ•°æ®å¤„ç†ï¼š
         - å¡«å……ä¸»è¡¨ä¿¡æ¯ï¼ˆå®¢æˆ·ã€é”€å”®å‘˜ã€å¤‡æ³¨ã€æ€»é‡‘é¢ï¼‰
         - æ¸…ç©ºç°æœ‰æ˜ç»†è¡Œï¼ˆä¿ç•™ç¬¬ä¸€è¡Œä½œæ¨¡æ¿ï¼‰
         - éå†è¯¢ä»·æ˜ç»†ï¼Œåˆ›å»ºå¯¹åº”æŠ¥ä»·è¡Œ
         - æ•°æ®æ˜ å°„ï¼šè¯¢ä»·æ•°é‡â†’æŠ¥ä»·æ•°é‡ï¼Œé¢„æœŸå•ä»·â†’æŠ¥ä»·å•ä»·
      5. ç»“æœåé¦ˆï¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å’Œå¤åˆ¶è¡Œæ•°
      6. å¼‚å¸¸å¤„ç†ï¼šç½‘ç»œé”™è¯¯ã€æ•°æ®é”™è¯¯çš„ç”¨æˆ·æç¤º
      */
    const inquiryId = document.getElementById('copyInquiryId').value.trim();
    const resultDiv = document.getElementById('copyResult');
    const spinner = document.getElementById('loadingSpinner');
    
    if (!inquiryId) {
      showResult('è¯·è¾“å…¥è¯¢ä»·å•å·', 'warning');
      return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    spinner.style.display = 'block';
    resultDiv.style.display = 'none';

    try {
      const response = await fetch(`/order/api/inquiry/${inquiryId}`);
      const result = await response.json();
      
      spinner.style.display = 'none';
      
      if (!result.success) {
        showResult(result.message || 'è·å–è¯¢ä»·å•ä¿¡æ¯å¤±è´¥', 'danger');
        return;
      }

      const inquiry = result.data;
      
     
// å¡«å……ä¸»è¡¨ä¿¡æ¯
document.getElementById('customer_id').value = inquiry.customer_id || '';
document.getElementById('inquiry_id').value = inquiryId;
document.getElementById('salesperson_id').value = inquiry.salesperson_id || '';
document.getElementById('remarks').value = inquiry.remarks || '';
document.getElementById('total_amount').value = inquiry.expected_total_amount || 0;


      // æ¸…ç©ºç°æœ‰è¡Œé¡¹ç›®ï¼ˆä¿ç•™ç¬¬ä¸€è¡Œä½œä¸ºæ¨¡æ¿ï¼‰
      const tbody = document.getElementById('itemTable').querySelector('tbody');
      while (tbody.children.length > 1) {
        tbody.removeChild(tbody.lastChild);
      }

      // å¡«å……è¡Œé¡¹ç›®ä¿¡æ¯
      if (inquiry.items && inquiry.items.length > 0) {
        inquiry.items.forEach((item, index) => {
          let row;
          if (index === 0) {
            // ä½¿ç”¨ç¬¬ä¸€è¡Œ
            row = tbody.children[0];
          } else {
            // åˆ›å»ºæ–°è¡Œ
            row = tbody.children[0].cloneNode(true);
            tbody.appendChild(row);
          }

          // å¡«å……æ•°æ®
          row.querySelector('input[name="item_no"]').value = item.item_no;
          row.querySelector('input[name="material_id"]').value = item.material_id;
          row.querySelector('input[name="quotation_quantity"]').value = item.inquiry_quantity;
          row.querySelector('input[name="unit_price"]').value = item.expected_unit_price || '';
          row.querySelector('input[name="discount_rate"]').value = 0;
          row.querySelector('input[name="item_amount"]').value = '';
          row.querySelector('input[name="unit"]').value = item.unit || '';
          row.querySelector('input[name="inquiry_item_id"]').value = item.item_no;
        });

        showResult(`âœ… æˆåŠŸå¤åˆ¶ ${inquiry.items.length} ä¸ªè¡Œé¡¹ç›®`, 'success');
      } else {
        showResult('âš ï¸ è¯¥è¯¢ä»·å•æ²¡æœ‰è¡Œé¡¹ç›®ä¿¡æ¯', 'warning');
      }

    } catch (error) {
      spinner.style.display = 'none';
      showResult('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'danger');
      console.error('å¤åˆ¶è¯¢ä»·ä¿¡æ¯å¤±è´¥:', error);
    }
  }

  function showResult(message, type) {
    const resultDiv = document.getElementById('copyResult');
    resultDiv.style.display = 'block';
    resultDiv.className = `mt-2 alert alert-${type}`;
    resultDiv.innerHTML = message;
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
      resultDiv.style.display = 'none';
    }, 3000);
  }

  // å›è½¦é”®å¿«é€Ÿå¤åˆ¶
  document.getElementById('copyInquiryId').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      copyFromInquiry();
    }
  });
</script>

</body>
</html>